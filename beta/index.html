<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> 
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://script.google.com https://script.googleusercontent.com; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; media-src 'self'; object-src 'none'; base-uri 'self';">
<meta name="referrer" content="strict-origin-when-cross-origin">
  
<link rel="preload" as="image" href="../assets/blueberry.svg">
<link rel="preload" as="image" href="../assets/sunflower.svg">
<link rel="preload" as="image" href="../assets/Donguri.svg">
<link rel="preload" as="audio" href="../assets/BGM.mp3">
<link rel="preload" as="audio" href="../assets/END.mp3">
<link rel="preload" as="audio" href="../assets/HIGHEND.mp3"><!-- â˜…è¿½åŠ  -->
<link rel="preload" as="audio" href="../assets/pick.mp3">
<link rel="preload" as="audio" href="../assets/CREDIT.mp3">
<link rel="preload" as="audio" href="../assets/BGM2.mp3">
<link rel="preload" as="audio" href="../assets/SE.mp3">




<!-- ğŸŒ»ğŸŒ»ğŸŒ» è¿½åŠ ã²ã¾ã‚ã‚Š ğŸŒ»ğŸŒ»ğŸŒ» -->
<link rel="preload" as="image" href="../assets/sunflower2.png">
<link rel="preload" as="image" href="../assets/T4LMRR.png">


<title>ã‚€ã‚‹ã ã£ã—ã‚…ï¼</title>
  
<!-- ğŸŒ» ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ï¼ˆã²ã¾ã‚ã‚ŠSVGï¼‰â€»ãƒ™ãƒ¼ã‚¿ã‹ã‚‰è¦‹ã¦ä¸€å€‹ä¸Šã® assets -->
<link rel="icon" type="image/svg+xml" href="../assets/sunflower.svg">

<!-- ğŸªª OGP / Twitterã‚«ãƒ¼ãƒ‰ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆã¨ã—ã¦ã‚·ã‚§ã‚¢ã•ã‚Œã‚‹æƒ³å®šï¼‰ -->
<meta property="og:title" content="ã‚€ã‚‹ã ã£ã—ã‚…ï¼Î²ç‰ˆ">
<meta property="og:description" content="è¿«ã‚Šãã‚‹ã²ã¾ã‚ã‚Šã‚„ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ã‚’ã‚ˆã‘ã¾ãã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ãƒ³ã‚²ãƒ¼ãƒ ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ã€‚">
<meta property="og:type" content="website">

<!-- ãƒ™ãƒ¼ã‚¿ç‰ˆã®URL -->
<meta property="og:url" content="https://t4l-ovo-t4l.github.io/murudash/beta/">

<!-- OGPç”»åƒï¼ˆassets/OGP.png ã«ç½®ãå ´åˆï¼‰ -->
<meta property="og:image" content="https://t4l-ovo-t4l.github.io/murudash/assets/OGP.png">

<meta property="og:site_name" content="ã‚€ã‚‹ã ã£ã—ã‚…ï¼">
<meta name="twitter:card" content="summary_large_image">



  
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  body { font-family:'Inter',sans-serif; touch-action:manipulation; overflow:hidden; overscroll-behavior:none; background:#1a202c; }
  
  canvas {
    display: block;
    width: 100%;   /* è¦ªè¦ç´ ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ */
    height: auto;  /* ç¸¦æ¨ªæ¯”ã¯ 768x300 ã®ã¾ã¾ç¶­æŒ */
  }

  .control-button { transition: background-color .1s, transform .1s; }
  .control-button:active { transform: scale(.95); background:#2c5282; }
  .pause-button { transition: background-color .1s, transform .1s; }
  .pause-button:active { transform: scale(.95); }
  .icon-inline { display:inline-block; width:1.15em; height:1.15em; vertical-align:-0.18em; margin-left:.25em; }
  .no-select { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
  .no-highlight { -webkit-tap-highlight-color:transparent; }

    /* å…¨é¢é¸æŠä¸å¯ï¼ˆå­å­«ã”ã¨ï¼‰ï¼†iOSé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹ */
  .no-select, .no-select * {
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
  /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚„ç”»åƒã€ãƒœã‚¿ãƒ³ã€ãƒªãƒ³ã‚¯ã‚‚å€‹åˆ¥ã«ã‚±ã‚¢ */
  canvas, img, button, a {
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

@keyframes credits-scroll {
  0% {
    transform: translateY(22%); /* PCç”¨ï¼šã¡ã‚‡ã„ä¸‹ã‹ã‚‰ 25ãŒã¡ã‚‡ã†ã©ã„ã„ï¼Ÿã‚¹ãƒãƒ›ã¯15ãã‚‰ã„ã‹ã‚‚ */
  }
  100% {
    transform: translateY(-120%);
  }
}

/* ã‚¹ãƒãƒ›ç”¨ï¼ˆé–‹å§‹ä½ç½®ã‚’ä¸Šã’ã‚‹ï¼‰ */
@keyframes credits-scroll-mobile {
  0% {
    transform: translateY(12%);  /* ã‚¹ãƒãƒ›ã¯15ãã‚‰ã„ã‹ã‚‚ */
  }
  100% {
    transform: translateY(-120%);
  }
}

/* å…±é€šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆPCå‘ã‘ï¼‰ */
.credits-scroll {
  animation: credits-scroll 80s linear forwards;
}

/* ã‚¹ãƒãƒ›ã ã‘ä¸Šæ›¸ãï¼šå¿…ãš "æœ€å¾Œ" ã«ç½®ã */
@media (max-width: 640px) {
  .credits-scroll {
    animation: credits-scroll-mobile 80s linear forwards;
  }
}










.rainbow-text {
  /* ãƒ‰åŸè‰²ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ï¼ˆå½©åº¦é«˜ã‚ï¼‰ */
  background: linear-gradient(
    90deg,
    #ff0000,
    #ff7a00,
    #fff500,
    #00ff00,
    #00f5ff,
    #0040ff,
    #c300ff,
    #ff0000
  );
  background-size: 320% 320%;
  background-position: 0% 50%;
  background-repeat: no-repeat;

  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;


text-shadow:
  0 0 2px rgba(255, 255, 255, 0.20),
  0 0 6px rgba(255, 255, 255, 0.12);


  /* å¾€å¾©ã‚¢ãƒ‹ãƒ¡ã§ã‚¬ã‚¯ã£ã¨ã—ãªã„ã‚ˆã†ã« */
  animation: rainbow-slide 3s linear infinite alternate;
}

@keyframes rainbow-slide {
  from { background-position: 0% 50%; }
  to   { background-position: 100% 50%; }
}




</style>
</head>

<body class="bg-gray-800 flex flex-col items-center justify-start min-h-screen pt-3 sm:pt-4 pb-28 no-select no-highlight">

  
<!-- æ³¨è¨˜ -->
<div class="w-full text-center bg-gray-900 text-gray-300 text-[11px] py-1 shadow-md">
  â€»æœ¬ä½œå“ã¯ <a href="https://kuronekotsuki.booth.pm/items/4672957" target="_blank" rel="noopener noreferrer" class="underline hover:text-white transition">ï½¢ãƒ ãƒ«ãƒ«ï½£</a> ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ä½œå“ã§ã™ã€‚<br class="sm:hidden">
  æ¨©åˆ©è€…æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
  â€»éŸ³ãŒå‡ºã¾ã™ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ768pxãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
<div class="w-full max-w-[768px] p-3 bg-white rounded-t-lg shadow-md">
  <div class="flex items-center justify-between gap-3">
    <div class="text-left">
      
      <span id="scoreLabel" class="text-xl sm:text-2xl font-bold text-blue-600 whitespace-nowrap">
        ã‚¹ã‚³ã‚¢: <span id="score" class="inline-block min-w-[60px] text-right font-mono">0</span>
      </span>

    </div>
    <div class="flex items-center gap-3 shrink-0">
  <!-- â˜…ãƒã‚¤ã‚¹ã‚³ã‚¢ã®ä¸‹ã«BGMã‚’é…ç½® -->
  <div class="flex flex-col items-end leading-tight">
    <span id="highScore" class="text-xs text-gray-500 block">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>
    <span id="bgmStatus" class="text-[10px] text-gray-400 block text-right mt-0.5">
      BGMï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    </span>
  </div>

  <!-- ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
  <button
    id="muteButton"
    class="px-2 py-2 bg-gray-700 text-white rounded-lg text-xs sm:text-sm shadow-md"
  >
    ğŸ”Š
  </button>

  <button id="pauseButton" class="pause-button px-3 py-2 sm:px-4 sm:py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">
    ã¡ã‚‡ã£ã¡ä¼‘æ†©
  </button>
  </div>
 </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="relative w-full max-w-[768px] mt-2">
  <canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>

  <div
    id="highScoreBanner"
    class="pointer-events-none absolute top-4 left-1/2 -translate-x-1/2
           px-4 py-2 text-xl sm:text-2xl font-extrabold tracking-wide
           hidden rainbow-text whitespace-nowrap"
  >
    ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ä¸­ã‚€ã‚‹ï½ï¼
  </div>


  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="rankingOverlay"
     class="absolute inset-0 bg-black bg-opacity-80 rounded-lg text-white hidden z-50">
  <div class="w-full h-full flex flex-col items-center justify-center px-4">
    <div class="w-full max-w-[600px] max-h-[80%] bg-gray-900/80 rounded-lg p-4 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-3 text-center">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
      <div id="rankingContent" class="text-sm sm:text-base space-y-1">
        <!-- JSã§ä¸­èº«ã‚’åŸ‹ã‚ã‚‹ -->
      </div>
      <div class="mt-4 text-center">
        <button id="closeRankingButton"
                class="px-6 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg text-sm">
          ã¨ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

  <!-- â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆç¢ºèªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="resetConfirmOverlay"
       class="absolute inset-0 bg-black bg-opacity-70 rounded-b-lg text-white hidden z-50">
    <div class="w-full h-full flex flex-col items-center justify-center px-4">
      <div class="w-full max-w-[480px] bg-gray-900 rounded-lg p-5 shadow-lg">
        <h2 class="text-xl font-bold mb-3 text-center">ãƒã‚¤ã‚¹ã‚³ã‚¢ã®ãƒªã‚»ãƒƒãƒˆ</h2>
        <p class="text-sm sm:text-base mb-4 text-center">
          ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ<br>
          ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
        </p>
        <div class="flex flex-col sm:flex-row gap-3 mt-2">
          <button
            id="confirmResetButton"
            class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-bold"
          >
            æ¶ˆå»ã™ã‚‹
          </button>
          <button
            id="cancelResetButton"
            class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm font-bold"
          >
            ã—ãªã„ã‚€ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- ğŸ‚ ã©ã‚“ãã‚Šå•†åº— ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="shopOverlay"
     class="absolute inset-0 bg-black bg-opacity-85 rounded-lg text-white hidden z-50">
  <div class="w-full h-full flex flex-col items-center justify-center px-4">
    <div class="w-full max-w-[600px] max-h-[85%] bg-gray-900/80 rounded-lg p-4 overflow-y-auto">
      <h2 class="text-2xl font-bold mb-2 text-center">
  <img src="../assets/Donguri.svg" alt="" class="inline-block w-6 h-6 mr-2 align-[-0.2em]">
  ã©ã‚“ãã‚Šå•†åº—
  <img src="../assets/Donguri.svg" alt="" class="inline-block w-6 h-6 ml-2 align-[-0.2em]">
</h2>

<p class="text-center text-sm text-gray-300 mb-4">
  æ‰€æŒã©ã‚“ãã‚Šï¼š
  <span id="shopAcornTotal" class="font-mono text-lg text-amber-300 font-extrabold">0</span>
</p>


      <div id="shopContent" class="space-y-2 text-sm sm:text-base">
        <!-- JSã§åŸ‹ã‚ã‚‹ -->
      </div>

      <div class="mt-5 text-center">
        <button id="closeShopButton"
                class="px-6 py-2 bg-gray-700 hover:bg-gray-800 rounded-lg text-sm">
          ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã©ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>





  

  
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
<div
  id="startScreen"
  class="absolute inset-0 bg-black bg-opacity-70 rounded-b-lg text-white text-center
         flex flex-col items-center
         px-4 pt-6 pb-6
         justify-center
         overflow-y-auto
         sm:px-6 sm:pt-8 sm:pb-8"
>
<h2 class="text-3xl sm:text-5xl font-bold mb-4">ã‚€ã‚‹ã ã£ã—ã‚…ï¼</h2>

<p class="text-xs sm:text-lg mb-2">
  ãƒœã‚¿ãƒ³ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼<br class="sm:hidden">ç©ºä¸­ã§ã‚‚ã†ä¸€å›ã§2æ®µã‚¸ãƒ£ãƒ³ãƒ—ï¼
</p>

<p class="text-xs sm:text-lg mb-4">
  éšœå®³ç‰©ã‚’ã‚ˆã‘ã¾ãã‚ã†ï¼
</p>

  <!-- ğŸ‚ ã©ã‚“ãã‚Šå•†åº—ï¼ˆä¸Šæ®µï¼‰ -->
<div class="mt-3 flex justify-center">
  <button id="shopButton"
    class="px-6 py-2 border border-amber-300 text-sm rounded-lg bg-amber-700/70 hover:bg-amber-700 transition-colors">
    ã©ã‚“ãã‚Šå•†åº—
  </button>
</div>


    <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ ï¼‹ ãƒªã‚»ãƒƒãƒˆï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
    <div class="mt-3 flex flex-row flex-wrap gap-3 justify-center">

  <button id="creditsButton" class="px-5 py-2 border border-gray-300 text-sm rounded-lg bg-black/40 hover:bg-black/60 transition-colors">
    ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
  </button>
  <button id="resetButton" class="px-5 py-2 border border-red-400 text-sm rounded-lg bg-red-600/80 hover:bg-red-700 transition-colors">
    ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
  </button>
 </div> <!-- â† ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼‹ãƒªã‚»ãƒƒãƒˆã®è¡Œã®é–‰ã˜ -->

</div> <!-- #startScreen ã‚’é–‰ã˜ã‚‹ -->

  <!-- ãƒãƒ¼ã‚º -->
  <div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center hidden">
    <h2 class="text-4xl font-bold mb-4">ä¸€æ™‚åœæ­¢ä¸­</h2>
    <p class="text-xl">(ã€Œã¡ã‚‡ã£ã¡ä¼‘æ†©ã€ãƒœã‚¿ãƒ³ã§å†é–‹)</p>
  </div>

<!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ -->
<div
  id="gameOverScreen"
  class="absolute inset-0 bg-black bg-opacity-50 rounded-lg text-white hidden z-40"
>
  <div class="w-full h-full flex flex-col items-center px-4 gap-8
              justify-start pt-10 sm:justify-center sm:pt-0">


    <!-- ä¸Šå´ï¼šã‚¿ã‚¤ãƒˆãƒ« ï¼‹ ã‚¹ã‚³ã‚¢ï¼ˆä¸­å¤®å›ºå®šï¼‰ -->
    <div class="text-center">
      <h2 class="text-4xl font-bold mb-2">ãŒã‚ãŠã¹ã‚‰</h2>

      <p
        id="gameOverHighScoreLabel"
        class="text-lg mb-1 text-yellow-300 font-bold hidden"
      >
        ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ã‚€ã‚‹ï½ï¼
      </p>

      <p class="text-xl">
        ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span>
      </p>
    </div>

    <!-- ä¸‹å´ï¼šãƒœã‚¿ãƒ³ç¾¤ï¼ˆã‚¹ãƒãƒ›ã§ã‚‚æ½°ã‚Œãªã„ï¼‰ -->
    <div class="w-full max-w-[480px] space-y-4">

      <a
        id="shareButton"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
        class="block w-full px-6 py-3 bg-black text-white font-bold rounded-lg shadow-lg text-lg text-center hover:bg-gray-900 transition-colors"
      >
        Xã§ã‚¹ã‚³ã‚¢ã‚’ã‚·ã‚§ã‚¢
      </a>

      <button
        id="sendScoreButton"
        class="block w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-lg hover:bg-blue-700 transition-colors"
      >
        ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«é€ä¿¡
      </button>

      <button
        id="viewRankingButton"
        class="block w-full px-6 py-3 bg-gray-700 text-white font-bold rounded-lg shadow-lg text-lg hover:bg-gray-800 transition-colors"
      >
        ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹
      </button>

      <button
        id="backToTitleButton"
        class="block w-full px-6 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-lg text-lg hover:bg-gray-700 transition-colors"
      >
        ã‚¿ã‚¤ãƒˆãƒ«ã¸ã‚‚ã©ã‚‹
      </button>


      <!-- é€ä¿¡ä¸­ãƒ»å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <p
        id="sendStatusMessage"
        class="text-center text-sm text-gray-200"
      ></p>

    </div>

  </div>
</div>







  
<!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ï¼ã‚²ãƒ¼ãƒ ç”»é¢ãƒ•ãƒ«ï¼‰ -->
<div id="creditsOverlay"
     class="absolute inset-0 bg-black bg-opacity-90 rounded-b-lg text-white hidden z-50">

  <div class="relative w-full h-full overflow-hidden">

    <!-- å¤–å´ï¼šä½ç½®ã ã‘æ‹…å½“ï¼ˆXæ–¹å‘ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼‰ -->
    <div
      id="creditsScrollOuter"
      class="absolute left-1/2 -translate-x-1/2 w-full max-w-[720px] text-white"
    >

      <!-- å†…å´ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ‹…å½“ï¼ˆYæ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
      <!-- â˜… relative ã‚’ä»˜ã‘ã¦ã€ã“ã“ã«é£¾ã‚Šã‚¤ãƒ©ã‚¹ãƒˆã‚‚å…¥ã‚Œã‚‹ -->
      <div id="creditsScroll" class="credits-scroll relative">

        <!-- ğŸ¨ é£¾ã‚Šã‚¤ãƒ©ã‚¹ãƒˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¨ä¸€ç·’ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
        <!-- â‘  ä¸Šã®ã»ã†ï¼ˆå…¨ä½“ã® 5ï¼…ã‚ãŸã‚Šï¼‰å³ã«è‡ªæ©Ÿ -->
<img
  src="../assets/Muru.png"
  alt="Muru"
  class="absolute right-1 sm:right-2 top-[5%] w-16 sm:w-24 pointer-events-none select-none"
/>

<!-- â‘¡ ã¡ã‚‡ã„ä¸‹ï¼ˆ30ï¼…ã‚ãŸã‚Šï¼‰å·¦ã«ã²ã¾ã‚ã‚Š -->
<img
  src="../assets/sunflower.svg"
  alt="sunflower"
  class="absolute left-1 sm:left-2 top-[30%] w-12 sm:w-16 h-auto pointer-events-none select-none"
/>

<!-- â‘¢ çœŸã‚“ä¸­ã‚ˆã‚Šã¡ã‚‡ã„ä¸‹ï¼ˆ55ï¼…ã‚ãŸã‚Šï¼‰å³ã«ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ -->
<img
  src="../assets/blueberry.svg"
  alt="blueberry"
  class="absolute right-2 sm:right-6 top-[55%] w-10 sm:w-14 h-auto pointer-events-none select-none"
/>

<!-- â‘£ çµ‚ç›¤ï¼ˆ80ï¼…ã‚ãŸã‚Šï¼‰å·¦ã«ã©ã‚“ãã‚Š -->
<img
  src="../assets/Donguri.svg"
  alt="donguri"
  class="absolute left-2 sm:left-8 top-[80%] w-10 sm:w-14 h-auto pointer-events-none select-none"
/>



        <!-- â˜… ã“ã“ã‹ã‚‰ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæœ¬æ–‡ï¼ˆä¸­èº«ã¯ä»Šã®ã¾ã¾ã‚³ãƒ”ãƒšã§OKï¼‰ -->
        <div class="text-center text-white">

          <p class="mt-4 text-xl font-bold">
            ã‚€ã‚‹ã ã£ã—ã‚…ï¼ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
          </p>

          <div class="mt-8">
            <p class="text-xs text-gray-400">åŸä½œãƒ»ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åŸæ¡ˆ</p>
            <p class="mt-1 text-base">ãã‚ã‚€ï¼ˆLethal Catsï¼‰</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ä¼ç”»ãƒ»åˆ¶ä½œ</p>
            <p class="mt-1 text-base">ãŸã‚‹</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ãƒ‡ã‚£ãƒ¬ã‚¯ã‚¿ãƒ¼</p>
            <p class="mt-1 text-base">ãŸã‚‹</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³</p>
            <p class="mt-1 text-base">ãŸã‚‹</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ãƒ—ãƒ­ã‚°ãƒ©ãƒ </p>
            <p class="mt-1 text-base">ãŸã‚‹ with ChatGPT</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯</p>
            <p class="mt-1 text-base leading-relaxed">
              ãŸã‚‹<br>
              ã‚†ãšã†ã«<br>
              ã‚¤ãƒ©ã‚¹ãƒˆAC<br>
              Twemojiï¼ˆCC BY 4.0ï¼‰
            </p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ã‚µã‚¦ãƒ³ãƒ‰</p>
            <p class="mt-1 text-base leading-relaxed">
              ãŸã‚‹ made with Suno<br>
              Audiostock
            </p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤</p>
            <p class="mt-1 text-base leading-relaxed">
              ã‚†ãšã†ã«<br>
              ç«œèƒ†<br>
              ã‚‚ã¡<br>
              ã—ã‚‰ã–ã‚<br>
            </p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ &amp; ãƒªã‚¹ãƒšã‚¯ãƒˆ</p>
            <p class="mt-1 text-base">Google - Dinosaur Game</p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹</p>
            <p class="mt-1 text-base leading-relaxed">
              ã“ã®ä¸–ã®å…¨ãƒ ãƒ«ãƒ«ãŸã¡<br>
              ä»Šã“ã‚Œã‚’èª­ã‚“ã§ãã‚Œã¦ã„ã‚‹ã‚ãªãŸ
            </p>
          </div>

          <div class="mt-10">
            <p class="text-xs text-gray-400">ä½¿ç”¨ãƒ„ãƒ¼ãƒ«</p>
            <p class="mt-1 text-base leading-relaxed">
              HTML5 / JavaScriptï¼ˆVanillaï¼‰<br>
              Tailwind CSS<br>
              GitHub Pages<br>
              Google Apps Script<br>
              Google Spreadsheet<br>
              ChatGPT 5.1<br>
              Gemini 3 Pro<br>
              Suno v5
            </p>
          </div>

          
          <p class="mt-16 text-sm font-medium tracking-wide">
            2025 Presented by T4L
          </p>

          <p class="mt-4 text-xs text-gray-300 leading-relaxed">
            â€»æœ¬ä½œå“ã¯ã€Œãƒ ãƒ«ãƒ«ã€ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ä½œå“ã§ã™ã€‚<br>
            ã€€æ¨©åˆ©è€…æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚
          </p>

          <!-- â–¼ ãƒ©ã‚¹ãƒˆã«æµã‚Œã‚‹ã²ã¾ã‚ã‚Šï¼ˆsunflower2.pngï¼‰ -->
          <div class="mt-60 mb-8 flex justify-center">
            <img
              src="../assets/T4LMRR.png"
              alt="T4LMRR"
              class="w-20 sm:w-28 h-auto mx-auto"
            />
          </div>




          
        </div><!-- /.text-center -->
      </div><!-- /#creditsScroll -->
    </div><!-- /#creditsScrollOuter -->

    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çµ‚äº†å¾Œã«å‡ºã™ã€ŒThank Youã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div
      id="creditsEndMessage"
      class="hidden absolute inset-0 flex items-center justify-center"
    >
      <div class="text-center px-4">
        <p class="text-2xl sm:text-3xl font-bold mb-3">
          Thank You for Playing!!
        </p>
        <p class="text-xs sm:text-sm text-gray-300">
          ã€Œã¨ã˜ã‚‹ã€ãƒœã‚¿ãƒ³ã§ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚‹ã‚€ã‚‹
        </p>
      </div>
    </div>

  </div><!-- /.relative -->
</div><!-- /#creditsOverlay -->





</div><!-- â˜… ã“ã‚Œï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã® outer relative ã‚’é–‰ã˜ã‚‹ -->


  

<!-- ãƒ«ãƒ¼ãƒ«ï¼ˆä¸­å¤®æƒãˆï¼‰ -->
<div class="w-full max-w-[768px] text-gray-200 text-sm mt-3 mb-20 px-1 leading-relaxed text-center no-select no-highlight">
  <p class="mb-1">
    ã²ã¾ã‚ã‚Š<img src="../assets/sunflower.svg" alt="sunflower" class="icon-inline">
    ã‚„ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼<img src="../assets/blueberry.svg" alt="blueberry" class="icon-inline">
    ã‚’<br class="sm:hidden"/>é¿ã‘ãªãŒã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ãã†ï¼
  </p>
  <p>
    ãŸã¾ã«è½ã¡ã¦ã‚‹ã©ã‚“ãã‚Š<img src="../assets/Donguri.svg" alt="donguri" class="icon-inline">
    ã¯æ‹¾ã„ãŸã„ã‚€ã‚‹ã­
  </p>

    <!-- â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå³ä¸‹ã«ã¡ã‚‡ã“ã£ã¨ï¼‰ -->
  <p class="mt-2 text-[10px] text-gray-400 text-right pr-2 sm:text-xs">
    version <span id="versionLabel"></span>
  </p>


</div>

<!-- ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
<div class="w-full max-w-[768px] flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2 no-select no-highlight">
<button id="jumpButton" class="control-button w-full py-12 text-white font-bold rounded-lg shadow-lg text-2xl no-select" draggable="false">
  ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
</button>

</div>



<!-- ãƒ­ãƒ¼ãƒ‰ä¸­ã‚€ã‚‹ -->
<div id="loadingOverlay"
     class="fixed inset-0 bg-black/80 text-white hidden z-[60]">
  <div class="w-full h-full flex items-center justify-center">
    <div class="text-center">
      <p class="text-2xl font-bold mb-2">ãƒ­ãƒ¼ãƒ‰ä¸­ã‚€ã‚‹</p>
      <p class="text-xs text-gray-300">BGMã‚’æº–å‚™ã—ã¦ã‚‹ã‚€ã‚‹</p>
    </div>
  </div>
</div>



  
<script>

const SCORE_API_URL = 'https://script.google.com/macros/s/AKfycby2GHfn2Lq9iRqH45iOH8t1f9rM8e7Wm5AeUO92g8g35u7F7muzXokQoagjKaQrpg9ALw/exec';

// â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ä¸€ç”Ÿä¿æŒï¼‰
const USER_ID_KEY = 'muruUserId';

function generateUserId() {
  const t = Date.now().toString(36);               // æ™‚é–“ãƒ™ãƒ¼ã‚¹
  const r = Math.random().toString(36).slice(2,10); // ãƒ©ãƒ³ãƒ€ãƒ 
  return `muru_${t}_${r}`;
}

function getOrCreateUserId() {
  let id = localStorage.getItem(USER_ID_KEY);
  if (!id) {
    id = generateUserId();
    localStorage.setItem(USER_ID_KEY, id);
  }
  return id;
}

// ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å°‚ç”¨ã®ID
const USER_ID = getOrCreateUserId();



  
async function sendScoreToServer(currentScore){
  try {
    // â˜…å‰å›ã®åå‰ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹ï¼ˆãªã‘ã‚Œã°ç©ºæ¬„ï¼‰
    const prevName = localStorage.getItem('muruPlayerName') || '';

    // â˜…å¿…ãšä½•ã‹ã—ã‚‰å…¥åŠ›ã•ã›ã‚‹ãƒ«ãƒ¼ãƒ—
    let name = '';
    while (true) {
      const input = prompt(
        'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¼‰ã›ã‚‹åå‰ã‚’å…¥ã‚Œã¦ã­ï¼ˆå¿…é ˆï¼‰',
        prevName
      );

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰é€ä¿¡è‡ªä½“ã‚„ã‚ã‚‹
      if (input === null) {
        return;
      }

      name = input.trim();
      name = name.replace(/[\r\n\t]/g, ' ');  // â˜…è¿½åŠ ï¼šæ”¹è¡Œãƒ»ã‚¿ãƒ–æ½°ã—

      // ä½•ã‹å…¥ã£ã¦ãŸã‚‰OK
      if (name) break;

      alert('åå‰ã¯å¿…é ˆã‚€ã‚Šã‚…ï¼›ï¼›');
    }

    // ï¼ˆãŠå¥½ã¿ï¼‰é•·ã™ãã‚‹ã¨ã‚¢ãƒ¬ãªã‚“ã§ã¡ã‚‡ã„åˆ¶é™ã‹ã‘ã¦ã‚‚ã„ã„
    if (name.length > 16) {
      name = name.slice(0, 16);
      alert('åå‰é•·ã™ãã‚£ï¼å…ˆé ­16æ–‡å­—ã ã‘ä½¿ã†ã‚€ã‚‹ï¼');
    }

    localStorage.setItem('muruPlayerName', name);

    // â˜…é€ä¿¡ä¸­ã®è¦‹ãŸç›®
    if (sendScoreButton){
      sendScoreButton.disabled = true;
      sendScoreButton.textContent = 'é€ä¿¡ä¸­ã‚€ã‚‹â€¦';
      sendScoreButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
      sendScoreButton.classList.add('bg-blue-900', 'cursor-wait');
    }

    const params = new URLSearchParams({
      mode: 'post',
      name: name,
      score: String(currentScore),
      version: GAME_VERSION,
      ua: navigator.userAgent,
      userId: USER_ID
    });

    const res = await fetch(`${SCORE_API_URL}?${params.toString()}`, {
      method: 'GET',
    });

    const data = await res.json();
    if (!data || data.status !== 'ok') {
      throw new Error(data && data.message ? data.message : 'API status!=ok');
    }

    alert('ã‚¹ã‚³ã‚¢é€ä¿¡ã—ãŸã‚€ã‚‹ï¼');

    // â˜… é€ä¿¡å®Œäº† â†’ ãƒœã‚¿ãƒ³ã‚’é€æ˜åŒ–ï¼†ç„¡åŠ¹åŒ–
    sendScoreButton.textContent = "ã‚¹ã‚³ã‚¢é€ä¿¡æ¸ˆã¿";
    sendScoreButton.disabled = true;

    sendScoreButton.classList.remove(
      "bg-blue-600",
      "hover:bg-blue-700",
      "cursor-pointer"
    );

    sendScoreButton.classList.add(
      "bg-gray-500",
      "opacity-60",
      "cursor-not-allowed"
    );

  } catch (err) {
    console.error(err);
    alert('é€ä¿¡ã«å¤±æ•—ã—ãŸã‚€ã‚Šã‚…â€¦æ™‚é–“ã‚’ç½®ã„ã¦è©¦ã—ã¦ã¿ã¦ã»ã—ã„ã‚€ã‚‹ï¼');

    // â˜…å¤±æ•—ã—ãŸã‚‰ãƒœã‚¿ãƒ³å¾©æ´»ã•ã›ã‚‹
    if (sendScoreButton){
      sendScoreButton.disabled = false;
      sendScoreButton.textContent = 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«é€ä¿¡';
      sendScoreButton.classList.remove(
        'bg-blue-900',
        'cursor-wait',
        'bg-gray-500',
        'cursor-not-allowed'
      );
      sendScoreButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }
  }
}


// â˜… ãƒ—ãƒ¬ã‚¤ãƒ­ã‚°é€ä¿¡ç”¨ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«1ç™ºã ã‘å©ãï¼‰
function logPlaySession(isNewHighScore) {
  try {
    // â˜… ã“ã“ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰åå‰ã‚’æ‹¾ã†
    const savedName = localStorage.getItem('muruPlayerName') || '';

    // â˜… ç·ã©ã‚“ãã‚Šæ•°ï¼ˆãªã‘ã‚Œã° 0 æ‰±ã„ï¼‰
    const acornTotalStr = String(totalAcorns || 0);
    
    const params = new URLSearchParams({
      mode: 'logPlay',                // GASå´ã§åˆ†å²ã«ä½¿ã†
      version: GAME_VERSION,          // 2.0 ã¿ãŸã„ãªã‚„ã¤
      score: String(score),           // ä»Šå›ã®ã‚¹ã‚³ã‚¢
      isHighScore: isNewHighScore ? '1' : '0', // ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ã—ãŸã‹
      ua: navigator.userAgent || '',  // ç«¯æœ«æƒ…å ±
      userId: USER_ID,                // â˜… è¿½åŠ ï¼šèª°ã®ãƒ—ãƒ¬ã‚¤ã‹
      deathType: lastDeathType || 'none', // ä½•ã«å½“ãŸã£ã¦æ­»ã‚“ã ã‹

      // â˜… è¿½åŠ ï¼šãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç´¯è¨ˆã©ã‚“ãã‚Šæ•°
      acornTotal: acornTotalStr
    });

    // â˜… åå‰ãŒã‚ã‚‹ã¨ãã ã‘ name ã‚’ä»˜ã‘ã¦é€ã‚‹
    if (savedName) {
      params.append('name', savedName);
    }

    fetch(`${SCORE_API_URL}?${params.toString()}`, {
      method: 'GET',
      keepalive: true, // ã‚¿ãƒ–é–‰ã˜éš›ã§ã‚‚é€ä¿¡ã•ã‚Œã‚„ã™ãã™ã‚‹ãŠã¾ã˜ãªã„
    }).catch(() => {
      // å¤±æ•—ã—ã¦ã‚‚ã‚²ãƒ¼ãƒ ã«ã¯ä¸€åˆ‡é–¢ä¿‚ãªã„ã®ã§æ¡ã‚Šã¤ã¶ã—
    });
  } catch (e) {
    console.error('logPlaySession error:', e);
  }
}






  
// ç”»åƒãƒ­ãƒ¼ãƒ€
function loadImg(src){ const img = new Image(); img.src = src; return img; }
const SPRITES = {
  blueberry: loadImg('../assets/blueberry.svg'),
  sunflower: loadImg('../assets/sunflower.svg'),
  donguri:   loadImg('../assets/Donguri.svg'),
  sunflower2: loadImg('../assets/sunflower2.png')
};

  
  // iOSã®é•·æŠ¼ã—é¸æŠãƒ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ‘æ­¢ï¼ˆãƒœã‚¿ãƒ³æ“ä½œã¯ãã®ã¾ã¾ï¼‰
document.addEventListener('selectstart', e => e.preventDefault());
document.addEventListener('contextmenu', e => e.preventDefault(), { passive: false });


// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã“ã“ã ã‘å¤‰ãˆãŸã‚‰OKï¼‰â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
const GAME_VERSION = '2.0';
const HIGH_SCORE_KEY = 'muruHighScoreBETA';
  
// â˜…â˜…â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ãƒã‚¹ã‚¿ãƒ¼ã‚¹ã‚¤ãƒƒãƒï¼ˆã“ã“ã ã‘ã„ã˜ã‚Œã°OKï¼‰ â˜…â˜…â˜…â˜…â˜…
// æœ¬ç•ªã§ã¯å…¨éƒ¨ false ã«ã™ã‚‹ or å¿…è¦ãªã‚‚ã®ã ã‘ true ã«ã™ã‚‹
const DEBUG_OPTIONS = {
  invincibleMode: true,  // ç„¡æ•µãƒ¢ãƒ¼ãƒ‰ï¼ˆ20å›ã‚¿ãƒƒãƒ—ã§ONï¼‰
  warpPC: true,          // ãƒãƒ¼ã‚ºä¸­ã®ã€Œ3 / 5ã€ã‚­ãƒ¼ã§ã‚¹ã‚³ã‚¢ãƒ¯ãƒ¼ãƒ—
  warpMobile: true,       // ãƒãƒ¼ã‚ºä¸­ã®ã‚¹ã‚³ã‚¢ / ãƒã‚¤ã‚¹ã‚³ã‚¢é€£æ‰“ãƒ¯ãƒ¼ãƒ—
  acornCheat: true,   // â˜…è¿½åŠ ï¼šã©ã‚“ãã‚Š+50è£æŠ€
};


// â˜… ã©ã‚“ãã‚Šç´¯è¨ˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ãŸã„ã§ä½¿ã†ï¼‰
const ACORN_TOTAL_KEY = 'muruAcornTotal';
let totalAcorns = parseInt(localStorage.getItem(ACORN_TOTAL_KEY) || '0', 10);

// ãƒ‡ãƒãƒƒã‚°ç¢ºèªã—ãŸã‹ã£ãŸã‚‰
console.log('ç´¯è¨ˆã©ã‚“ãã‚Šæ•°:', totalAcorns);



  
// ===== ã©ã‚“ãã‚Šå•†åº—ï¼ˆè§£æ”¾ãƒ»BGMé¸æŠï¼‰ =====
// â˜…é¸æŠã¯ã€Œã“ã®ãƒšãƒ¼ã‚¸é–‹ã„ã¦ã‚‹é–“ã ã‘ã€ï¼šãƒªãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰å¿…ãšãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
let selectedBgmId = 'default';

const BGM_META = {
  default: { label: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', unlockedAt: 0 },
  sougen:  { label: 'è‰åŸã‚’é§†ã‘ã‚‹ã‚€ã‚‹ã‚‹', unlockedAt: 100, file: '../assets/BGM_SOUGEN.mp3', volume: 0.6 },
  yoru:    { label: 'å¤œã®è¡—ã‚’é§†ã‘ã‚‹ã‚€ã‚‹ã‚‹', unlockedAt: 200, file: '../assets/BGM_YORU.mp3',   volume: 0.5 }
};



function getSelectedBgmId(){
  return selectedBgmId;
}

function setSelectedBgmId(id){
  selectedBgmId = id || 'default';
  updateBgmStatusLabel();
  renderShop();

  // â˜…è¿½åŠ ï¼šåœ°é¢ãƒ†ãƒ¼ãƒã‚‚BGMã«åˆã‚ã›ã¦æ›´æ–°
  applyGroundThemeFromBgm();
}



// ã€Œã¾ã ãƒ­ãƒ¼ãƒ‰ã—ã¦ãªã„ã€çŠ¶æ…‹ã‚’ä½œã‚‹ãŸã‚ã«ã€ã“ã“ã§ Audio ã‚’ä½œã‚‰ãšé…å»¶ãƒ­ãƒ¼ãƒ‰
let bgmSougenAudio = null;
let bgmYoruAudio   = null;


const loadingOverlay = document.getElementById('loadingOverlay');
const bgmStatusEl = document.getElementById('bgmStatus');

function showLoadingOverlay(show){
  if (!loadingOverlay) return;
  if (show){
    loadingOverlay.classList.remove('hidden');
    loadingOverlay.classList.add('flex');
  } else {
    loadingOverlay.classList.add('hidden');
    loadingOverlay.classList.remove('flex');
  }
}

function updateBgmStatusLabel(){
  if (!bgmStatusEl) return;
  const id = getSelectedBgmId();
  const label = (BGM_META[id]?.label) || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ';
  bgmStatusEl.textContent = `BGMï¼š${label}`;
}
updateBgmStatusLabel();

function waitCanPlay(a){
  return new Promise((resolve, reject) => {
    let done = false;
    const ok = () => { if(done) return; done=true; cleanup(); resolve(); };
    const ng = (e) => { if(done) return; done=true; cleanup(); reject(e); };

    const cleanup = () => {
      a.removeEventListener('canplaythrough', ok);
      a.removeEventListener('canplay', ok);
      a.removeEventListener('error', ng);
      clearTimeout(t);
    };

    // ä¿é™ºï¼ˆç’°å¢ƒã§ã‚¤ãƒ™ãƒ³ãƒˆé£›ã°ã‚“æ™‚ã‚ã‚‹ã‹ã‚‰ï¼‰
    const t = setTimeout(ok, 8000);

    a.addEventListener('canplaythrough', ok, { once:true });
    a.addEventListener('canplay', ok, { once:true });
    a.addEventListener('error', ng, { once:true });

    try { a.load(); } catch (_) { ok(); }
  });
}

async function preloadSelectableBgm(id){
  if (id === 'default') return;

  const meta = BGM_META[id];
  if (!meta?.file) return;

  // ã™ã§ã«ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
  if (id === 'sougen' && bgmSougenAudio) return;
  if (id === 'yoru'   && bgmYoruAudio)   return;

  const a = new Audio(meta.file);   // â˜… blobã«ã—ãªã„ï¼
  a.loop = true;
  a.volume = (meta.volume ?? 0.5);
  a.preload = 'auto';

  await waitCanPlay(a);

  if (id === 'sougen') bgmSougenAudio = a;
  if (id === 'yoru')   bgmYoruAudio   = a;
}


  
  
/* ===== åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const gameOverScreen = document.getElementById('gameOverScreen');

const scoreLabel = document.getElementById('scoreLabel');


const shopButton = document.getElementById('shopButton');
const shopOverlay = document.getElementById('shopOverlay');
const closeShopButton = document.getElementById('closeShopButton');
const shopContent = document.getElementById('shopContent');
const shopAcornTotalEl = document.getElementById('shopAcornTotal');




  
// ===== DEBUG: ã©ã‚“ãã‚Š +50 éš ã—æ©Ÿèƒ½ =====
const ACORN_CHEAT_AMOUNT = 50;
const ACORN_CHEAT_TAPS = 7;          // 7é€£æ‰“
const ACORN_CHEAT_WINDOW_MS = 1400;  // 1.4ç§’ä»¥å†…

let acornCheatCount = 0;
let acornCheatTimer = null;

function addAcornsDebug(n){
  totalAcorns = (totalAcorns || 0) + n;
  localStorage.setItem(ACORN_TOTAL_KEY, String(totalAcorns));

  // è¡¨ç¤ºæ›´æ–°ï¼ˆå•†åº—å†…ã®æ•°å­—ï¼‰
  if (shopAcornTotalEl) shopAcornTotalEl.textContent = String(totalAcorns);

  // è§£æ”¾çŠ¶æ…‹ã‚‚å¤‰ã‚ã‚‹ã‹ã‚‰å†æç”»
  renderShop();

  // ãŠå¥½ã¿ï¼šé€šçŸ¥ï¼ˆãƒ‡ãƒãƒƒã‚°æ™‚ã ã‘ï¼‰
  alert(`DEBUGï¼šã©ã‚“ãã‚Š +${n}ï¼ˆæ‰€æŒ ${totalAcorns}ï¼‰`);
}

function installAcornCheat(){
  if (!DEBUG_OPTIONS.acornCheat) return;
  if (!shopAcornTotalEl) return;

  shopAcornTotalEl.addEventListener('pointerdown', (e) => {
    // â˜…å•†åº—ã‚’é–‹ã„ã¦ã‚‹æ™‚ã ã‘æœ‰åŠ¹ï¼ˆèª¤çˆ†é˜²æ­¢ï¼‰
    if (!shopOverlay || shopOverlay.classList.contains('hidden')) return;

    acornCheatCount++;
    if (acornCheatTimer) clearTimeout(acornCheatTimer);
    acornCheatTimer = setTimeout(() => {
      acornCheatCount = 0;
      acornCheatTimer = null;
    }, ACORN_CHEAT_WINDOW_MS);

    if (acornCheatCount >= ACORN_CHEAT_TAPS){
      acornCheatCount = 0;
      if (acornCheatTimer) clearTimeout(acornCheatTimer);
      acornCheatTimer = null;

      addAcornsDebug(ACORN_CHEAT_AMOUNT);
    }
  }, { passive: true });
}

installAcornCheat();



  
// â˜… ã‚¹ãƒãƒ›ç”¨ï¼šãƒãƒ¼ã‚ºä¸­ã«ã‚¹ã‚³ã‚¢/ãƒã‚¤ã‚¹ã‚³ã‚¢é€£æ‰“ã§ãƒ¯ãƒ¼ãƒ—
let warpTapCount300 = 0;
let warpTapCount500 = 0;
const WARP_TAPS_THRESHOLD = 5;        // 5é€£æ‰“ã§ç™ºå‹•
const WARP_TAP_WINDOW_MS = 1500;      // 1.5ç§’ä»¥å†…ã«5ã‚¿ãƒƒãƒ—

let warpTapTimer300 = null;
let warpTapTimer500 = null;

function tapWarp300(){
  warpTapCount300++;
  if (warpTapTimer300) clearTimeout(warpTapTimer300);
  warpTapTimer300 = setTimeout(() => {
    warpTapCount300 = 0;
    warpTapTimer300 = null;
  }, WARP_TAP_WINDOW_MS);

  if (warpTapCount300 >= WARP_TAPS_THRESHOLD){
    warpTapCount300 = 0;
    if (warpTapTimer300) clearTimeout(warpTapTimer300);
    warpTapTimer300 = null;
    warpToScoreBand(300);
    console.log('DEBUG: warp to score 300 band');
  }
}

function tapWarp500(){
  warpTapCount500++;
  if (warpTapTimer500) clearTimeout(warpTapTimer500);
  warpTapTimer500 = setTimeout(() => {
    warpTapCount500 = 0;
    warpTapTimer500 = null;
  }, WARP_TAP_WINDOW_MS);

  if (warpTapCount500 >= WARP_TAPS_THRESHOLD){
    warpTapCount500 = 0;
    if (warpTapTimer500) clearTimeout(warpTapTimer500);
    warpTapTimer500 = null;
    warpToScoreBand(500);
    console.log('DEBUG: warp to score 500 band');
  }
}

  
const highScoreBanner = document.getElementById('highScoreBanner');

// â˜… ãƒãƒ¼ã‚ºä¸­ã«ãƒ©ãƒ™ãƒ«ã‚’é€£æ‰“ â†’ ã‚¹ã‚³ã‚¢å¸¯ãƒ¯ãƒ¼ãƒ—ï¼ˆã‚¹ãƒãƒ›ç”¨ã®éš ã—æ“ä½œï¼‰
if (DEBUG_OPTIONS.warpMobile && scoreLabel) {
  scoreLabel.addEventListener('pointerdown', e => {
    if (!isPaused || !gameStarted || isGameOver) return;
    e.preventDefault();
    tapWarp300();
  });
}

if (DEBUG_OPTIONS.warpMobile && highScoreEl) {
  highScoreEl.addEventListener('pointerdown', e => {
    if (!isPaused || !gameStarted || isGameOver) return;
    e.preventDefault();
    tapWarp500();
  });
}




  
const finalScoreEl = document.getElementById('finalScore');

// const restartButton = document.getElementById('restartButton');

const shareButton = document.getElementById('shareButton');
const jumpButton = document.getElementById('jumpButton');
const pauseButton = document.getElementById('pauseButton');
const pauseOverlay = document.getElementById('pauseOverlay');  // â˜…ã“ã“è¿½åŠ 

const gameOverHighScoreLabel = document.getElementById('gameOverHighScoreLabel');

const startScreen = document.getElementById('startScreen');
// const startButton = document.getElementById('startButton'); â†å‰Šé™¤

const muteButton = document.getElementById('muteButton');
const creditsOverlay = document.getElementById('creditsOverlay');
const creditsButton = document.getElementById('creditsButton');
const creditsScroll = document.getElementById('creditsScroll');
const creditsEndMessage = document.getElementById('creditsEndMessage');

// â˜… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç”¨ï¼šã‚µãƒ³ã‚­ãƒ¥ãƒ¼è¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼
let creditsEndTimer = null;

// ã‚¢ãƒ‹ãƒ¡é•·ã•ã«åˆã‚ã›ã¦å‘¼ã³å‡ºã™
function scheduleCreditsEndMessage() {
  if (!creditsEndMessage) return;

  if (creditsEndTimer) {
    clearTimeout(creditsEndTimer);
    creditsEndTimer = null;
  }

  creditsEndTimer = setTimeout(() => {
    creditsEndMessage.classList.remove('hidden');
  }, 72000); // â† ã“ã“ã‚’ 40000 ã¨ã‹ã«å¤‰ãˆãŸã‚‰ 40ç§’ã§å‡ºã‚‹
}


  
const rankingOverlay      = document.getElementById('rankingOverlay');
const rankingContent      = document.getElementById('rankingContent');
const closeRankingButton  = document.getElementById('closeRankingButton');

// â˜… è¿½åŠ ï¼šãƒªã‚»ãƒƒãƒˆé–¢é€£
const resetConfirmOverlay = document.getElementById('resetConfirmOverlay');
const resetButton         = document.getElementById('resetButton');
const confirmResetButton  = document.getElementById('confirmResetButton');
const cancelResetButton   = document.getElementById('cancelResetButton');
  

const versionLabel = document.getElementById('versionLabel');
if (versionLabel) {
  versionLabel.textContent = `v${GAME_VERSION}`;
}


const sendScoreButton   = document.getElementById('sendScoreButton');
const sendStatusMessage = document.getElementById('sendStatusMessage');

const viewRankingButton = document.getElementById('viewRankingButton');
const backToTitleButton = document.getElementById('backToTitleButton');


  
if (sendScoreButton){
  sendScoreButton.addEventListener('click', (e) => {
    e.preventDefault();
    sendScoreToServer(score);    // ä»Šã®ã‚¹ã‚³ã‚¢ã‚’é€ä¿¡
  });
}

if (viewRankingButton){
  viewRankingButton.addEventListener('click', (e) => {
    e.preventDefault();
    openRankingOverlay();
  });
}

if (closeRankingButton){
  closeRankingButton.addEventListener('click', (e) => {
    e.preventDefault();
    closeRankingOverlay();
  });
}

if (backToTitleButton){
  backToTitleButton.addEventListener('click', (e) => {
    e.preventDefault();
    backToTitleFromGameOver();
  });
}

  


function escapeHtml(str){
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  };
  return String(str).replace(/[&<>"']/g, c => map[c]);
}


async function openRankingOverlay(){
  if (!rankingOverlay || !rankingContent) return;

  rankingOverlay.classList.remove('hidden');
  rankingOverlay.classList.add('flex');

 // â˜… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é–‰ã˜ã‚‹ã€ãƒ¢ãƒ¼ãƒ‰ã«
  updateJumpButton(JUMP_MODE.RANKING);
  
  rankingContent.innerHTML = '<p class="text-center text-sm">èª­ã¿è¾¼ã¿ä¸­ã‚€ã‚‹â€¦</p>';

  try {
    const res = await fetch(`${SCORE_API_URL}?mode=json`, { method: 'GET' });
    if (!res.ok) throw new Error('HTTP ' + res.status);

    const data = await res.json();
    const scores = data.scores || [];

    if (!scores.length){
      rankingContent.innerHTML =
        '<p class="text-center text-sm">ã¾ã è¨˜éŒ²ãŒãªã„ã‚€ã‚‹â€¦</p>';
      return;
    }

    rankingContent.innerHTML = scores.map(s => `
      <div class="flex items-center gap-2 border-b border-gray-700 py-1">
        <span class="w-8 text-left text-xs sm:text-sm">#${s.rank}</span>
        <span class="flex-1 text-left truncate text-xs sm:text-sm">
          ${escapeHtml(s.name)}
        </span>
        <span class="w-16 text-right font-mono text-sm sm:text-base">
          ${s.score}
        </span>
      </div>
    `).join('');
  } catch (err){
    console.error(err);
    rankingContent.innerHTML =
      '<p class="text-center text-sm text-red-300">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸã‚€ã‚‹â€¦</p>';
  }
}


function closeRankingOverlay(){
  if (!rankingOverlay) return;
  rankingOverlay.classList.add('hidden');
  rankingOverlay.classList.remove('flex');

  // çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
  if (isGameOver){
    updateJumpButton(JUMP_MODE.RESTART);

    // â˜… ã¾ã ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ä¸­ãªã‚‰ã‚°ãƒ¬ãƒ¼ã®ã¾ã¾
    if (!canRestart){
      setRestartCooldownActive(true);
    }
  } else if (!gameStarted){
    updateJumpButton(JUMP_MODE.START);
  } else {
    updateJumpButton(JUMP_MODE.PLAY);
  }
}




function openResetOverlay(){
  if (!resetConfirmOverlay) return;
  resetConfirmOverlay.classList.remove('hidden');
  resetConfirmOverlay.classList.add('flex');
}


function closeResetOverlay(){
  if (!resetConfirmOverlay) return;
  resetConfirmOverlay.classList.add('hidden');
  resetConfirmOverlay.classList.remove('flex');
}

/* â˜… ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼‰ */
if (resetButton){
  resetButton.addEventListener('click', e => {
    e.preventDefault();
    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã§ã ã‘æŠ¼ã›ã‚‹æƒ³å®šã‚„ã‘ã©ã€ã‚²ãƒ¼ãƒ ä¸­ã§ã‚‚æŒ™å‹•ã¯åŒã˜ã§OK
    openResetOverlay();
  });
}

// ã€Œã—ãªã„ã‚€ã‚‹ã€â†’ ä½•ã‚‚ã›ãšé–‰ã˜ã‚‹
if (cancelResetButton){
  cancelResetButton.addEventListener('click', e => {
    e.preventDefault();
    closeResetOverlay();
  });
}

// ã€Œæ¶ˆå»ã™ã‚‹ã€â†’ ãƒã‚¤ã‚¹ã‚³ã‚¢å‰Šé™¤ï¼‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
if (confirmResetButton){
  confirmResetButton.addEventListener('click', e => {
    e.preventDefault();

    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã—ã¦ã‚‹ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ¶ˆã™
    highScore = 0;
    localStorage.removeItem(HIGH_SCORE_KEY);

    if (highScoreEl){
      highScoreEl.textContent = 'ãƒã‚¤ã‚¹ã‚³ã‚¢: 0';
    }

    // ãƒã‚¤ã‚¹ã‚³ã‚¢æ¼”å‡ºç³»ã‚‚ãƒªã‚»ãƒƒãƒˆ
    isHighScoreRun = false;
    if (scoreLabel){
      scoreLabel.classList.remove('text-orange-400');
      scoreLabel.classList.add('text-blue-600');
    }
    if (highScoreBanner){
      highScoreBanner.classList.add('hidden');
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    alert('ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ¶ˆå»ã—ãŸã‚€ã‚‹ï¼ã¾ãŸãŒã‚“ã°ã‚‹ã‚€ã‚‹');

    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤é–‰ã˜ã‚‹ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã«ã¯å…ƒã€…ã„ã‚‹çŠ¶æ…‹ï¼‰
    closeResetOverlay();
  });
}




  
/* â–¼ ãƒœãƒˆãƒ ã®ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã®ãƒ¢ãƒ¼ãƒ‰ç®¡ç† */
const JUMP_MODE = {
  START: 'start',    // ã‚¿ã‚¤ãƒˆãƒ«ä¸­
  PLAY: 'play',      // ãƒ—ãƒ¬ã‚¤ä¸­
  RESTART: 'restart',  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å¾Œ
  CREDITS: 'credits',   // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºä¸­ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ï¼ã¨ã˜ã‚‹ï¼‰
  RANKING: 'ranking',   // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºä¸­ï¼ˆã¨ã˜ã‚‹ï¼‰
  SHOP: 'shop'

};

let jumpButtonMode = JUMP_MODE.START;

function updateJumpButton(mode){
  jumpButtonMode = mode;
  if (!jumpButton) return;

  // è‰²ç³»ã‚¯ãƒ©ã‚¹ã„ã£ãŸã‚“å…¨éƒ¨å¤–ã™
  jumpButton.classList.remove(
    'bg-blue-600',
    'bg-green-600',
    'bg-gray-700',
    'bg-gray-500',          // â˜… è¿½åŠ ï¼šãƒ­ãƒƒã‚¯ä¸­ã®è‰²
    'hover:bg-blue-700',
    'hover:bg-green-700',
    'hover:bg-gray-800',
    'opacity-60',           // â˜… è¿½åŠ ï¼šåŠé€æ˜
    'cursor-not-allowed'    // â˜… è¿½åŠ ï¼šç¦æ­¢ã‚«ãƒ¼ã‚½ãƒ«
  );

    switch(mode){
    case JUMP_MODE.START:
      jumpButton.textContent = 'ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ';
      jumpButton.classList.add('bg-green-600','hover:bg-green-700');
      break;

    case JUMP_MODE.PLAY:
      jumpButton.textContent = 'ã‚¸ãƒ£ãƒ³ãƒ—';
      jumpButton.classList.add('bg-blue-600','hover:bg-blue-700');
      break;

    case JUMP_MODE.RESTART:
      jumpButton.textContent = 'ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ';
      jumpButton.classList.add('bg-green-600','hover:bg-green-700');
      break;

    case JUMP_MODE.CREDITS:
      jumpButton.textContent = 'ã¨ã˜ã‚‹';
      jumpButton.classList.add('bg-gray-700','hover:bg-gray-800');
      break;

    case JUMP_MODE.RANKING:          // â˜… è¿½åŠ 
      jumpButton.textContent = 'ã¨ã˜ã‚‹';
      jumpButton.classList.add('bg-gray-700','hover:bg-gray-800');
      break;


   case JUMP_MODE.SHOP:
      jumpButton.textContent = 'ã¨ã˜ã‚‹';
      jumpButton.classList.add('bg-gray-700','hover:bg-gray-800');
      break;

  }

}


// åˆæœŸçŠ¶æ…‹ã¯ã€Œã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã€ï¼ˆç·‘ï¼‰
updateJumpButton(JUMP_MODE.START);



  
  
/* ===== Audioï¼ˆWeb Audio APIç‰ˆï¼šiPhoneã‚«ã‚¯ã¤ãå¯¾ç­–ï¼‰ ===== */
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx; // åˆæœŸåŒ–ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«è¡Œã†
const seBuffers = {};

// â˜… HIGHEND ç”¨ã®å†ç”Ÿä¸­ã‚½ãƒ¼ã‚¹ã‚’è¦šãˆã¦ãŠã
let currentHighEndSource = null;

// BGMã¯å¾“æ¥é€šã‚Šï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿï¼‰
let bgmAudio = new Audio('../assets/BGM.mp3');
bgmAudio.loop = true; bgmAudio.volume = 0.5;
let bgm2Audio = new Audio('../assets/BGM2.mp3');
bgm2Audio.loop = true; bgm2Audio.volume = 0.5;
let creditsAudio = new Audio('../assets/CREDIT.mp3');
creditsAudio.loop = true; creditsAudio.volume = 0.5;

let highScoreBgmTimeoutId = null;
let muted = false;
let audioBooted = false;

// SEãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼†ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆã“ã‚ŒãŒã‚«ã‚¯ã¤ãã‚’ãªãã™è‚ï¼‰
async function loadSeBuffer(name, url) {
  if (!audioCtx) return;
  try {
    const res = await fetch(url);
    const arrayBuffer = await res.arrayBuffer();
    const decodedBuffer = await audioCtx.decodeAudioData(arrayBuffer);
    seBuffers[name] = decodedBuffer;
  } catch (e) {
    console.error(`Failed to load SE: ${name}`, e);
  }
}


  // â˜… iOS åˆ¤å®šï¼ˆSafari/Chrome ã¾ã¨ã‚ã¦ï¼‰
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
// â˜… SE å…¨ä½“ã®ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³
const SE_MASTER_GAIN = isIOS ? 1.6 : 1.0;  // iPhoneã ã‘å°‘ã—æŒã¡ä¸Šã’ã‚‹


  
function playSeBuffer(name, volume = 0.5) {
  if (muted || !audioCtx || !seBuffers[name]) return;
  if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});

  const source = audioCtx.createBufferSource();
  source.buffer = seBuffers[name];

  const gainNode = audioCtx.createGain();
  gainNode.gain.value = volume * SE_MASTER_GAIN;

  source.connect(gainNode);
  gainNode.connect(audioCtx.destination);

  // â˜… HIGHEND ã ã‘ã¯ã€Œä»Šé³´ã£ã¦ã‚‹ã‚„ã¤ã€ã‚’è¦šãˆã¦ãŠã
  if (name === 'highend') {
    // ã™ã§ã«é³´ã£ã¦ã‚‹ã®ãŒã‚ã‚Œã°æ­¢ã‚ã‚‹
    if (currentHighEndSource) {
      try {
        currentHighEndSource.stop();
      } catch (_) {}
    }
    currentHighEndSource = source;

    // å†ç”Ÿã—çµ‚ã‚ã£ãŸã‚‰å‚ç…§ã‚¯ãƒªã‚¢
    source.onended = () => {
      if (currentHighEndSource === source) {
        currentHighEndSource = null;
      }
    };
  }

  source.start(0);
}

function stopHighEndSe() {
  if (currentHighEndSource) {
    try {
      currentHighEndSource.stop();
    } catch (_) {}
    currentHighEndSource = null;
  }
}





  

// åˆæœŸåŒ–ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ç›®ã§å®Ÿè¡Œï¼‰
async function bootAudioOnce() {
  if (audioBooted) return;
  audioBooted = true;

  // AudioContextä½œæˆ
  audioCtx = new AudioContext();

  // iOSç”¨: ç„¡éŸ³å†ç”Ÿã§ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ³ã‚¸ãƒ³ã‚’èµ·ã“ã™
  try {
    const buf = audioCtx.createBuffer(1, 1, 22050);
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.start(0);
  } catch (_) {}

  // ã“ã“ã§SEã‚’ä¸€æ‹¬ãƒ­ãƒ¼ãƒ‰ï¼ˆéåŒæœŸï¼‰
  loadSeBuffer('pick', '../assets/pick.mp3');
  loadSeBuffer('end', '../assets/END.mp3');
  loadSeBuffer('highend', '../assets/HIGHEND.mp3');
  loadSeBuffer('se', '../assets/SE.mp3');
}

// ç”»é¢ã‚¿ãƒƒãƒ/ã‚¯ãƒªãƒƒã‚¯ã§åˆæœŸåŒ–
const initEvents = ['touchstart', 'click', 'keydown'];
const initAudioHandler = () => {
  bootAudioOnce();
  initEvents.forEach(evt => document.removeEventListener(evt, initAudioHandler));
};
initEvents.forEach(evt => document.addEventListener(evt, initAudioHandler, { passive: false }));


/* --- æ—¢å­˜æ©Ÿèƒ½ã¨ã®äº’æ›ç”¨ --- */

function applyMute() {
  if (bgmAudio) bgmAudio.muted = muted;
  if (bgm2Audio) bgm2Audio.muted = muted;
  if (creditsAudio) creditsAudio.muted = muted;

  if (bgmSougenAudio) bgmSougenAudio.muted = muted;
  if (bgmYoruAudio)   bgmYoruAudio.muted = muted;
}


function playPickup() {
  playSeBuffer('pick', 0.5);
}

function stopAllMainBgms(){
  try { if (bgmAudio) { bgmAudio.pause(); bgmAudio.currentTime = 0; } } catch(_){}
  try { if (bgmSougenAudio) { bgmSougenAudio.pause(); bgmSougenAudio.currentTime = 0; } } catch(_){}
  try { if (bgmYoruAudio)   { bgmYoruAudio.pause(); bgmYoruAudio.currentTime = 0; } } catch(_){}
}

  function pauseAllMainBgms(){
  try { if (bgmAudio) bgmAudio.pause(); } catch(_){}
  try { if (bgmSougenAudio) bgmSougenAudio.pause(); } catch(_){}
  try { if (bgmYoruAudio) bgmYoruAudio.pause(); } catch(_){}
}


function getSelectedMainAudio(){
  const id = getSelectedBgmId();
  if (id === 'sougen' && bgmSougenAudio) return bgmSougenAudio;
  if (id === 'yoru'   && bgmYoruAudio)   return bgmYoruAudio;
  return bgmAudio; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}

function playMainBgm() {
  if (bgm2Audio) bgm2Audio.pause(); // æ—¢å­˜ã®ãƒã‚¤ã‚¹ã‚³ã‚¢BGMã¯åˆ¥æ ã®ã¾ã¾

  stopAllMainBgms();

  const a = getSelectedMainAudio();
  try {
    if (a && a.paused) {
      a.currentTime = 0;
      a.play().catch(()=>{});
    }
  } catch (_) {}
}


function playHighScoreBgm() {
  stopAllMainBgms(); // â˜…è¿½åŠ ï¼šè‰åŸ/å¤œã‚‚æ­¢ã‚ã‚‹

  try {
    if (bgm2Audio && bgm2Audio.paused) {
      bgm2Audio.currentTime = 0;
      bgm2Audio.play().catch(() => {});
    }
  } catch (_) {}
}


function startAudio() {
  bootAudioOnce();
  if (isHighScoreRun) playHighScoreBgm();
  else playMainBgm();
  applyMute();
}

function ensureBgmPlaying() {
  bootAudioOnce(); // iOSå¯¾ç­–ã‚‚è¾¼ã¿ã§èµ·ã“ã™
  applyMute();

  try {
    if (isHighScoreRun) {
      if (bgm2Audio && bgm2Audio.paused) bgm2Audio.play().catch(() => {});
    } else {
      const a = getSelectedMainAudio();
      if (a && a.paused) a.play().catch(() => {});
    }
  } catch (_) {}
}
  


  
function playCreditsBgm() {
  try { creditsAudio.currentTime = 0; creditsAudio.play(); } catch (_) {}
}
function stopCreditsBgm() {
  try { creditsAudio.pause(); creditsAudio.currentTime = 0; } catch (_) {}
}

if (muteButton) {
  muteButton.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    muted = !muted;
    applyMute();
    muteButton.textContent = muted ? 'ğŸ”‡' : 'ğŸ”Š';
  });
}

  

/* ===== ç”»é¢ã‚µã‚¤ã‚ºï¼ˆå›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== */

const gameWidth  = 768;
const gameHeight = 384;  // â† ç¸¦å°‘ã—ä¼¸ã°ã™ï¼ˆ16:9 è¿‘ãï¼‰

canvas.width  = gameWidth;
canvas.height = gameHeight;


/* ===== ç©ºã®ãƒ†ãƒ¼ãƒï¼ˆæ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚°é€£å‹• / ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰ ===== */
const THEMES={ morning:{top:[160,210,235],bottom:[247,250,252]}, evening:{top:[246,173,85],bottom:[253,230,138]}, night:{top:[45,55,90],bottom:[20,25,50]} };
let skyCurrent={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
let skyTarget ={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
const skyLerpSpeed=0.02;
let phaseName='morning';
function setBackgroundTheme(k){ const t=THEMES[k]||THEMES.morning; skyTarget={top:[...t.top],bottom:[...t.bottom]}; phaseName=k; }
function drawSky(df){
  const t=Math.min(1,skyLerpSpeed*df);
  for(let i=0;i<3;i++){ skyCurrent.top[i]+=(skyTarget.top[i]-skyCurrent.top[i])*t; skyCurrent.bottom[i]+=(skyTarget.bottom[i]-skyCurrent.bottom[i])*t; }
  const g=ctx.createLinearGradient(0,0,0,gameHeight);
  g.addColorStop(0,`rgb(${skyCurrent.top.map(x=>x|0).join(',')})`);
  g.addColorStop(0.8,`rgb(${skyCurrent.bottom.map(x=>x|0).join(',')})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,gameWidth,gameHeight);
}



/* ===== æ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆBGMã®é•·ã•ãƒ™ãƒ¼ã‚¹ã§æ™‚é–“ç®¡ç†ï¼‰ ===== */
// BGM.mp3 ã®é•·ã•ï¼š2:19.100 = 139.1 ç§’
const TRACK_LENGTH_S = 139.1;

// 1ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã€Œå¤•ç„¼ã‘ã€ã«å…¥ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆå‰ã¨åŒã˜ 96ç§’ï¼‰
const EVENING_MARK_S = 96;

// ç¾åœ¨ BGM ãŒä½•å‘¨ç›®ã¾ã§é€²ã‚“ã æƒ³å®šã‹ï¼ˆ0,1,2,...ï¼‰
let skyLoopIndex = 0;
// ãã®ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã€Œå¤•ç„¼ã‘ã€ã«ã‚‚ã†åˆ‡ã‚Šæ›¿ãˆæ¸ˆã¿ã‹ã©ã†ã‹
let skyEveningTriggered = false;

// ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»ãƒªã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«å‘¼ã¶
function resetAudioSyncState(){
  skyLoopIndex        = 0;
  skyEveningTriggered = false;

  // â˜…Yorué¸æŠãªã‚‰å¤œã‹ã‚‰ã€ãã‚Œä»¥å¤–ã¯æœã‹ã‚‰
  const startNight = (getSelectedBgmId() === 'yoru');
  setBackgroundTheme(startNight ? 'night' : 'morning');
}


// çµŒéæ™‚é–“ï¼ˆtimeElapsedï¼‰ã‹ã‚‰ã€ŒBGM ã®ã©ã®ã‚ãŸã‚Šã‹ã€ã‚’é€†ç®—ã—ã¦ç©ºã‚’æ±ºã‚ã‚‹
function updateSkyByTimeline(){
  if (!gameStarted || isPaused || isGameOver) return;

  const tSec = timeElapsed / 1000;
  const loopIndex = Math.floor(tSec / TRACK_LENGTH_S);
  const localSec  = tSec % TRACK_LENGTH_S;

  // â˜…Yoruãªã‚‰ãƒˆã‚°ãƒ«ã®åŸºæº–ã‚’åè»¢ï¼ˆ0å‘¨ç›®=å¤œï¼‰
  const startOffset = (getSelectedBgmId() === 'yoru') ? 1 : 0;

  if (loopIndex !== skyLoopIndex){
    skyLoopIndex        = loopIndex;
    skyEveningTriggered = false;

    // 0å‘¨ç›®: æœ(é€šå¸¸) / å¤œ(Yoru) ã«ãªã‚‹
    const isNightBase = ((skyLoopIndex + startOffset) % 2 === 1);
    setBackgroundTheme(isNightBase ? 'night' : 'morning');
  }

  if (!skyEveningTriggered && localSec >= EVENING_MARK_S){
    setBackgroundTheme('evening');
    skyEveningTriggered = true;
  }
}









  

/* ===== é›²ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰å¢—ï¼‹ã‚²ãƒ¼ãƒ é€Ÿåº¦é€£å‹•ï¼‰ ===== */
let clouds = Array.from({length:6},()=>({
  x: Math.random()*gameWidth,
  y: 30 + Math.random()*100,
  base: 0.35 + Math.random()*0.35,
  size: 70 + Math.random()*70
}));

  
function drawClouds(df){
  // æ˜¼ãƒ»å¤•ãƒ»å¤œãã‚Œãã‚Œã§é›²ã®é€æ˜åº¦ã‚’å¤‰ãˆã‚‹
  let alpha;
  if (phaseName === 'night') {
    alpha = 0.03; // â† å¤œã¯ã‚ã£ã¡ã‚ƒè–„ãï¼ˆã»ã¼é€ã‘ã‚‹ï¼‰
  } else if (phaseName === 'evening') {
    alpha = 0.25; // â† å¤•æ–¹ã¯å°‘ã—ã‚ªãƒ¬ãƒ³ã‚¸ç©ºæ°—æ„Ÿ
  } else {
    alpha = 0.42; // â† æ˜¼é–“ã¯é€šå¸¸
  }

  ctx.fillStyle = `rgba(255,255,255,${alpha})`;

  const speedBoost = 1 + (gameSpeed / 10);
  for (const c of clouds) {
    const v = c.base * speedBoost;
    c.x -= v * df;
    if (c.x < -220) {
      c.x = gameWidth + 120;
      c.y = 30 + Math.random() * 100;
    }

    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.size, c.size * 0.55, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(c.x + c.size * 0.6, c.y + 10, c.size * 0.9, c.size * 0.48, 0, 0, Math.PI * 2);
    ctx.fill();
  }
}



  
/* ===== æ˜Ÿç©ºï¼ˆå¤œã ã‘ãƒ•ã‚§ãƒ¼ãƒ‰è¡¨ç¤ºãƒ»ã‚†ã£ãã‚Šè¦–å·®ãƒ»ãŸã¾ã«æµã‚Œæ˜Ÿï¼‰ ===== */
// ç”»é¢å¹…ã«å¯¾ã—ã¦æ§ãˆã‚ã€‚768pxãªã‚‰ ~75å€‹å‰å¾Œ
const STAR_COUNT = Math.max(40, Math.round(gameWidth * 0.10));

let stars = [];
let starAlpha = 0;                 // å¤œã¸ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼æœå¤•ã¸ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
const STAR_LERP = 0.03;            // ãƒ•ã‚§ãƒ¼ãƒ‰ã®ãªã‚ã‚‰ã‹ã•
let shooting = null;

// æ˜Ÿã¯ã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨åˆ‡ã‚Šé›¢ã—ã€ä¸€å®šã®è¶…ä½é€Ÿãƒ‰ãƒªãƒ•ãƒˆã«ã™ã‚‹ï¼ˆé›ªã£ã½ã•é˜²æ­¢ï¼‰
const STAR_DRIFT_BASE = 0.12;      // 60fpsæ›ç®—ã ã¨ 0.12px/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã‹ãªã‚Šã‚†ã£ãã‚Šï¼‰

function initStars(){
  stars = Array.from({length: STAR_COUNT}, () => ({
    x: Math.random()*gameWidth,
    // åœ°å¹³ç·šã‚ˆã‚Šä¸Šã ã‘ï¼†ä¸Šç©ºå´ã‚’å°‘ã—åšã‚ã«
    y: Math.random()*(groundY - 60),
    // å°ã•ã‚ã§å¤§åŠã‚’0.4ã€œ1.2pxã«æŠ‘ãˆã‚‹
    r: 0.4 + Math.random()*0.8,
    // ç¬ãã¯ã‹ãªã‚Šã‚†ã£ãã‚Š
    tw: Math.random()*Math.PI*2,
    twSpeed: 0.005 + Math.random()*0.007,   // 0.005ã€œ0.012
    // è¦–å·®ã¯æ¥µå°ï¼šè¿‘æ™¯ã§ã‚‚é€Ÿãè¦‹ãˆãªã„ãƒ¬ãƒ³ã‚¸ã«å›ºå®š
    parallax: 0.02 + Math.random()*0.06     // 0.02ã€œ0.08
  }));
}

// å¤œã ã‘ã€ãŸã¾ã«æµã‚Œæ˜Ÿ
function maybeSpawnShootingStar(){
  if (shooting || phaseName !== 'night') return;
  // ã ã„ãŸã„15ã€œ25ç§’ã«1å›ãã‚‰ã„ã®ä½“æ„Ÿï¼ˆæ§ãˆã‚ï¼‰
  if (Math.random() < 0.0025) {
    shooting = {
      x: Math.random() * (gameWidth * 0.6) + gameWidth * 0.2,
      y: 30 + Math.random() * (groundY * 0.35),
      vx: -(3 + Math.random()*2),
      vy:  1 + Math.random()*1.2,
      life: 60 + Math.random()*30,   // ãƒ•ãƒ¬ãƒ¼ãƒ å¯¿å‘½
      len: 40 + Math.random()*30
    };
  }
}

function drawStars(df){
  // å¤œã ã‘ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1ã€ãã‚Œä»¥å¤–0ã¸ãƒ•ã‚§ãƒ¼ãƒ‰
  const target = (phaseName === 'night') ? 1 : 0;
  starAlpha += (target - starAlpha) * (STAR_LERP * df);

  if (starAlpha <= 0.01 && phaseName !== 'night') return; // ã»ã¼è¦‹ãˆãªã„ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

  // ä¸€å®šã®ã”ãä½é€Ÿãƒ‰ãƒªãƒ•ãƒˆï¼‹æ¥µå°è¦–å·®ï¼ˆã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨ã¯ç„¡é–¢ä¿‚ï¼‰
  for (const s of stars) {
    const drift = (STAR_DRIFT_BASE + s.parallax) * df; // å¸¸ã«ã‚†ã£ãã‚Šå·¦ã¸
    s.x -= drift;
    if (s.x < -3) { s.x = gameWidth + 3; s.y = Math.random()*(groundY - 60); }

    // ã‚†ã£ãã‚Šç¬ã
    s.tw += s.twSpeed * df;
    const twinkle = 0.75 + 0.25 * Math.sin(s.tw); // 0.5ã€œ1.0ãã‚‰ã„ã®æŸ”ã‚‰ã‹ã„æºã‚Œ
    const a = Math.max(0, Math.min(1, starAlpha * twinkle));

    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
  }

  // æµã‚Œæ˜Ÿï¼ˆæ—¢å­˜ã®è¦‹ãŸç›®ã‚’ç¶­æŒï¼‰
  maybeSpawnShootingStar();
  if (shooting) {
    const a = 0.75 * starAlpha;
    const tailX = shooting.x + shooting.len * 0.8;
    const tailY = shooting.y - shooting.len * 0.4;

    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(shooting.x, shooting.y, 1.6, 0, Math.PI*2); ctx.fill();

    const grad = ctx.createLinearGradient(shooting.x, shooting.y, tailX, tailY);
    grad.addColorStop(0, `rgba(255,255,255,${a})`);
    grad.addColorStop(1, `rgba(255,255,255,0)`);
    ctx.strokeStyle = grad;
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(shooting.x, shooting.y); ctx.lineTo(tailX, tailY); ctx.stroke();

    // æµã‚Œæ˜Ÿã ã‘ã¯å°‘ã—é€Ÿã„æ„Ÿã˜ã®ã¾ã¾ï¼ˆã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨ã‚‚ç‹¬ç«‹ï¼‰
    shooting.x += shooting.vx * df;
    shooting.y += shooting.vy * df;
    shooting.life -= df;
    if (shooting.life <= 0 || shooting.x < -60 || shooting.y > groundY - 10) shooting = null;
  }
}


// ===== åœ°é¢ãƒ†ãƒ¼ãƒï¼ˆBGMã§åˆ‡æ›¿ï¼‰ =====
const GROUND_THEMES = {
  dirt: {
    base: '#8B5A2B',
    grain:  [139, 90, 43],
    pebble: [133, 84, 40],
    streak: [130, 82, 38],
  },
  grass: {
    base: '#2F7D3B',     // è‰åŸã£ã½ã„ç·‘
    grain:  [55, 140, 70],
    pebble: [40, 110, 55],
    streak: [30, 95, 45],
  }
};

// ä»Šã©ã£ã¡ã®åœ°é¢ã‹ï¼ˆåˆæœŸã¯é¸æŠBGMã‹ã‚‰æ±ºã‚ã‚‹ï¼‰
let groundThemeKey = (getSelectedBgmId() === 'sougen') ? 'grass' : 'dirt';

function applyGroundThemeFromBgm(){
  const nextKey = (getSelectedBgmId() === 'sougen') ? 'grass' : 'dirt';
  if (nextKey === groundThemeKey) return;
  groundThemeKey = nextKey;

  // ç²’/å°çŸ³ã®è‰²ã‚‚åˆ‡ã‚Šæ›¿ãˆãŸã„ã‹ã‚‰ä½œã‚Šç›´ã™
  initGroundDetails();
}


  
/* ===== åœ°é¢ï¼ˆè‰²å‘³èª¿æ•´ï¼‹é€Ÿåº¦ä¸€è‡´ï¼‰ ===== */
const groundY = gameHeight - 50;
function drawGround(){
  const t = GROUND_THEMES[groundThemeKey] || GROUND_THEMES.dirt;
  ctx.fillStyle = t.base;
  ctx.fillRect(0, groundY, gameWidth, 50);
}


initStars(); 

let groundGrains = [];   // ç´°ã‹ã„ç ‚
let groundPebbles = [];  // å°çŸ³
let groundStreaks = [];  // åœ°è¡¨ã®æ¨ªç·š

function initGroundDetails(){
  const t = GROUND_THEMES[groundThemeKey] || GROUND_THEMES.dirt;

  const grainsN  = Math.floor(gameWidth * 0.38);
  const pebblesN = Math.floor(gameWidth * 0.08);
  const streaksN = Math.floor(gameWidth * 0.05);

  const jitter = (v, j) => v + Math.floor((Math.random()*2 - 1) * j);

  groundGrains = Array.from({length:grainsN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 8 + Math.random()*38,
    r: 0.8 + Math.random()*1.4,
    shadeR: jitter(t.grain[0], 8),
    shadeG: jitter(t.grain[1], 8),
    shadeB: jitter(t.grain[2], 8)
  }));

  groundPebbles = Array.from({length:pebblesN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 10 + Math.random()*36,
    w: 2 + Math.random()*3,
    h: 1 + Math.random()*2,
    shadeR: jitter(t.pebble[0], 10),
    shadeG: jitter(t.pebble[1], 10),
    shadeB: jitter(t.pebble[2], 10)
  }));

  groundStreaks = Array.from({length:streaksN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 6 + Math.random()*10,
    len: 8 + Math.random()*18,
    shadeR: jitter(t.streak[0], 10),
    shadeG: jitter(t.streak[1], 10),
    shadeB: jitter(t.streak[2], 10)
  }));
}

initGroundDetails();

/* â˜… åœ°é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼éšœå®³ç‰©ï¼ˆ= gameSpeedï¼‰ã«å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ */
function drawGroundDetails(df){
  const v = gameSpeed * df; // â† çµ±ä¸€

  // ç ‚
  for(const g of groundGrains){
    g.x -= v;
    if(g.x < -2){ g.x = gameWidth + Math.random()*40; g.y = groundY + 8 + Math.random()*38; }
    ctx.fillStyle = `rgb(${g.shadeR}, ${g.shadeG}, ${g.shadeB})`;
    ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
  }

  // å°çŸ³
  for(const p of groundPebbles){
    p.x -= v;
    if(p.x < -3){ p.x = gameWidth + Math.random()*60; p.y = groundY + 10 + Math.random()*36; }
    ctx.fillStyle = `rgb(${p.shadeR}, ${p.shadeG}, ${p.shadeB})`;
    ctx.fillRect(p.x, p.y, p.w, p.h);
  }

  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯
  for(const s of groundStreaks){
    s.x -= v;
    if(s.x < -s.len){ s.x = gameWidth + Math.random()*80; s.y = groundY + 6 + Math.random()*10; }
    ctx.strokeStyle = `rgba(${s.shadeR}, ${s.shadeG}, ${s.shadeB}, 0.55)`;
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x + s.len, s.y); ctx.stroke();
  }
}


/* ===== ã‚²ãƒ¼ãƒ æœ¬ä½“ ===== */
let score = 0;
let highScore = parseInt(localStorage.getItem(HIGH_SCORE_KEY) || '0', 10);
highScoreEl.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;

let gameSpeed           = 5;
let baseGameSpeed       = 5;
let gameSpeedAcceleration = 0.03;  // â˜…ã“ã“ä¸‹ã’ã‚‹
const GAME_SPEED_MAX    = 12;      // â˜…ã“ã“ã‚‚å°‘ã—ä¸‹ã’ã‚‹


// â˜… è¿½åŠ ï¼šæœ€å¾Œã«æ­»ã‚“ã ã¨ãã®ç›¸æ‰‹
let lastDeathType = 'none';

  

let timeElapsed=0, obstacles=[], frame=0, spawnTimer=0;
const minSpawnIntervalBase=105, maxSpawnIntervalBase=155, spawnIntervalReductionPerSec=4;
const EARLY_EASE_MS=15000, EARLY_EASE_START_MULT=1.15;
  
function currentOnscreenLimit(ms){
  if(ms < 45000)  return 2; // ã€œ45s
  if(ms < 120000) return 3; // 45sã€œ2åˆ†
  return 4;                 // 2åˆ†ã€œ
}


let isGameOver=false, isPaused=false, gameStarted=false, lastTime=0;
let isDebug=false, debugTapCount=0; const DEBUG_TAPS_TO_ENABLE=20;
let nextSpawnInterval=90;
let isHighScoreRun = false;

// â˜… ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç›´å¾Œã¯ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã‚’å°‘ã—ã ã‘ãƒ­ãƒƒã‚¯ã™ã‚‹
let canRestart = false;
const RESTART_DELAY_MS = 1500; // â† å¥½ãã«èª¿æ•´ï¼ˆãƒŸãƒªç§’ï¼‰
  
// â˜… ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ã€Œãƒ­ãƒƒã‚¯ä¸­/è§£æ”¾æ¸ˆã¿ã€ã§åˆ‡ã‚Šæ›¿ãˆã‚‹
function setRestartCooldownActive(active){
  if (!jumpButton) return;
  if (jumpButtonMode !== JUMP_MODE.RESTART) return;

  // ã„ã£ãŸã‚“ã‚°ãƒ¬ãƒ¼ç³»ã‚¯ãƒ©ã‚¹ã‚’æƒé™¤
  jumpButton.classList.remove('bg-gray-500', 'opacity-60', 'cursor-not-allowed');

  if (active){
    // â˜… ãƒ­ãƒƒã‚¯ä¸­ â†’ ã‚°ãƒ¬ãƒ¼ï¼†æŠ¼ã›ãªã•ãã†ã«
    jumpButton.classList.remove('bg-green-600','hover:bg-green-700');
    jumpButton.classList.add('bg-gray-500','opacity-60','cursor-not-allowed');
  } else {
    // â˜… è§£æ”¾æ¸ˆã¿ â†’ ã„ã¤ã‚‚ã®ç·‘ã«æˆ»ã™
    jumpButton.classList.add('bg-green-600','hover:bg-green-700');
  }
}




  
// â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢çªå…¥ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨
let flashTimer = 0;
const FLASH_DURATION = 18; // ã ã„ãŸã„ 18ãƒ•ãƒ¬ãƒ¼ãƒ  â‰’ 0.3ç§’


/* === ã©ã‚“ãã‚Šï¼ˆSVG/é€Ÿåº¦å›ºå®š/5ç§’Â±1ç§’ã”ã¨ã«æŠ½é¸30%ï¼‰ === */
class Acorn{
  constructor(type,x,y,size){ this.type=type; this.x=x; this.y=y; this.size=size; this.t=Math.random()*Math.PI*2; }
  update(d){
    const fixedSpeed=0.5*baseGameSpeed; // å¸¸ã«ãƒ™ãƒ¼ã‚¹ã®åŠåˆ†ï¼ˆåŠ é€Ÿã—ãªã„ï¼‰
    this.x -= fixedSpeed * d;
    if(this.type==='air'){ this.t+=0.05*d; this.y += Math.sin(this.t)*0.2*d; }
  }
  draw(){
    const img=SPRITES.donguri; if(img && img.complete){ const w=this.size,h=this.size; ctx.drawImage(img,this.x,this.y-h,w,h); }
  }
  getHitbox(){
      return {
      x: this.x - this.size * 0.05,
      y: this.y - this.size * 1.02,
      width:  this.size * 0.9,
      height: this.size * 1.02
      };
  }

}
let acorns = [];

// â˜…ã©ã‚“ãã‚Šã‚³ãƒ³ãƒœç”¨
let acornComboCount = 0;  // é€£ç¶šå–å¾—æ•°ï¼ˆ0ãªã‚‰ãƒãƒ¼ã‚³ãƒ³ãƒœçŠ¶æ…‹ï¼‰

 // â˜… ã©ã‚“ãã‚Šå–ã£ãŸã¨ãã«å‡ºã™ã€Œ+10ã€ã¿ãŸã„ãªãƒ•ã‚­ãƒ€ã‚·ç”¨
class FloatText {
  constructor(text, x, y, options = {}) {
    this.text = text;
    this.x = x;
    this.y = y;
    this.vy = options.vy ?? -0.6;   // ä¸Šã«ãµã‚ã£ã¨ä¸ŠãŒã‚‹é€Ÿã•
    this.life = options.life ?? 30; // å¯¿å‘½

    // â˜… è¿½åŠ ï¼šè‰²ã‚„ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§
    this.color      = options.color      ?? '#fff7aa';
    this.stroke     = options.stroke     ?? 'rgba(0,0,0,0.75)';
    this.fontSize   = options.fontSize   ?? 20;
  }
}


let floatTexts = [];
 

// â˜… ãƒŸãƒªç§’åŸºæº–ã‚¿ã‚¤ãƒï¼ˆç«¯æœ«å·®ãªã—ï¼‰
let acornSpawnTimerMs = 0;
function nextAcornIntervalMs(){ return 5000 + Math.random()*2000; } // 5ã€œ7ç§’ã«ä¸€åº¦ æŠ½é¸
let acornNextIntervalMs = nextAcornIntervalMs();

function maybeSpawnAcorn(){
  if(Math.random() >= 0.45) return; // ã©ã‚“ãã‚Šç™ºç”Ÿç‡
  const x = gameWidth + 20;         // â˜… æœªå®šç¾©ãƒã‚°ä¿®æ­£
  const size = 56 + Math.floor(Math.random()*12); // ã¡ã‚‡ã„å¤§ãã‚
  if(Math.random()<0.5){
    const y=groundY-6; acorns.push(new Acorn('ground',x,y,size));
  }else{
    const minY=groundY-160, maxY=groundY-60; const y=Math.floor(minY+Math.random()*(maxY-minY));
    acorns.push(new Acorn('air',x,y,size));
  }
}
function spawnAcornMs(deltaMs){
  acornSpawnTimerMs += deltaMs;
  if(acornSpawnTimerMs < acornNextIntervalMs) return;
  acornSpawnTimerMs = 0;
  acornNextIntervalMs = nextAcornIntervalMs();
  maybeSpawnAcorn();
}

function updateAcorns(d){
  for(let i=acorns.length-1;i>=0;i--){
    const a = acorns[i];
    a.update(d);
    a.draw();

    // ç”»é¢å·¦ã«æŠœã‘ãŸ = å–ã‚Šé€ƒã—
    if(a.x < -50){
      acorns.splice(i, 1);

      // â˜…ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
      acornComboCount = 0;
    }
  }
}


  
function tryCollectAcorns(){
  const p = {
    x: player.x,
    y: player.y,
    width:  player.width * 0.6,
    height: player.height * 0.7
  };

  for (let i = acorns.length - 1; i >= 0; i--) {
    const a = acorns[i];
    const h = a.getHitbox();

    const hit =
      p.x < h.x + h.width &&
      p.x + p.width > h.x &&
      p.y < h.y + h.height &&
      p.y + p.height > h.y;

    if (hit) {
      // â˜… ã‚³ãƒ³ãƒœã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
      acornComboCount++;                 // 1å€‹ç›®â†’1, 2å€‹ç›®â†’2, 3å€‹ç›®â†’3...

      const comboBonus = acornComboCount - 1;     // 1å€‹ç›®:0, 2å€‹ç›®:1, 3å€‹ç›®:2...
      const basePoints = isDebug ? 200 : 10;      // ãƒ‡ãƒãƒƒã‚°æ™‚ã¯ 200 ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
      const gained     = basePoints + comboBonus; // 10,11,12... / 200,201,202...

      // ã‚¹ã‚³ã‚¢åŠ ç®—
      score += gained;

      // â˜… ç´¯è¨ˆã©ã‚“ãã‚Šæ•°ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¾ãŸã„ã§ã‚«ã‚¦ãƒ³ãƒˆï¼‰
      totalAcorns += 1;
      localStorage.setItem(ACORN_TOTAL_KEY, String(totalAcorns));

      const baseX = a.x + a.size * 0.5;
      const baseY = a.y - a.size * 0.4;

      // ãƒ¡ã‚¤ãƒ³ã® "+10" / "+11" ãªã©ï¼ˆä»Šã¾ã§ã®ã‚„ã¤ï¼‰
      floatTexts.push(
        new FloatText(
          `+${gained}`,
          baseX,
          baseY,
          {
            // è‰²ã¨ã‹ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§OKãªã®ã§æŒ‡å®šãªã—ã§ã‚‚å¯
            // ã“ã“ã§ã„ã˜ã‚ŠãŸããªã£ãŸã‚‰ options è¿½åŠ ã—ã¦ã‚‚OK
          }
        )
      );

      // â˜… ã‚³ãƒ³ãƒœä¸­ã ã‘ã€ŒCOMBO!! +1ã€ã‚’ä¸Šã«è¡¨ç¤ºï¼ˆã‚ªãƒ¬ãƒ³ã‚¸æ–‡å­—ï¼‰
      if (comboBonus > 0) {
        floatTexts.push(
          new FloatText(
            `COMBO!! +${comboBonus}`,
            baseX,
            baseY - 24,  // ã¡ã‚‡ã„ä¸Šã«è¡¨ç¤º
            {
              color:    '#FFA500',                  // ã‚ªãƒ¬ãƒ³ã‚¸
              stroke:   'rgba(0,0,0,0.9)',
              fontSize: 18,
              life:     32,
              vy:       -0.55
            }
          )
        );
      }

      // ã©ã‚“ãã‚Šå‰Šé™¤ï¼†SE
      acorns.splice(i, 1);
      playPickup();
    }
  }
}




/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function clamp01(v){ return Math.max(0,Math.min(1,v)); }
function getEarlyEaseMultiplier(ms){ const t=clamp01(ms/EARLY_EASE_MS); return EARLY_EASE_START_MULT + (1.0-EARLY_EASE_START_MULT)*t; }
function getMinPixelGap(ms){ const t=clamp01(ms/EARLY_EASE_MS); const s=Math.round(gameWidth*0.42), e=Math.round(gameWidth*0.32); return Math.round(s+(e-s)*t); }
function enableDebugMode(){
  // â˜… ç„¡åŠ¹åŒ–ã•ã‚Œã¦ãŸã‚‰ä½•ã‚‚ã—ãªã„
  if (!DEBUG_OPTIONS.invincibleMode) return;

  if(isDebug) return;
  isDebug=true;
  const b=document.createElement('span');
  b.id='debugBadge';
  b.textContent='DEBUG';
  b.className='px-2 py-1 bg-pink-600 text-white text-xs font-bold rounded shadow-sm ml-1';
  highScoreEl.parentElement.appendChild(b);
}

function resetDebugTapCounter(){ debugTapCount=0; }

  
function startHighScoreRun(){
  if (isHighScoreRun) return;
  isHighScoreRun = true;

  // è¦‹ãŸç›®å¤‰æ›´
  if (scoreLabel){
    scoreLabel.classList.remove('text-blue-600');
    scoreLabel.classList.add('text-orange-400');
  }
  if (highScoreBanner){
    highScoreBanner.classList.remove('hidden');
  }
  flashTimer = FLASH_DURATION;

  // SEï¼ˆã“ã“ãŒã‚¨ãƒ©ãƒ¼ã®å…ƒãªã®ã§ã€å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ã™ã‚‹ã‚ˆã†ã«åŒ…ã‚€ï¼‰
  try {
    playSeBuffer('se', 0.5);
  } catch(e) { console.error(e); }

  // ã„ã£ãŸã‚“ã€Œãƒ¡ã‚¤ãƒ³BGMï¼ˆé¸æŠBGMå«ã‚€ï¼‰ã€ã‚’æ­¢ã‚ã‚‹
stopAllMainBgms();

// ãƒã‚¤ã‚¹ã‚³ã‚¢BGMã‚‚å¿µã®ãŸã‚æ­¢ã‚ã¦é ­å‡ºã—
try{
  if (bgm2Audio){
    bgm2Audio.pause();
    bgm2Audio.currentTime = 0;
    bgm2Audio.volume = 0.5;
  }
}catch(_){}


  // æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¤ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  if (highScoreBgmTimeoutId !== null){
    clearTimeout(highScoreBgmTimeoutId);
    highScoreBgmTimeoutId = null;
  }

  // â˜… 1ç§’å¾…ã£ã¦ã‹ã‚‰ BGM2 å†ç”Ÿï¼ˆãŸã ã—ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ãŸã‚‰ä½•ã‚‚ã—ãªã„ï¼‰
  highScoreBgmTimeoutId = setTimeout(() => {
    highScoreBgmTimeoutId = null;
    if (isGameOver) return;   // â† ã“ã“å¤§äº‹

    playHighScoreBgm();
    applyMute();
  }, 1000);

  applyMute();
}


  



/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
const player = {
  x: 50,
  y: groundY - 50,
  width: 50,
  height: 50,
  dy: 0,
  gravity: 0.8,
  jumpForce: 15,
  isGrounded: true,
  jumpsRemaining: 2,
  isJumping: false,
  image: new Image(),
  imageLoaded: false,

  // â˜… ã·ã«ã‚‡ã‚“ç”¨
  scaleX: 1,
  scaleY: 1,
  squashTimer: 0       // ä¸€ç¬ã ã‘å¼·ãå¤‰å½¢ã•ã›ã‚‹ã‚¿ã‚¤ãƒãƒ¼
};

player.image.src='../assets/Muru.png';
player.image.onload=()=>{ player.imageLoaded=true; player.width=(player.image.width/player.image.height)*player.height; };

function drawPlayer() {
  const cx = player.x + player.width / 2;
  const cy = player.y + player.height / 2;

  ctx.save();
  ctx.translate(cx, cy);
  ctx.scale(player.scaleX, player.scaleY);

  if (player.imageLoaded) {
    ctx.drawImage(
      player.image,
      -player.width / 2,
      -player.height / 2,
      player.width,
      player.height
    );
  } else {
    ctx.fillStyle = 'green';
    ctx.fillRect(
      -player.width / 2,
      -player.height / 2,
      player.width,
      player.height
    );
  }

  ctx.restore();
}

function updatePlayer(d) {
  // ç‰©ç†
  if (!player.isGrounded) {
    player.dy += player.gravity * d;
    player.y  += player.dy * d;
  }

  // ç€åœ°åˆ¤å®š
  if (player.y + player.height >= groundY) {
    if (!player.isGrounded) {
      // â˜… ç€åœ°ã®ã¨ãã¯ãƒ‰ãƒ³ãƒƒã¨ã¤ã¶ã‚Œã‚‹
    player.squashTimer = 20;   // æˆ»ã‚Šæ™‚é–“ã¡ã‚‡ã„é•·ã‚
    player.scaleX = 1.5;      // æ¨ªãã„ã£ã¨åºƒã’ã‚‹
    player.scaleY = 0.5;      // ç¸¦ã¯ã‚¬ãƒƒãƒ„ãƒªã¤ã¶ã™
    }

    player.y = groundY - player.height;
    player.dy = 0;
    player.isGrounded = true;
    player.jumpsRemaining = 2;
  } else {
    player.isGrounded = false;
  }

  // â˜… ã·ã«ã‚…ã‚“ã‚¢ãƒ‹ãƒ¡ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã®è£œé–“ï¼‰
  if (player.squashTimer > 0) {
    player.squashTimer -= d;

    // å¼·ã‚ã«ã€Œå…ƒã®å½¢ã€ã«æˆ»ã™
    const k = 0.25; // â† æˆ»ã‚Šã‚’ã‚­ãƒ“ã‚­ãƒ“
    player.scaleX += (1 - player.scaleX) * k;
    player.scaleY += (1 - player.scaleY) * k;
  } else {
    // ãµã ã‚“ã¯ã€åœ°ä¸Šã¨ç©ºä¸­ã§ã¡ã‚‡ã£ã¨ã ã‘å½¢å¤‰ãˆã‚‹
    const targetX = player.isGrounded ? 1.0 : 0.9;  // ç©ºä¸­ã¯ã¡ã‚‡ã„ç´°ã‚
    const targetY = player.isGrounded ? 1.0 : 1.10; // ç©ºä¸­ã¯å°‘ã—ä¼¸ã³ã‚‹

    const k = 0.15;
    player.scaleX += (targetX - player.scaleX) * k;
    player.scaleY += (targetY - player.scaleY) * k;
  }
}



function playerJump() {
  if (isGameOver || isPaused || !gameStarted) return;
  ensureBgmPlaying();
  
  if (player.jumpsRemaining > 0) {
    player.dy = -player.jumpForce;
    player.isGrounded = false;
    player.isJumping = true;
    player.jumpsRemaining--;

    // â˜… ã‚¸ãƒ£ãƒ³ãƒ—ç›´å¾Œï¼šãã‚…ã£ã¨ç¸®ã‚“ã§ã‹ã‚‰ä¼¸ã³ã‚‹æ„Ÿã˜
    player.squashTimer = 14;  // â† ã¡ã‚‡ã„é•·ã‚
    player.scaleX = 0.72;     // â† æ¨ªã‚’ç´°ã
    player.scaleY = 1.30;     // â† ç¸¦ã‚’ã‚°ã‚¤ã£ã¨ä¼¸ã°ã™
  }
}


function stopJump(){ if(player.isJumping && player.dy<0){ player.dy=Math.max(player.dy,-5); } player.isJumping=false; }

/* ===== éšœå®³ç‰©ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰ ===== */
class Obstacle{
  constructor(type,img,y,size){
    this.x=gameWidth; this.y=y; this.type=type; this.img=img; this.height=size;
    const iw=img.naturalWidth||1, ih=img.naturalHeight||1, aspect=iw/ih;
    this.width=this.height*aspect; this.passed=false;
  }
  draw(){ ctx.drawImage(this.img,this.x,this.y-this.height,this.width,this.height); }
  update(d){ this.x -= gameSpeed*d; }
  getHitbox() {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã¡ã‚‡ã„å°ã•ã‚
  let shrinkX = 0.8;
  let shrinkY = 0.8;
  let offsetY = 0; // ç¸¦æ–¹å‘ã®ãšã‚‰ã—é‡

  if (this.type === 'ground_large') {
    // â˜…ãƒ‡ã‚«ã²ã¾ã‚ã‚Šã ã‘ã€ã‹ãªã‚Šç”˜ã‚ã«ã™ã‚‹
    shrinkX = 0.70;   // æ¨ªã‚‚å°‘ã—å°ã•ã
    shrinkY = 0.55;   // ç¸¦ã¯ã‚¬ãƒƒãƒ„ãƒªä½ã
    offsetY = this.height * 0.08; // åˆ¤å®šã‚’æ°—æŒã¡ä¸‹ã«ãšã‚‰ã™ï¼ˆä¸Šã®èŠ±ã³ã‚‰ã¯é£¾ã‚Šï¼‰
  } else if (this.type === 'sun2_hop') {
    // â˜…ã‚¸ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã²ã¾ã‚ã‚Šç”¨ï¼ˆåŒã˜è¨­å®šï¼‰
    shrinkX = 0.70;   // æ¨ªã‚‚å°‘ã—å°ã•ã
    shrinkY = 0.55;   // ç¸¦ã¯ã‚¬ãƒƒãƒ„ãƒªä½ã
    offsetY = this.height * 0.08; // åˆ¤å®šã‚’æ°—æŒã¡ä¸‹ã«ãšã‚‰ã™ï¼ˆä¸Šã®èŠ±ã³ã‚‰ã¯é£¾ã‚Šï¼‰
  }

  const w = this.width  * shrinkX;
  const h = this.height * shrinkY;

  return {
    x: this.x + (this.width  - w) / 2,
    y: (this.y - this.height) + (this.height - h) / 2 + offsetY,
    width:  w,
    height: h
  };
}


}

/* â˜… è¿½åŠ ï¼šå‹•ãã²ã¾ã‚ã‚Šå°‚ç”¨ã‚¯ãƒ©ã‚¹ */
class SpecialSunflower extends Obstacle{
  constructor(type,img,y,size){
    super(type,img,y,size);
    this.baseY = y;
    this.phase = Math.random()*Math.PI*2;
    this.hopAmp = size * 1.1;   // ã´ã‚‡ã‚“ã´ã‚‡ã‚“ã®é«˜ã•
    this.hopSpeed = 0.1;        // ã´ã‚‡ã‚“ã´ã‚‡ã‚“ã®é€Ÿã•
  }

  update(d){
    if(this.type === 'sun2_run'){
      // ã“ã£ã¡ã«å‘ã‹ã£ã¦èµ°ã£ã¦ãã‚‹æ„Ÿã˜ï¼šæ™®é€šã‚ˆã‚Šã¡ã‚‡ã„é€Ÿã„
      this.x -= gameSpeed * 1.4 * d;
    }else if(this.type === 'sun2_hop'){
      // ãã®å ´ã§æµã‚Œã¦ãã‚‹ï¼‹å°ã•ãã‚¸ãƒ£ãƒ³ãƒ—
      this.x -= gameSpeed * d;
      this.phase += this.hopSpeed * d;
      const offset = Math.abs(Math.sin(this.phase)) * this.hopAmp;
      this.y = this.baseY - offset;
    }else{
      // ä¸‡ãŒä¸€ä»–ã‚¿ã‚¤ãƒ—ã«ã‚‚ä½¿ã£ãŸã¨ãç”¨
      super.update(d);
    }
  }
}



  
  
const SCALE = 0.7;

// â˜… ç‰¹åˆ¥ã²ã¾ã‚ã‚Šï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ï¼†èµ°ã‚‹ï¼‰ã® â€œé€£ç¶šå‡ºç¾â€ ã‚’åˆ¶å¾¡ã™ã‚‹ã‚«ã‚¦ãƒ³ã‚¿
const MAX_SPECIAL_CHAIN = 2;      // â† ç‰¹åˆ¥ã²ã¾ã‚ã‚ŠãŒä½•ä½“ã¾ã§é€£ç¶šã§å‡ºã‚‹ã‹
let specialChainCount    = 0;

function resetSpecialChain() {
  specialChainCount = 0;
}

function spawnObstacle(delta){
  spawnTimer += delta;

  let minSpawnInterval = Math.max(
    minSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec,
    40
  );
  let maxSpawnInterval = Math.max(
    maxSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec,
    70
  );

  const easeMul = getEarlyEaseMultiplier(timeElapsed);
  minSpawnInterval *= easeMul;
  maxSpawnInterval *= easeMul;

  function lateDensityMul(ms){
    if(ms < 60000)  return 1.0;
    if(ms < 120000) return 0.85;
    return 0.72;
  }
  const ld = lateDensityMul(timeElapsed);
  minSpawnInterval *= ld;
  maxSpawnInterval *= ld;

  // â˜… ã“ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã€Œç‰¹åˆ¥ã²ã¾ã‚ã‚Šï¼ˆèµ°ã‚‹/ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ã€ã‚’å‡ºã—ãŸã‚‰ true ã«ã™ã‚‹
  let forceMaxInterval = false;

  if (spawnTimer < nextSpawnInterval) return;

  const onscreen = obstacles.filter(o => (o.x + o.width > 0) && (o.x < gameWidth)).length;
  const limit = currentOnscreenLimit(timeElapsed);
  if (onscreen >= limit) return;

  const last = obstacles.length ? obstacles[obstacles.length-1] : null;
  const minGapPx = getMinPixelGap(timeElapsed);
  if (last){
    const gapPx = gameWidth - (last.x + last.width);
    if (gapPx < minGapPx) return;
  }

  const rand = Math.random();

  if (rand < 0.4){
    // ğŸ‡ ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ï¼ˆå…¨ã‚¹ã‚³ã‚¢å¸¯ã§ãšã£ã¨å‡ºã‚‹ï¼‰
    const size = (40 + Math.random()*20) * SCALE;
    const yPos = Math.random() < 0.3
      ? groundY - 30
      : groundY - 70 - Math.random()*50;

    obstacles.push(new Obstacle('air', SPRITES.blueberry, yPos, size));

    // â˜… ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ã‚’æŒŸã‚“ã ã‚‰ç‰¹åˆ¥ã²ã¾ã‚ã‚Šé€£é–ã‚‚ãƒªã‚»ãƒƒãƒˆ
    resetSpecialChain();

  } else {
    // ğŸŒ» ã²ã¾ã‚ã‚Šå´
    const hasRunner = (score >= 300); // 300ã€œ èµ°ã‚‹ã²ã¾ã‚ã‚Šè§£ç¦
    const hasHopper = (score >= 500); // 500ã€œ ã‚¸ãƒ£ãƒ³ãƒ—ã²ã¾ã‚ã‚Šè§£ç¦

    const canUseSpecial = (hasRunner || hasHopper) && SPRITES.sunflower2;

    // â˜… é€£ç¶šå‡ºç¾æ•°ã‚‚è¦‹ãªãŒã‚‰ç‰¹åˆ¥æ ã‚’ä½¿ã†ã‹æ±ºå®š
    let useSpecial =
      !!(canUseSpecial && Math.random() < 0.2 && specialChainCount < MAX_SPECIAL_CHAIN);

    if (useSpecial){
      const baseSize = (70 + Math.random()*20) * SCALE;

      // â˜… ã“ã“ã§ã€Œèµ°ã‚‹ã‹ï¼ã‚¸ãƒ£ãƒ³ãƒ—ã‹ã€ã‚’æ±ºã‚ã‚‹
      // 300ã€œ499 â†’ èµ°ã‚‹ã®ã¿ï¼ˆhasHopper=falseï¼‰
      // 500ã€œ     â†’ èµ°ã‚‹ or ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
      let spawnHop = false;

      if (hasHopper){
        // 500ä»¥ä¸Šãªã‚‰èµ°ã‚‹ / ã‚¸ãƒ£ãƒ³ãƒ—åŠã€…ãã‚‰ã„
        spawnHop = (Math.random() < 0.5);
      }

      // â˜… ç‰¹åˆ¥ã²ã¾ã‚ã‚Šã®ã¨ãã¯ã€Œç›´å‰ã‚¹ã‚­ãƒã€ã‚’ã¡ã‚‡ã„åºƒã‚ã«è¦æ±‚ï¼ˆèµ°ã‚‹ï¼ã‚¸ãƒ£ãƒ³ãƒ—å…±é€šï¼‰
      if (last){
        const baseMinGap    = getMinPixelGap(timeElapsed);
        const specialMinGap = baseMinGap * 1.55; // â† ã‚¸ãƒ£ãƒ³ãƒ—ã²ã¾ã‚ã‚Šã¨åŒã˜å€ç‡

        const gapPx = gameWidth - (last.x + last.width);
        if (gapPx < specialMinGap){
          // ç€åœ°ãƒã‚¤ãƒ³ãƒˆ / èµ°ã‚ŠæŠœã‘ã‚‹ã‚¹ãƒšãƒ¼ã‚¹ãŒè©°ã¾ã‚Šã™ãã¦ãŸã‚‰
          // ä»Šå›ã¯ç‰¹åˆ¥ã²ã¾ã‚ã‚Šã¯ãƒŠã‚· â†’ é€šå¸¸ã²ã¾ã‚ã‚Šã«åˆ‡ã‚Šæ›¿ãˆ
          useSpecial = false;
        }
      }

      if (useSpecial){
        if (spawnHop && hasHopper){
          // ğŸŒ» ã‚¸ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ã²ã¾ã‚ã‚Š
          const size = baseSize * 1.65;
          obstacles.push(
            new SpecialSunflower('sun2_hop', SPRITES.sunflower2, groundY, size)
          );
        } else {
          // ğŸƒâ€â™‚ï¸ èµ°ã‚‹ã²ã¾ã‚ã‚Šï¼ˆ300ã€œã§ã‚‚500ã€œã§ã‚‚å‡ºã‚‹ï¼‰
          const size = baseSize * 1.5;
          obstacles.push(
            new SpecialSunflower('sun2_run', SPRITES.sunflower2, groundY, size)
          );
        }

        // â˜… èµ°ã‚‹ï¼ã‚¸ãƒ£ãƒ³ãƒ—ã©ã£ã¡ã§ã‚‚é€£é–ã‚«ã‚¦ãƒ³ãƒˆ
        specialChainCount++;
        // â˜… ç‰¹åˆ¥ã²ã¾ã‚ã‚Šå‡ºã—ãŸå›ã¯ã€Œæ¬¡ã®å‡ºç¾ã€ã‚’ MAX é–“éš”ã«ã™ã‚‹ï¼ˆå¾Œã‚å´ã®è·é›¢ï¼‰
        forceMaxInterval = true;
      }
    }

    if (!useSpecial){
      // ğŸŒ» æ™®é€šã®ã²ã¾ã‚ã‚Šï¼ˆã“ã‚Œã‚‚å…¨ã‚¹ã‚³ã‚¢å¸¯ã§ãšã£ã¨å‡ºã‚‹ï¼‰
      if (score > 10 && Math.random() < 0.3){
        obstacles.push(
          new Obstacle('ground_large', SPRITES.sunflower, groundY, 120 * SCALE * 1.25)
        );
      } else {
        obstacles.push(
          new Obstacle('ground', SPRITES.sunflower, groundY, (60 + Math.random()*20) * SCALE)
        );
      }
      // â˜… é€šå¸¸ã²ã¾ã‚ã‚ŠãŒå‡ºãŸã‚‰ç‰¹åˆ¥ã²ã¾ã‚ã‚Šé€£é–ã¯ãƒªã‚»ãƒƒãƒˆ
      resetSpecialChain();
    }
  }

  // â˜… ç‰¹åˆ¥ã²ã¾ã‚ã‚Šï¼ˆèµ°ã‚‹/ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ãŒå‡ºãŸå›ã ã‘ã€Œæ¬¡ã®å‡ºç¾ã€ã‚’ MAX é–“éš”ã«ã™ã‚‹
  if (forceMaxInterval){
    nextSpawnInterval = maxSpawnInterval;
  } else {
    nextSpawnInterval =
      minSpawnInterval + Math.random()*(maxSpawnInterval - minSpawnInterval);
  }

  spawnTimer = 0;
}





  
function updateObstacles(d){
  for(let i = obstacles.length - 1; i >= 0; i--){
    obstacles[i].update(d);
    obstacles[i].draw();
    if(obstacles[i].x + obstacles[i].width < 0){
      obstacles.splice(i, 1);
    }
  }
}





// ã“ã“ã‚’è¿½åŠ 
const SCORE_PER_SEC_FOR_WARP = 5; // 6 â†’ 5 ã«è½ã¨ã—ãŸï¼ˆæ—©ãæ„Ÿã˜ã•ã›ãŸã„ãªã‚‰ 4.5 ã¨ã‹ï¼‰

function warpToScoreBand(targetScore){
  score = targetScore;
  scoreEl.textContent = score;

  // ã–ã£ãã‚Šã€Œ1ç§’ã‚ãŸã‚Šã‚¹ã‚³ã‚¢â—¯ãã‚‰ã„ã€æƒ³å®šã§é€†ç®—
  const approxSec = targetScore / SCORE_PER_SEC_FOR_WARP;
  timeElapsed = approxSec * 1000;

  // ã‚²ãƒ¼ãƒ ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚‚ã€ãã®æ™‚é–“å¸¯ã«è¿‘ã„å€¤ã«åˆã‚ã›ã‚‹
  gameSpeed = Math.min(
    baseGameSpeed + approxSec * gameSpeedAcceleration,
    GAME_SPEED_MAX
  );

  // ç”»é¢ä¸Šã®éšœå®³ç‰©ãƒ»ã©ã‚“ãã‚Šãƒ»ãƒ•ã‚­ãƒ€ã‚·ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
  obstacles = [];
  acorns = [];
  floatTexts = [];

  // ã‚¹ãƒãƒ¼ãƒ³é–¢ä¿‚ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ã„å¸¯ã®æ¡ä»¶ã§å‡ºç›´ã—ï¼‰
  spawnTimer = 0;
  nextSpawnInterval = minSpawnIntervalBase + Math.random() * (maxSpawnIntervalBase - minSpawnIntervalBase);

  // ã©ã‚“ãã‚Šã‚¿ã‚¤ãƒãƒ¼ã‚‚ãƒªã‚»ãƒƒãƒˆ
  acornSpawnTimerMs = 0;
  acornNextIntervalMs = nextAcornIntervalMs();
}

  

/* ===== å½“ãŸã‚Šåˆ¤å®š / ã‚¹ã‚³ã‚¢ / é€Ÿåº¦ ===== */
function checkCollision(){
  if (isDebug) return;

  const p = {
    x: player.x,
    y: player.y,
    width:  player.width * 0.6,
    height: player.height * 0.7
  };

  for (const o of obstacles) {
    const h = o.getHitbox();

    if (
      p.x < h.x + h.width &&
      p.x + p.width > h.x &&
      p.y < h.y + h.height &&
      p.y + p.height > h.y
    ) {
      // â˜… ã“ã“ã§ãƒ‡ã‚¹ã‚¿ã‚¤ãƒ—åˆ¤å®š
      if (o.type === 'ground') {
        lastDeathType = 'sunflower_small';
      } else if (o.type === 'ground_large') {
        lastDeathType = 'sunflower_big';
      } else if (o.type === 'air') {
        lastDeathType = 'blueberry';
      } else if (o.type === 'sun2_run') {
        lastDeathType = 'sunflower2_run';
      } else if (o.type === 'sun2_hop') {
        lastDeathType = 'sunflower2_hop';
      } else {
        lastDeathType = 'unknown';
      }

      gameOver();
      return;
    }
  }
}





  
function updateScore(){
  for(const o of obstacles){
    if(!o.passed && o.x+o.width < player.x){
      score++;
      o.passed = true;
    }
  }
  tryCollectAcorns();
  scoreEl.textContent = score;

  // â˜… ã“ã“ã§ã€Œãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ä¸­ã€ã‚’æ¤œçŸ¥ï¼ˆåˆå› highScore=0 ã®ã¨ãã¯ã‚¹ãƒ«ãƒ¼ï¼‰
  if (!isHighScoreRun && highScore > 0 && score > highScore) {
    startHighScoreRun();
  }


  const tSec=timeElapsed/1000;
  gameSpeed=Math.min(baseGameSpeed + tSec*gameSpeedAcceleration, GAME_SPEED_MAX);
}
  

/* ===== çµ‚äº†å‡¦ç†ãªã© ===== */
function buildXIntentUrl(score){ const text=`ã‚€ã‚‹ã ã£ã—ã‚…ï¼ã‚¹ã‚³ã‚¢ã¯ã€Œ${score}ã€ã§ã—ãŸğŸŒ»\nhttps://t4l-ovo-t4l.github.io/murudash/`; return `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`; }


  
function gameOver(){
  if (isGameOver) return;
  isGameOver = true;
  gameStarted = false;

  // â˜…ã‚³ãƒ³ãƒœã‚‚çµ‚äº†
  acornComboCount = 0;

  // â–¼â–¼â–¼ 1. ä½•ã¯ã¨ã‚‚ã‚ã‚ŒBGMã‚’æ­¢ã‚ã‚‹ï¼ˆæœ€å„ªå…ˆãƒ»ã‚¨ãƒ©ãƒ¼ç„¡è¦–ï¼‰ â–¼â–¼â–¼
  try {
    if (highScoreBgmTimeoutId !== null){
      clearTimeout(highScoreBgmTimeoutId);
      highScoreBgmTimeoutId = null;
    }
    stopAllMainBgms();
    try { if (bgm2Audio) { bgm2Audio.pause(); bgm2Audio.currentTime = 0; } } catch(_){}

  } catch(e) { console.error(e); }


  // â–¼â–¼â–¼ 2. ç”»é¢ã‚„ãƒœã‚¿ãƒ³ã®æº–å‚™ â–¼â–¼â–¼
  try {
    if(sendScoreButton){
      sendScoreButton.disabled = false;
      sendScoreButton.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«é€ä¿¡";
      sendScoreButton.classList.remove("bg-gray-500", "opacity-60", "cursor-not-allowed", "bg-blue-900", "cursor-wait");
      sendScoreButton.classList.add("bg-blue-600", "hover:bg-blue-700");
    }

    updateJumpButton(JUMP_MODE.RESTART);

    canRestart = false;
    setRestartCooldownActive(true);
    setTimeout(() => {
      canRestart = true;
      if (isGameOver && jumpButtonMode === JUMP_MODE.RESTART){
        setRestartCooldownActive(false);
      }
    }, RESTART_DELAY_MS);

    // ã‚¹ã‚³ã‚¢è¨ˆç®—
    const isNewHighScore       = score > highScore;
    const hadPreviousHighScore = highScore > 0;

    // ãƒ­ã‚°é€ä¿¡
    logPlaySession(isNewHighScore);

    // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜
    if (isNewHighScore){
      highScore = score;
      localStorage.setItem(HIGH_SCORE_KEY, highScore);
      if(highScoreEl) highScoreEl.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
    }

    // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
    if(finalScoreEl) finalScoreEl.textContent = score;
    if(shareButton) shareButton.href = buildXIntentUrl(score);

    if (gameOverHighScoreLabel){
      if (isHighScoreRun) gameOverHighScoreLabel.classList.remove('hidden');
      else gameOverHighScoreLabel.classList.add('hidden');
    }

    // â–¼â–¼â–¼ 3. æœ€å¾Œã«SEã‚’é³´ã‚‰ã™ï¼ˆã“ã“ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã«ã¯å½±éŸ¿ã•ã›ãªã„ï¼‰ â–¼â–¼â–¼
    // â€» åˆå›ï¼ˆhighScore=0ï¼‰ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã§ã¯ HIGHEND ã‚’é³´ã‚‰ã•ãªã„
    const useHighEnd = isNewHighScore && hadPreviousHighScore;
    if (useHighEnd){
      playSeBuffer('highend', 0.5);
    } else {
      playSeBuffer('end', 0.4);
    }

  } catch (err) {
    console.error("Error in gameOver:", err);
  }

  // â–¼â–¼â–¼ 4. çµ¶å¯¾ã«ç”»é¢ã‚’å‡ºã™ â–¼â–¼â–¼
  if(gameOverScreen){
    gameOverScreen.classList.remove('hidden');
    gameOverScreen.classList.add('flex');
  }
}





  
function restartGame(){

  // â˜… ã¾ãš HIGHEND ã‚’æ­¢ã‚ã‚‹
  stopHighEndSe();

  
  
  // â˜… ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸç¬é–“ã¯ã¾ãŸãƒ­ãƒƒã‚¯
  canRestart = false;
  
// â˜…ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸã‚‰ã‚¹ã‚³ã‚¢é€ä¿¡ãƒœã‚¿ãƒ³ã‚’åˆæœŸåŒ–
sendScoreButton.disabled = false;
sendScoreButton.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«é€ä¿¡";

sendScoreButton.classList.remove(
  "bg-gray-500",
  "opacity-60",
  "cursor-not-allowed"
);

sendScoreButton.classList.add(
  "bg-blue-600",
  "hover:bg-blue-700"
);



  // ã¾ãšä¸¡æ–¹ãã£ã¡ã‚Šæ­¢ã‚ã¦é ­å‡ºã— & ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  if (bgm2Audio){
    try {
      bgm2Audio.pause();
      bgm2Audio.currentTime = 0;
      bgm2Audio.volume = 0.5;
    } catch(_) {}
  }
  if (bgmAudio){
    try {
      bgmAudio.pause();
      bgmAudio.currentTime = 0;
      bgmAudio.volume = 0.5;
    } catch(_) {}
  }

  // â˜… ã“ã“ã§ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒ•ãƒ©ã‚°ã‚’å…ˆã«æŠ˜ã‚‹
  isHighScoreRun = false;

  // ãã®ã†ãˆã§é€šå¸¸BGMã‚¹ã‚¿ãƒ¼ãƒˆ
  startAudio();

  score=0; scoreEl.textContent=score; timeElapsed=0; gameSpeed=baseGameSpeed;
  obstacles=[]; acorns=[]; floatTexts=[]; frame=0; spawnTimer=0;

  // â˜…ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
  acornComboCount = 0;

  
  initStars();
  starAlpha = 0;
  shooting = null;
  acornSpawnTimerMs = 0; acornNextIntervalMs = nextAcornIntervalMs();

  isGameOver=false; isPaused=false; gameStarted=true;
  player.y=groundY-player.height; player.dy=0; player.isGrounded=true; player.jumpsRemaining=2;
    // â˜… ã·ã«ã‚‡ã‚“ã‚¹ã‚±ãƒ¼ãƒ«ã‚‚ãƒªã‚»ãƒƒãƒˆ
  player.scaleX = 1;
  player.scaleY = 1;
  player.squashTimer = 0;
  gameOverScreen.classList.add('hidden'); gameOverScreen.classList.remove('flex'); pauseOverlay.classList.add('hidden');

  // ãƒ—ãƒ¬ã‚¤å†é–‹ãªã®ã§ã€Œã‚¸ãƒ£ãƒ³ãƒ—ã€ï¼ˆé’ï¼‰ã«æˆ»ã™
  updateJumpButton(JUMP_MODE.PLAY);


  
  // â†“ ã“ã“ä»¥é™ã® isHighScoreRun ã‚„ãƒãƒŠãƒ¼é–¢é€£ã®ãƒªã‚»ãƒƒãƒˆã¯ãã®ã¾ã¾ã§OKã‚„ã‘ã©
  //   ã‚‚ã† isHighScoreRun ã¯ false ã«ãªã£ã¦ã‚‹ã®ã§ç¾çŠ¶ã®ã¾ã¾ã§ã‚‚çŸ›ç›¾ã—ãªã„
  // isHighScoreRun = false; â† ã“ã“ã¯ã‚‚ã†ä¸è¦ãªã®ã§æ¶ˆã—ã¦ã‚ˆã—

  if(scoreLabel){
    scoreLabel.classList.remove('text-orange-400');
    scoreLabel.classList.add('text-blue-600');
  }
  if(highScoreBanner){
    highScoreBanner.classList.add('hidden');
  }
  if (gameOverHighScoreLabel){
    gameOverHighScoreLabel.classList.add('hidden');
  }


  applyMute();

  resetAudioSyncState(); isDebug=false; resetDebugTapCounter(); const dbg=document.getElementById('debugBadge'); if(dbg) dbg.remove();
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  lastTime=performance.now(); requestAnimationFrame(gameLoop);
}

function backToTitleFromGameOver(){

  // å¿µã®ãŸã‚é³´ã‚Šã£ã±ãªã—å¯¾ç­–
  stopHighEndSe();

  // å¿µã®ãŸã‚BGM/ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ï¼ˆgameOverã§æ­¢ã‚ã¦ã‚‹ã‘ã©ä¿é™ºï¼‰
  try {
    if (highScoreBgmTimeoutId !== null){
      clearTimeout(highScoreBgmTimeoutId);
      highScoreBgmTimeoutId = null;
    }
    stopAllMainBgms();
    try { if (bgm2Audio) { bgm2Audio.pause(); bgm2Audio.currentTime = 0; } } catch(_){}
  } catch (_) {}

  // çŠ¶æ…‹ã‚’ã€Œã‚¿ã‚¤ãƒˆãƒ«å¾…æ©Ÿã€ã«æˆ»ã™ï¼ˆãƒ—ãƒ¬ã‚¤é–‹å§‹ã¯ã—ãªã„ï¼‰
  isGameOver = false;
  isPaused = false;
  gameStarted = false;

  // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
  if (gameOverScreen){
    gameOverScreen.classList.add('hidden');
    gameOverScreen.classList.remove('flex');
  }
  if (pauseOverlay){
    pauseOverlay.classList.add('hidden');
    pauseOverlay.classList.remove('flex');
  }
  if (rankingOverlay){
    rankingOverlay.classList.add('hidden');
    rankingOverlay.classList.remove('flex');
  }
  if (startScreen){
    startScreen.classList.remove('hidden');
  }

  // è¦‹ãŸç›®ã‚‚æœ€ä½é™ã ã‘åˆæœŸåŒ–ï¼ˆä½™è¨ˆãªä¿å­˜ç³»ã¯è§¦ã‚‰ãªã„ï¼‰
  score = 0;
  if (scoreEl) scoreEl.textContent = score;

  obstacles = [];
  acorns = [];
  floatTexts = [];
  spawnTimer = 0;
  frame = 0;
  timeElapsed = 0;
  gameSpeed = baseGameSpeed;

  acornComboCount = 0;

  // ãƒã‚¤ã‚¹ã‚³ã‚¢æ¼”å‡ºã‚’æˆ»ã™ï¼ˆæ•°å€¤ã¯æ¶ˆã•ãªã„ï¼‰
  isHighScoreRun = false;
  if (scoreLabel){
    scoreLabel.classList.remove('text-orange-400');
    scoreLabel.classList.add('text-blue-600');
  }
  if (highScoreBanner){
    highScoreBanner.classList.add('hidden');
  }
  if (gameOverHighScoreLabel){
    gameOverHighScoreLabel.classList.add('hidden');
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã ã‘æ•´ãˆã‚‹ï¼ˆæç”»ã¯æ¬¡ã®ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«ãƒ«ãƒ¼ãƒ—ã§èµ°ã‚‹ï¼‰
  player.y = groundY - player.height;
  player.dy = 0;
  player.isGrounded = true;
  player.jumpsRemaining = 2;
  player.scaleX = 1;
  player.scaleY = 1;
  player.squashTimer = 0;

  // ç©º/æ˜Ÿã®åˆæœŸçŠ¶æ…‹ã‚‚æˆ»ã™
  resetAudioSyncState();
  initStars();
  starAlpha = 0;
  shooting = null;

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ã€Œã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã€ã«æˆ»ã™
  updateJumpButton(JUMP_MODE.START);

  applyMute();
}

  
function togglePause(){
  if (isGameOver || !gameStarted) return;
  isPaused = !isPaused;

 if (isPaused){
    pauseAllMainBgms();           // â˜…è¿½åŠ ï¼šè‰åŸ/å¤œã‚‚æ­¢ã¾ã‚‹
    try{ bgm2Audio.pause(); }catch(_){}
    pauseOverlay.classList.remove('hidden');
    pauseOverlay.classList.add('flex');
  } else {
      try{
        if (isHighScoreRun){
          if (bgm2Audio.paused) bgm2Audio.play();
        } else {
          const a = getSelectedMainAudio();
          if (a && a.paused) a.play();
        }
      }catch(_){}
    pauseOverlay.classList.add('hidden'); pauseOverlay.classList.remove('flex');
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
}





function openCredits(e){
  if (e) e.preventDefault();

  bootAudioOnce();
  
  creditsOverlay.classList.remove('hidden');
  creditsOverlay.classList.add('flex');

  // â˜… ä»¥å‰ã®ã€ŒThank Youã€ã‚’éš ã™
  if (creditsEndMessage) {
    creditsEndMessage.classList.add('hidden');
  }

  // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¢ãƒ‹ãƒ¡ã‚’ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  creditsScroll.classList.remove('credits-scroll');
  void creditsScroll.offsetWidth;
  creditsScroll.classList.add('credits-scroll');

  pauseAllMainBgms();             // â˜…ç½®ãæ›ãˆ
  try{ bgm2Audio.pause(); }catch(_){}
  playCreditsBgm();

  // â˜… ä¸€å®šæ™‚é–“å¾Œã«ã€ŒThank Youã€è¡¨ç¤º
  scheduleCreditsEndMessage();

  updateJumpButton(JUMP_MODE.CREDITS);
}





function closeCredits(e){
  if (e) e.preventDefault();
  creditsOverlay.classList.add('hidden');
  creditsOverlay.classList.remove('flex');
  stopCreditsBgm();

  // â˜… ã‚µãƒ³ã‚­ãƒ¥ãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
  if (creditsEndMessage) {
    creditsEndMessage.classList.add('hidden');
  }
  if (creditsEndTimer) {
    clearTimeout(creditsEndTimer);
    creditsEndTimer = null;
  }

  // â˜… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆé–‰ã˜ãŸã‚‰ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã®å½¹å‰²ã‚’æˆ»ã™
  if (isGameOver){
    updateJumpButton(JUMP_MODE.RESTART);
  } else if (!gameStarted){
    updateJumpButton(JUMP_MODE.START);
  } else {
    updateJumpButton(JUMP_MODE.PLAY);
  }

  if (gameStarted && !isGameOver && !isPaused){
  try{
    if (isHighScoreRun){
      if (bgm2Audio.paused) bgm2Audio.play();
    } else {
      const a = getSelectedMainAudio();
      if (a && a.paused) a.play();
    }
  }catch(_){}
}

}





  

// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ãƒœã‚¿ãƒ³
if (creditsButton){
  creditsButton.addEventListener('pointerdown', openCredits, { passive: false });
}





  
/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function gameLoop(ts){
  if (isGameOver || isPaused || !gameStarted) return;

  const dt = ts - lastTime; 
  lastTime = ts;

  // â˜… dfã‚¯ãƒ©ãƒ³ãƒ—ï¼šä¸€ç¬ã®ã‚¹ãƒ‘ã‚¤ã‚¯å¸åï¼ˆä½“æ„Ÿã‚«ã‚¯ã¤ãæ¿€æ¸›ï¼‰
  const df = Math.max(0.5, Math.min(1.8, dt / (1000/60)));

  timeElapsed += dt;

  
  // BGM.currentTime ã˜ã‚ƒãªãã¦ã€çµŒéæ™‚é–“ãƒ™ãƒ¼ã‚¹ã§ç©ºã‚’æ›´æ–°
  updateSkyByTimeline();

  // èƒŒæ™¯ï¼†é›²
  ctx.clearRect(0,0,gameWidth,gameHeight);
  drawSky(df); 
  drawStars(df); 
  drawClouds(df);

  // åœ°é¢ï¼‹æµã‚Œã‚‹ç ‚åˆ©ï¼ˆéšœå®³ç‰©ã¨åŒé€Ÿã§æµã™ï¼‰
  drawGround(); drawGroundDetails(df);

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼éšœå®³ç‰©ï¼ã©ã‚“ãã‚Š
  updatePlayer(df); drawPlayer();
  spawnObstacle(df); updateObstacles(df);
  spawnAcornMs(dt); updateAcorns(df);

  // â˜… ã©ã‚“ãã‚Šã®ã€Œ+10ã€ã¿ãŸã„ãªãƒ•ã‚­ãƒ€ã‚·æç”»
  for (let i = floatTexts.length - 1; i >= 0; i--) {
    const ft = floatTexts[i];

    // ãµã‚ã£ã¨ä¸Šã«ç§»å‹•
    ft.y += ft.vy * df;
    ft.life -= df;

    // æ®‹ã‚Šå¯¿å‘½ã«å¿œã˜ã¦ã ã‚“ã ã‚“é€æ˜ã«
    const alpha = Math.max(0, Math.min(1, ft.life / 30));

    const color    = ft.color    || '#fff7aa';
    const stroke   = ft.stroke   || 'rgba(0,0,0,0.75)';
    const fontSize = ft.fontSize || 20;

    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.font = `bold ${fontSize}px "Inter", system-ui, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    ctx.strokeStyle = stroke;
    ctx.lineWidth = 3;
    ctx.fillStyle = color;

    ctx.strokeText(ft.text, ft.x, ft.y);
    ctx.fillText(ft.text, ft.x, ft.y);
    ctx.restore();

    // å¯¿å‘½ãŒå°½ããŸã‚‰æ¶ˆã™
    if (ft.life <= 0) {
      floatTexts.splice(i, 1);
    }
  }


  
  // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢çªå…¥ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if (flashTimer > 0) {
    const alpha = (flashTimer / FLASH_DURATION) * 0.85; // æœ€å¤§0.85ãã‚‰ã„ã¾ã§å…‰ã‚‹
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.fillRect(0, 0, gameWidth, gameHeight);

    flashTimer -= df;          // æ™‚é–“çµŒéã§æ¸›ã‚‰ã™ï¼ˆdfã¯ã ã„ãŸã„1/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    if (flashTimer < 0) flashTimer = 0;
  }

  
  checkCollision(); updateScore();

  frame++; requestAnimationFrame(gameLoop);
}

/* ===== å…¥åŠ› ===== */
window.addEventListener('keydown', e=>{
  if (e.repeat) return;

  // â˜… ãƒãƒ¼ã‚ºä¸­ã®æŒ™å‹•
  if (isPaused){
    // â‘  ç„¡æ•µãƒ¢ãƒ¼ãƒ‰ãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹ã®ã¨ãã ã‘ï¼‰
    if (DEBUG_OPTIONS.invincibleMode &&
        (e.code === 'Space' || e.code === 'ArrowUp')){
      debugTapCount++;
      if (debugTapCount >= DEBUG_TAPS_TO_ENABLE){
        enableDebugMode();
        resetDebugTapCounter();
      }
      return;
    }

    // ã‚²ãƒ¼ãƒ å§‹ã¾ã£ã¦ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (!gameStarted) return;

    // â‘¡ ãƒãƒ¼ã‚ºä¸­ã« 3 / 5 ã§ã‚¹ã‚³ã‚¢å¸¯ãƒ¯ãƒ¼ãƒ—ï¼ˆPCç”¨ï¼‰
    if (DEBUG_OPTIONS.warpPC && e.code === 'Digit3'){
      warpToScoreBand(300);
      console.log('DEBUG: warp to score 300 band');
      return;
    }
    if (DEBUG_OPTIONS.warpPC && e.code === 'Digit5'){
      warpToScoreBand(500);
      console.log('DEBUG: warp to score 500 band');
      return;
    }

    return;
  }

  // â˜… ãƒãƒ¼ã‚ºã—ã¦ãªã„é€šå¸¸æ™‚
  if (!gameStarted) return;

  if (e.code === 'Space' || e.code === 'ArrowUp') playerJump();
  if (e.code === 'KeyP') togglePause();
});


window.addEventListener('keyup', e=>{
  if (e.code === 'Space' || e.code === 'ArrowUp') stopJump();
});

jumpButton.addEventListener('pointerdown', e=>{
  e.preventDefault();

  if (jumpButtonMode === JUMP_MODE.SHOP){
    closeShop();
    return;
  }

  
  // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºä¸­ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã§é–‰ã˜ã‚‹
  if (jumpButtonMode === JUMP_MODE.RANKING){
    closeRankingOverlay();
    return;
  }
  // â˜… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè¡¨ç¤ºä¸­ï¼šã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ï¼ã€Œã¨ã˜ã‚‹ã€
  if (jumpButtonMode === JUMP_MODE.CREDITS){
    closeCredits();
    return;
  }

  // â˜… ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ãªã‚‰ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  if (isGameOver) {

    // ã¾ã ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ä¸­ â†’ ä½•ã‚‚ã—ãªã„ï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼‰
    if (!canRestart) return;

    restartGame();
    return;
  }

  // ã¾ã ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ã¦ã„ãªã„ï¼ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ä¸­ãªã‚‰ã€Œã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã€ã¨ã—ã¦å‹•ã
  if (!gameStarted) {
    handleGameStart();  // e ãªã—ã§å‘¼ã‚“ã§OKãªã‚ˆã†ã«ã—ã¦ã‚ã‚‹
    return;
  }

  // ãƒãƒ¼ã‚ºä¸­ï¼šç„¡æ•µãƒ¢ãƒ¼ãƒ‰ãƒˆãƒªã‚¬ãƒ¼ï¼ˆæœ‰åŠ¹ãªã¨ãã ã‘ï¼‰
  if (isPaused){
    if (DEBUG_OPTIONS.invincibleMode){
      debugTapCount++;
      if (debugTapCount >= DEBUG_TAPS_TO_ENABLE){
        enableDebugMode();
        resetDebugTapCounter();
      }
    }
    return;
  }


  // é€šå¸¸ãƒ—ãƒ¬ã‚¤ä¸­ã¯ã‚¸ãƒ£ãƒ³ãƒ—
  playerJump();
});



jumpButton.addEventListener('pointerup',   e=>{ e.preventDefault(); stopJump(); });
pauseButton.addEventListener('pointerdown', e => {
  e.preventDefault();
  togglePause();
});


function openShop(e){
  if (e) e.preventDefault();
  if (!shopOverlay) return;

  renderShop();
  shopOverlay.classList.remove('hidden');
  shopOverlay.classList.add('flex');

  updateJumpButton(JUMP_MODE.SHOP);
}

async function closeShop(e){
  if (e) e.preventDefault();

  // ã“ã“ã§ã€Œé¸æŠBGMãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰ãƒ­ãƒ¼ãƒ‰ã€ã—ã¦ã‹ã‚‰é–‰ã˜ã‚‹
  const id = getSelectedBgmId();
  const needLoad = (id !== 'default') && (
    (id === 'sougen' && !bgmSougenAudio) ||
    (id === 'yoru'   && !bgmYoruAudio)
  );

  if (needLoad){
    showLoadingOverlay(true);
    try{
      await preloadSelectableBgm(id);
    }catch(err){
      console.error(err);
      alert('BGMã®ãƒ­ãƒ¼ãƒ‰å¤±æ•—ã—ãŸã‚€ã‚‹â€¦ ã„ã£ãŸã‚“ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™ã‚€ã‚‹');
      setSelectedBgmId('default');
    } finally {
      showLoadingOverlay(false);
    }
  }

  if (!shopOverlay) return;
  shopOverlay.classList.add('hidden');
  shopOverlay.classList.remove('flex');

  // ã‚¿ã‚¤ãƒˆãƒ«ä¸­ãªã®ã§ START ã«æˆ»ã™
  if (!gameStarted) updateJumpButton(JUMP_MODE.START);
  else updateJumpButton(JUMP_MODE.PLAY);
}

function renderShop(){
  if (!shopContent) return;

  const ac = totalAcorns || 0;
  if (shopAcornTotalEl) shopAcornTotalEl.textContent = String(ac);

  const selected = getSelectedBgmId();

  const row = (html) => `<div class="p-3 rounded-lg bg-gray-800/70 border border-gray-700">${html}</div>`;

  function bgmItem(id){
    const meta = BGM_META[id];
    const unlocked = ac >= meta.unlockedAt;
    const isSelected = (selected === id);

    const statusText  = unlocked ? (isSelected ? 'é¸æŠä¸­' : 'è§£æ”¾æ¸ˆã¿') : 'æœªè§£æ”¾';
    const statusClass = unlocked
      ? (isSelected ? 'text-emerald-300' : 'text-gray-300')
      : 'text-gray-400';

    const btnClass = unlocked
      ? (isSelected
        ? 'bg-emerald-700 hover:bg-emerald-800 border-emerald-300'
        : 'bg-gray-700 hover:bg-gray-800 border-gray-500')
      : 'bg-gray-900/60 border-gray-700 opacity-60 cursor-not-allowed';

    const sub = unlocked
      ? (isSelected ? 'ã‚‚ã†ä¸€å›æŠ¼ã™ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã‚‹ã‚€ã‚‹' : 'æŠ¼ã™ã¨ã“ã®BGMã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‚€ã‚‹')
      : `å¿…è¦ã©ã‚“ãã‚Šï¼š${meta.unlockedAt}`;

    return row(`
      <button class="w-full text-left px-4 py-3 rounded-lg border ${btnClass}"
        data-bgm="${id}" ${unlocked ? '' : 'disabled'}>
        <div class="flex items-center justify-between">
          <div class="font-bold">${meta.label}</div>
          <div class="text-xs ${statusClass}">${statusText}</div>
        </div>
        <div class="text-xs text-gray-300 mt-1">${sub}</div>
      </button>
    `);
  }

  const comingRow = (need) => row(`
    <div class="flex items-center justify-between">
      <div>
        <div class="font-bold">æº–å‚™ä¸­</div>
        <div class="text-xs text-gray-300">å¿…è¦ã©ã‚“ãã‚Šï¼š${need}</div>
      </div>
      <div class="text-sm text-gray-400">æº–å‚™ä¸­</div>
    </div>
  `);

  shopContent.innerHTML = [
    bgmItem('sougen'),
    bgmItem('yoru'),
    comingRow(500),
    comingRow(1000),
  ].join('\n');

  // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆãƒˆã‚°ãƒ«ï¼‰
  shopContent.querySelectorAll('button[data-bgm]').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-bgm');
      if (!id) return;

      if (getSelectedBgmId() === id) setSelectedBgmId('default');
      else setSelectedBgmId(id);
    });
  });
}



if (shopButton) shopButton.addEventListener('click', openShop);
if (closeShopButton) closeShopButton.addEventListener('click', closeShop);



  

function handleGameStart(e){

  
  if (e) e.preventDefault();   // â† e ãŒãªã„ã¨ãã‚‚è½ã¡ãªã„ã‚ˆã†ã«

  if(gameStarted) return;
  gameStarted = true;

  // ãƒ—ãƒ¬ã‚¤ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼ˆé’ & ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
  updateJumpButton(JUMP_MODE.PLAY);


  startAudio();
  startScreen.classList.add('hidden');
  resetAudioSyncState();
  isDebug = false;
  resetDebugTapCounter();
  const dbg = document.getElementById('debugBadge');
  if(dbg) dbg.remove();

  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  spawnTimer = 0;
}


  

</script>
</body>
</html>
