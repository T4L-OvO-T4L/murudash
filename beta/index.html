<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; media-src 'self';">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link rel="preload" as="image" href="../assets/blueberry.svg">
<link rel="preload" as="image" href="../assets/sunflower.svg">
<link rel="preload" as="image" href="../assets/Donguri.svg">
<link rel="preload" as="audio" href="../assets/BGM.mp3">
<link rel="preload" as="audio" href="../assets/END.mp3">
<link rel="preload" as="audio" href="../assets/pick.mp3">
<link rel="preload" as="audio" href="../assets/CREDIT.mp3">
<link rel="preload" as="audio" href="../assets/BGM2.mp3">
<link rel="preload" as="audio" href="../assets/SE.mp3">




<!-- ğŸŒ»ğŸŒ»ğŸŒ» è¿½åŠ ã²ã¾ã‚ã‚Š ğŸŒ»ğŸŒ»ğŸŒ» -->
<link rel="preload" as="image" href="../assets/sunflower2.png">
  
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ã‚€ã‚‹ã ã£ã—ã‚…ï¼</title>
  
<!-- ğŸŒ» ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ï¼ˆã²ã¾ã‚ã‚ŠSVGï¼‰â€»ãƒ™ãƒ¼ã‚¿ã‹ã‚‰è¦‹ã¦ä¸€å€‹ä¸Šã® assets -->
<link rel="icon" type="image/svg+xml" href="../assets/sunflower.svg">

<!-- ğŸªª OGP / Twitterã‚«ãƒ¼ãƒ‰ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆã¨ã—ã¦ã‚·ã‚§ã‚¢ã•ã‚Œã‚‹æƒ³å®šï¼‰ -->
<meta property="og:title" content="ã‚€ã‚‹ã ã£ã—ã‚…ï¼Î²ç‰ˆ">
<meta property="og:description" content="è¿«ã‚Šãã‚‹ã²ã¾ã‚ã‚Šã‚„ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ã‚’ã‚ˆã‘ã¾ãã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ãƒ³ã‚²ãƒ¼ãƒ ï¼ˆãƒ™ãƒ¼ã‚¿ç‰ˆï¼‰ã€‚">
<meta property="og:type" content="website">

<!-- ãƒ™ãƒ¼ã‚¿ç‰ˆã®URL -->
<meta property="og:url" content="https://t4l-ovo-t4l.github.io/murudash/beta/">

<!-- OGPç”»åƒï¼ˆassets/OGP.png ã«ç½®ãå ´åˆï¼‰ -->
<meta property="og:image" content="https://t4l-ovo-t4l.github.io/murudash/assets/OGP.png">

<meta property="og:site_name" content="ã‚€ã‚‹ã ã£ã—ã‚…ï¼">
<meta name="twitter:card" content="summary_large_image">



  
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  body { font-family:'Inter',sans-serif; touch-action:manipulation; overflow:hidden; overscroll-behavior:none; background:#1a202c; }
  
  canvas {
    display: block;
    width: 100%;   /* è¦ªè¦ç´ ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ */
    height: auto;  /* ç¸¦æ¨ªæ¯”ã¯ 768x300 ã®ã¾ã¾ç¶­æŒ */
  }

  .control-button { transition: background-color .1s, transform .1s; }
  .control-button:active { transform: scale(.95); background:#2c5282; }
  .pause-button { transition: background-color .1s, transform .1s; }
  .pause-button:active { transform: scale(.95); }
  .icon-inline { display:inline-block; width:1.15em; height:1.15em; vertical-align:-0.18em; margin-left:.25em; }
  .no-select { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
  .no-highlight { -webkit-tap-highlight-color:transparent; }

    /* å…¨é¢é¸æŠä¸å¯ï¼ˆå­å­«ã”ã¨ï¼‰ï¼†iOSé•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç„¡åŠ¹ */
  .no-select, .no-select * {
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
  /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚„ç”»åƒã€ãƒœã‚¿ãƒ³ã€ãƒªãƒ³ã‚¯ã‚‚å€‹åˆ¥ã«ã‚±ã‚¢ */
  canvas, img, button, a {
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

    @keyframes credits-scroll {
    0% { transform: translateY(0%); }
    100% { transform: translateY(-110%); }
  }

  .credits-scroll {
    animation: credits-scroll 60s linear;
  }


.rainbow-text {
  /* ãƒ‰åŸè‰²ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ï¼ˆå½©åº¦é«˜ã‚ï¼‰ */
  background: linear-gradient(
    90deg,
    #ff0000,
    #ff7a00,
    #fff500,
    #00ff00,
    #00f5ff,
    #0040ff,
    #c300ff,
    #ff0000
  );
  background-size: 320% 320%;
  background-position: 0% 50%;
  background-repeat: no-repeat;

  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  -webkit-text-fill-color: transparent;


text-shadow:
  0 0 2px rgba(255, 255, 255, 0.20),
  0 0 6px rgba(255, 255, 255, 0.12);


  /* å¾€å¾©ã‚¢ãƒ‹ãƒ¡ã§ã‚¬ã‚¯ã£ã¨ã—ãªã„ã‚ˆã†ã« */
  animation: rainbow-slide 3s linear infinite alternate;
}

@keyframes rainbow-slide {
  from { background-position: 0% 50%; }
  to   { background-position: 100% 50%; }
}




</style>
</head>

<body class="bg-gray-800 flex flex-col items-center justify-start min-h-screen pt-3 sm:pt-4 pb-28 no-select no-highlight">

  
<!-- æ³¨è¨˜ -->
<div class="w-full text-center bg-gray-900 text-gray-300 text-[11px] py-1 shadow-md">
  â€»æœ¬ä½œå“ã¯ <a href="https://kuronekotsuki.booth.pm/items/4672957" target="_blank" rel="noopener noreferrer" class="underline hover:text-white transition">ï½¢ãƒ ãƒ«ãƒ«ï½£</a> ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ä½œå“ã§ã™ã€‚<br class="sm:hidden">
  æ¨©åˆ©è€…æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
  â€»éŸ³ãŒå‡ºã¾ã™ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ768pxãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
<div class="w-full max-w-[768px] p-3 bg-white rounded-t-lg shadow-md">
  <div class="flex items-center justify-between gap-3">
    <div class="text-left">
      
      <span id="scoreLabel" class="text-xl sm:text-2xl font-bold text-blue-600">
        ã‚¹ã‚³ã‚¢: <span id="score" class="inline-block min-w-[60px] text-right font-mono">0</span>
      </span>

    </div>
    <div class="flex items-center gap-3 shrink-0">
      <span id="highScore" class="text-xs text-gray-500 block">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>

        <!-- ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³è¿½åŠ  -->
      <button
        id="muteButton"
        class="px-2 py-2 bg-gray-700 text-white rounded-lg text-xs sm:text-sm shadow-md"
      >
        ğŸ”Š
      </button>

      <button id="pauseButton" class="pause-button px-3 py-2 sm:px-4 sm:py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">
        ã¡ã‚‡ã£ã¡ä¼‘æ†©
      </button>
    </div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="relative w-full max-w-[768px] mt-2">
  <canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>

  <div
    id="highScoreBanner"
    class="pointer-events-none absolute top-4 left-1/2 -translate-x-1/2
           px-4 py-2 text-xl sm:text-2xl font-extrabold tracking-wide
           hidden rainbow-text whitespace-nowrap"
  >
    ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ä¸­ã‚€ã‚‹ï½ï¼
  </div>




  
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center flex">
    <h2 class="text-5xl font-bold mb-6">ã‚€ã‚‹ã ã£ã—ã‚…ï¼</h2>
    <p class="text-lg mb-4">ãƒœã‚¿ãƒ³ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼<br class="sm:hidden">ç©ºä¸­ã§ã‚‚ã†ä¸€å›ã§2æ®µã‚¸ãƒ£ãƒ³ãƒ—ï¼</p>
    <p class="text-lg mb-8">éšœå®³ç‰©ã‚’ã‚ˆã‘ã¾ãã‚ã†ï¼</p>
    
  <!-- æ—§ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã¨çµ±åˆã®ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ 
    <button id="startButton" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-2xl hover:bg-green-700 transition-colors">
      ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
    </button>
  -->
    
        <button id="creditsButton" class="mt-4 px-5 py-2 border border-gray-300 text-sm rounded-lg bg-black/40 hover:bg-black/60 transition-colors">
      ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
    </button>

  </div>

  <!-- ãƒãƒ¼ã‚º -->
  <div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center hidden">
    <h2 class="text-4xl font-bold mb-4">ä¸€æ™‚åœæ­¢ä¸­</h2>
    <p class="text-xl">(ã€Œã¡ã‚‡ã£ã¡ä¼‘æ†©ã€ãƒœã‚¿ãƒ³ã§å†é–‹)</p>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ -->
  <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-lg text-white p-8 text-center hidden">
    <h2 class="text-4xl font-bold mb-2">ãŒã‚ãŠã¹ã‚‰</h2>

  <!-- â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°è¡¨ç¤º -->
    <p id="gameOverHighScoreLabel"
       class="text-lg mb-2 text-yellow-300 font-bold hidden">
      ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ï¼
    </p>
    
    <p class="text-xl mb-6">ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
    <div class="flex flex-wrap justify-center gap-3">
      <button id="restartButton" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-xl hover:bg-blue-700 transition-colors">
        ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
      </button>
      <a id="shareButton" href="#" target="_blank" rel="noopener noreferrer" class="px-8 py-4 bg-black text-white font-bold rounded-lg shadow-lg text-xl hover:bg-gray-900 transition-colors">
        Xã§ã‚¹ã‚³ã‚¢ã‚’ã‚·ã‚§ã‚¢
      </a>
    </div>
  </div>





  
<!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼ˆã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ï¼ã‚²ãƒ¼ãƒ ç”»é¢ãƒ•ãƒ«ï¼‰ -->
<div id="creditsOverlay" class="absolute inset-0 bg-black bg-opacity-90 rounded-b-lg text-white hidden">
  <div class="relative w-full h-full overflow-hidden">

    <!-- å¤–å´ï¼šä½ç½®ã ã‘æ‹…å½“ï¼ˆXæ–¹å‘ã‚»ãƒ³ã‚¿ãƒªãƒ³ã‚°ï¼‰ -->
    <div
      id="creditsScrollOuter"
      class="absolute left-1/2 -translate-x-1/2 w-full max-w-[720px] text-white"
    >

      <!-- å†…å´ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ‹…å½“ï¼ˆYæ–¹å‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ -->
      <div id="creditsScroll" class="credits-scroll">
        <div class="relative mx-auto max-w-[720px] px-4 text-white">
      
          <!-- ğŸ“ çœŸã‚“ä¸­ï¼šã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ†ã‚­ã‚¹ãƒˆ -->
          <div class="text-center space-y-3 text-sm sm:text-base leading-relaxed">
            <p class="text-3xl font-bold mb-6">ã‚€ã‚‹ã ã£ã—ã‚…ï¼ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</p>
      
            <p class="text-lg font-semibold mt-2">ä¼ç”»ãƒ»åˆ¶ä½œ</p>
            <p>ãŸã‚‹ï¼ˆX: @T4L_OvO_ï¼‰</p>
      
            <p class="text-lg font-semibold mt-6">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ / ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯</p>
            <p>Muru.pngï¼ˆãƒ ãƒ«ãƒ«ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸã‚ªãƒªã‚¸ãƒŠãƒ«æãä¸‹ã‚ã—ï¼‰</p>
      
            <p class="text-lg font-semibold mt-6">ã‚µã‚¦ãƒ³ãƒ‰</p>
            <p>BGMï¼šè‡ªä½œã‚ªãƒªã‚¸ãƒŠãƒ«BGM</p>
            <p>åŠ¹æœéŸ³ï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰ï¼šåŠ¹æœéŸ³ãƒ©ãƒœ</p>
            <p>åŠ¹æœéŸ³ï¼ˆã©ã‚“ãã‚Šæ‹¾å¾—ï¼‰ï¼šåŠ¹æœéŸ³ãƒ©ãƒœ</p>
      
            <p class="text-lg font-semibold mt-6">ç”»åƒç´ æ</p>
            <p>ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ï¼šTwemojiï¼ˆCC BY 4.0ï¼‰</p>
            <p>ã²ã¾ã‚ã‚Šï¼šã‚¤ãƒ©ã‚¹ãƒˆACï¼ˆAI â†’ SVG å¤‰æ›ï¼‰</p>
            <p>ã©ã‚“ãã‚Šï¼šã‚¤ãƒ©ã‚¹ãƒˆACï¼ˆAI â†’ SVG å¤‰æ›ï¼‰</p>
      
            <p class="text-lg font-semibold mt-6">æŠ€è¡“</p>
            <p>HTML5 / JavaScriptï¼ˆVanillaï¼‰</p>
            <p>Tailwind CSS</p>
            <p>GitHub Pages</p>
      
            <p class="text-lg font-semibold mt-6">Special Thanks</p>
            <p>ãƒ ãƒ«ãƒ« Mururuã€ã‚ªãƒªã‚¸ãƒŠãƒ«3Dãƒ¢ãƒ‡ãƒ«ã€‘</p>
      
            <p class="mt-10 text-xs text-gray-300">
              â€»æœ¬ä½œå“ã¯ã€Œãƒ ãƒ«ãƒ«ã€ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ä½œå“ã§ã™ã€‚æ¨©åˆ©è€…æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
          </div>
      
          <!-- ğŸ¨ é£¾ã‚Šã‚¤ãƒ©ã‚¹ãƒˆï¼ˆPCã ã‘è¡¨ç¤ºï¼‰ -->
          <!-- â‘  ã¡ã‚‡ã„ä¸Šã®æ–¹ãƒ»å³ã«è‡ªæ©Ÿ -->
          <img
            src="../assets/Muru.png"
            alt="Muru"
            class="hidden sm:block absolute right-2 top-16 w-24 opacity-80"
          >
      
          <!-- â‘¡ ãã®ã ã„ã¶ä¸‹ãƒ»å·¦ã«ã²ã¾ã‚ã‚Š -->
          <img
            src="../assets/sunflower.svg"
            alt="sunflower"
            class="hidden sm:block absolute left-2 top-[260px] w-16 h-16 opacity-80"
          >
      
          <!-- â‘¢ ã•ã‚‰ã«ä¸‹ãƒ»å³ã«ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ -->
          <img
            src="../assets/blueberry.svg"
            alt="blueberry"
            class="hidden sm:block absolute right-6 top-[440px] w-14 h-14 opacity-80"
          >
      
        </div>
      </div><!-- /#creditsScroll -->
    </div><!-- /#creditsScrollOuter -->

    <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼šç”»é¢ä¸‹ã«å›ºå®š -->
    <button
      id="closeCreditsButton"
      class="absolute bottom-4 left-1/2 -translate-x-1/2 px-6 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-bold"
    >
      ã¨ã˜ã‚‹
    </button>
  </div><!-- /.relative -->
</div><!-- /#creditsOverlay -->

</div><!-- â˜… ã“ã‚Œï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã® outer relative ã‚’é–‰ã˜ã‚‹ -->


  

<!-- ãƒ«ãƒ¼ãƒ«ï¼ˆä¸­å¤®æƒãˆï¼‰ -->
<div class="w-full max-w-[768px] text-gray-200 text-sm mt-3 mb-20 px-1 leading-relaxed text-center no-select no-highlight">
  <p class="mb-1">
    ã²ã¾ã‚ã‚Š<img src="../assets/sunflower.svg" alt="sunflower" class="icon-inline">
    ã‚„ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼<img src="../assets/blueberry.svg" alt="blueberry" class="icon-inline">
    ã‚’<br class="sm:hidden"/>é¿ã‘ãªãŒã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ãã†ï¼
  </p>
  <p>
    ãŸã¾ã«è½ã¡ã¦ã‚‹ã©ã‚“ãã‚Š<img src="../assets/Donguri.svg" alt="donguri" class="icon-inline">
    ã¯æ‹¾ã„ãŸã„ã‚€ã‚‹ã­
  </p>

    <!-- â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå³ä¸‹ã«ã¡ã‚‡ã“ã£ã¨ï¼‰ -->
  <p class="mt-2 text-[10px] text-gray-400 text-right pr-2 sm:text-xs">
    version <span id="versionLabel"></span>
  </p>


</div>

<!-- ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
<div class="w-full max-w-[768px] flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2 no-select no-highlight">
  <button id="jumpButton" class="control-button w-full py-12 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-2xl no-select" draggable="false">
    ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
  </button>
</div>

<script>
  // iOSã®é•·æŠ¼ã—é¸æŠãƒ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼æŠ‘æ­¢ï¼ˆãƒœã‚¿ãƒ³æ“ä½œã¯ãã®ã¾ã¾ï¼‰
document.addEventListener('selectstart', e => e.preventDefault());
document.addEventListener('contextmenu', e => e.preventDefault(), { passive: false });


// â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… ã‚²ãƒ¼ãƒ ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆã“ã“ã ã‘å¤‰ãˆãŸã‚‰OKï¼‰â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
const GAME_VERSION = '1.1';

  
/* ===== åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const gameOverScreen = document.getElementById('gameOverScreen');

const scoreLabel = document.getElementById('scoreLabel');
const highScoreBanner = document.getElementById('highScoreBanner');

const finalScoreEl = document.getElementById('finalScore');
const restartButton = document.getElementById('restartButton');
const shareButton = document.getElementById('shareButton');
const jumpButton = document.getElementById('jumpButton');
  jumpButton.textContent = 'ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ';
const pauseButton = document.getElementById('pauseButton');
const pauseOverlay = document.getElementById('pauseOverlay');

const gameOverHighScoreLabel = document.getElementById('gameOverHighScoreLabel');
  
const startScreen = document.getElementById('startScreen');
// const startButton = document.getElementById('startButton'); â†å‰Šé™¤

const muteButton = document.getElementById('muteButton');
  
  const creditsOverlay = document.getElementById('creditsOverlay');
const creditsButton = document.getElementById('creditsButton');
const closeCreditsButton = document.getElementById('closeCreditsButton');
const creditsScroll = document.getElementById('creditsScroll');

const versionLabel = document.getElementById('versionLabel');
if (versionLabel) {
  versionLabel.textContent = `v${GAME_VERSION}`;
}


  // ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆé–¢é€£
let isMuted = false;

function applyMuteVolumes() {
  const globalMute = isMuted;

  // â˜… BGM1ï¼ˆé€šå¸¸BGMï¼‰
  if (bgmAudio) {
    // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸­ã¯å¼·åˆ¶çš„ã«å‡ºåŠ›ãƒŸãƒ¥ãƒ¼ãƒˆ
    bgmAudio.muted = globalMute || isHighScoreRun;
    bgmAudio.volume = 0.5; // åŸºæº–å€¤ã ã‘å…¥ã‚Œã¦ãŠãï¼ˆå®Ÿéš›ã®ãƒŸãƒ¥ãƒ¼ãƒˆã¯ muted ã§ã‚„ã‚‹ï¼‰
  }

  // â˜… BGM2ï¼ˆãƒã‚¤ã‚¹ã‚³ã‚¢ç”¨ï¼‰
  if (bgm2Audio) {
    bgm2Audio.muted = globalMute;
    bgm2Audio.volume = 0.5;
  }

  // â˜… ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼SE
  if (endAudio) {
    endAudio.muted = globalMute;
    endAudio.volume = 0.5;
  }

  // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢é”æˆSE
  if (highScoreSeAudio) {
    highScoreSeAudio.muted = globalMute;
    highScoreSeAudio.volume = 0.3;
  }

  // â˜… ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆBGM
  if (creditsAudio) {
    creditsAudio.muted = globalMute;
    creditsAudio.volume = 0.5;
  }

  // â˜… ã©ã‚“ãã‚Šæ‹¾ã£ãŸã¨ãã®SE
  pickupPool.forEach(a => {
    a.muted = globalMute;
    a.volume = 1.0;
  });

  // ãƒœã‚¿ãƒ³è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
  if (muteButton) {
    muteButton.textContent = globalMute ? 'ğŸ”‡' : 'ğŸ”Š';
  }
}



  

function loadImg(src){ const img=new Image(); img.src=src; return img; }
const SPRITES={
  blueberry: loadImg('../assets/blueberry.svg'),
  sunflower: loadImg('../assets/sunflower.svg'),
  donguri:  loadImg('../assets/Donguri.svg'),
    // â˜… è¿½åŠ ï¼šå‹•ãã²ã¾ã‚ã‚Š
  sunflower2: loadImg('../assets/sunflower2.png')
};

/* ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ===== */
let audioStarted = false;
let bgmAudio, bgm2Audio, endAudio, highScoreSeAudio;
// ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå°‚ç”¨BGM
let creditsAudio = null;

let pickupPool = [];
let pickupIndex = 0;


  function fadeAudio(audio, targetVolume, durationMs, onEnd){
      if (!audio) {
        if (onEnd) onEnd();
        return;
      }
    
      const startVolume = audio.volume;
      const startTime = performance.now();
    
      function step(now){
        const t = Math.min(1, (now - startTime) / durationMs);
        audio.volume = startVolume + (targetVolume - startVolume) * t;
    
        if (t < 1) {
          requestAnimationFrame(step);
        } else {
          audio.volume = targetVolume;
          if (onEnd) onEnd();
        }
      }
    
      requestAnimationFrame(step);
    }

    
    function fadeOutAudio(audio, durationMs, onEnd){
      fadeAudio(audio, 0, durationMs, onEnd);
    }
    
    function fadeInAudio(audio, durationMs, targetVolume, onEnd){
      if(!audio){ if(onEnd) onEnd(); return; }
      audio.volume = 0;
      fadeAudio(audio, targetVolume, durationMs, onEnd);
    }


  
async function startAudio(){
  if(audioStarted) return;
  try{
    bgmAudio = new Audio('../assets/BGM.mp3');
    bgmAudio.volume = 0.5;
    bgmAudio.loop = true;
    await bgmAudio.play();

    // â˜… è¿½åŠ ï¼šãƒã‚¤ã‚¹ã‚³ã‚¢ç”¨BGM2
    bgm2Audio = new Audio('../assets/BGM2.mp3');
    bgm2Audio.volume = 0.5;
    bgm2Audio.loop = true;
    bgm2Audio.setAttribute('playsinline','');

    endAudio = new Audio('../assets/END.mp3');
    endAudio.volume = 0.5;
    endAudio.setAttribute('playsinline','');

    // â˜… è¿½åŠ ï¼šãƒã‚¤ã‚¹ã‚³ã‚¢é”æˆSE
    highScoreSeAudio = new Audio('../assets/SE.mp3');
    highScoreSeAudio.volume = 0.3;
    highScoreSeAudio.setAttribute('playsinline','');

    // â–¼ åŠ¹æœéŸ³ã¯ãƒ—ãƒ¼ãƒ«ã§ç”¨æ„ï¼ˆè¤‡æ•°åŒæ™‚å†ç”Ÿã«å¼·ã„ï¼‰
    const PICK_POOL_SIZE = 6; // 4ã§ã‚‚OKã€‚å–ã‚Šã“ã¼ã—æ¸›ã‚‰ã—ãŸã„ãªã‚‰6ã€œ8
    for(let i=0;i<PICK_POOL_SIZE;i++){
      const a = new Audio('../assets/pick.mp3');
      a.preload = 'auto';
      a.volume = 1.0;
      // iOSå¯¾ç­–
      a.setAttribute('playsinline','');
      pickupPool.push(a);
    }

    audioStarted = true;

 // ğŸ”‡ ã“ã“ã§ç¾åœ¨ã®ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’é©ç”¨
    applyMuteVolumes();
    
  }catch(e){
    console.error(e);
  }
}

  function playPickup(){
  if(!pickupPool.length) return;
  const a = pickupPool[pickupIndex];
  pickupIndex = (pickupIndex + 1) % pickupPool.length;

  try{
    // iOSã§ç¨€ã«currentTimeãŒç„¡è¦–ã•ã‚Œã‚‹å¯¾ç­–ï¼šä¸€æ—¦åœæ­¢â†’å·»ãæˆ»ã—
    a.pause();
    a.currentTime = 0;
    const p = a.play();
    if(p && typeof p.catch === 'function'){ p.catch(()=>{}); }
  }catch(_){}
}


// ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³
if (muteButton){
  const toggleMute = (e) => {
    e.preventDefault();
    e.stopPropagation(); // å¿µã®ãŸã‚ãƒãƒ–ãƒªãƒ³ã‚°ã‚‚æ­¢ã‚ã¨ã
    isMuted = !isMuted;
    applyMuteVolumes();
  };

  // ã‚¹ãƒãƒ›ã‚‚PCã‚‚ click ã ã‘ã§OK
  muteButton.addEventListener('click', toggleMute);
  // â† touchstart ã¯å‰Šé™¤ï¼
}



  
// â–¼ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå°‚ç”¨BGM
function playCreditsBgm(){
  try{
    if(!creditsAudio){
      creditsAudio = new Audio('../assets/CREDIT.mp3');
      creditsAudio.loop = true;
      creditsAudio.volume = 0.5;
      creditsAudio.setAttribute('playsinline','');
    }
    creditsAudio.currentTime = 0;

 // ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹åæ˜ 
    applyMuteVolumes();
    
    const p = creditsAudio.play();
    if(p && typeof p.catch === 'function'){
      p.catch(()=>{});
    }
  }catch(e){
    console.error(e);
  }
}

function stopCreditsBgm(){
  if(!creditsAudio) return;
  try{
    creditsAudio.pause();
    creditsAudio.currentTime = 0;
  }catch(_){}
}

  

/* ===== ç”»é¢ã‚µã‚¤ã‚ºï¼ˆå›ºå®šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== */
// ã‚²ãƒ¼ãƒ å†…ã®è«–ç†ã‚µã‚¤ã‚ºã‚’å¸¸ã« 768x300 ã«å›ºå®š
const gameWidth  = 768;
const gameHeight = 300;

canvas.width  = gameWidth;
canvas.height = gameHeight;


/* ===== ç©ºã®ãƒ†ãƒ¼ãƒï¼ˆæ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚°é€£å‹• / ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰ ===== */
const THEMES={ morning:{top:[160,210,235],bottom:[247,250,252]}, evening:{top:[246,173,85],bottom:[253,230,138]}, night:{top:[45,55,90],bottom:[20,25,50]} };
let skyCurrent={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
let skyTarget ={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
const skyLerpSpeed=0.02;
let phaseName='morning';
function setBackgroundTheme(k){ const t=THEMES[k]||THEMES.morning; skyTarget={top:[...t.top],bottom:[...t.bottom]}; phaseName=k; }
function drawSky(df){
  const t=Math.min(1,skyLerpSpeed*df);
  for(let i=0;i<3;i++){ skyCurrent.top[i]+=(skyTarget.top[i]-skyCurrent.top[i])*t; skyCurrent.bottom[i]+=(skyTarget.bottom[i]-skyCurrent.bottom[i])*t; }
  const g=ctx.createLinearGradient(0,0,0,gameHeight);
  g.addColorStop(0,`rgb(${skyCurrent.top.map(x=>x|0).join(',')})`);
  g.addColorStop(0.8,`rgb(${skyCurrent.bottom.map(x=>x|0).join(',')})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,gameWidth,gameHeight);
}

/* ===== æ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚° ===== */
const EVENING_MARK_S=96, EPS=0.25;
let lastAudioTime=0, loopCount=0, eveningTriggered=false;
function resetAudioSyncState(){ lastAudioTime=0; loopCount=0; eveningTriggered=false; setBackgroundTheme('morning'); }
function updateSkyByMusic(){
  if(!bgmAudio) return;
  const t=bgmAudio.currentTime||0;
  if(!eveningTriggered && t>=EVENING_MARK_S-EPS){ setBackgroundTheme('evening'); eveningTriggered=true; }
  if(t+EPS<lastAudioTime){ loopCount++; eveningTriggered=false; setBackgroundTheme((loopCount%2===1)?'night':'morning'); }
  lastAudioTime=t;
}

/* ===== é›²ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰å¢—ï¼‹ã‚²ãƒ¼ãƒ é€Ÿåº¦é€£å‹•ï¼‰ ===== */
let clouds = Array.from({length:6},()=>({
  x: Math.random()*gameWidth,
  y: 30 + Math.random()*100,
  base: 0.35 + Math.random()*0.35,
  size: 70 + Math.random()*70
}));

  
function drawClouds(df){
  // æ˜¼ãƒ»å¤•ãƒ»å¤œãã‚Œãã‚Œã§é›²ã®é€æ˜åº¦ã‚’å¤‰ãˆã‚‹
  let alpha;
  if (phaseName === 'night') {
    alpha = 0.03; // â† å¤œã¯ã‚ã£ã¡ã‚ƒè–„ãï¼ˆã»ã¼é€ã‘ã‚‹ï¼‰
  } else if (phaseName === 'evening') {
    alpha = 0.25; // â† å¤•æ–¹ã¯å°‘ã—ã‚ªãƒ¬ãƒ³ã‚¸ç©ºæ°—æ„Ÿ
  } else {
    alpha = 0.42; // â† æ˜¼é–“ã¯é€šå¸¸
  }

  ctx.fillStyle = `rgba(255,255,255,${alpha})`;

  const speedBoost = 1 + (gameSpeed / 10);
  for (const c of clouds) {
    const v = c.base * speedBoost;
    c.x -= v * df;
    if (c.x < -220) {
      c.x = gameWidth + 120;
      c.y = 30 + Math.random() * 100;
    }

    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.size, c.size * 0.55, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.beginPath();
    ctx.ellipse(c.x + c.size * 0.6, c.y + 10, c.size * 0.9, c.size * 0.48, 0, 0, Math.PI * 2);
    ctx.fill();
  }
}



  
/* ===== æ˜Ÿç©ºï¼ˆå¤œã ã‘ãƒ•ã‚§ãƒ¼ãƒ‰è¡¨ç¤ºãƒ»ã‚†ã£ãã‚Šè¦–å·®ãƒ»ãŸã¾ã«æµã‚Œæ˜Ÿï¼‰ ===== */
// ç”»é¢å¹…ã«å¯¾ã—ã¦æ§ãˆã‚ã€‚768pxãªã‚‰ ~75å€‹å‰å¾Œ
const STAR_COUNT = Math.max(40, Math.round(gameWidth * 0.10));

let stars = [];
let starAlpha = 0;                 // å¤œã¸ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼æœå¤•ã¸ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
const STAR_LERP = 0.03;            // ãƒ•ã‚§ãƒ¼ãƒ‰ã®ãªã‚ã‚‰ã‹ã•
let shooting = null;

// æ˜Ÿã¯ã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨åˆ‡ã‚Šé›¢ã—ã€ä¸€å®šã®è¶…ä½é€Ÿãƒ‰ãƒªãƒ•ãƒˆã«ã™ã‚‹ï¼ˆé›ªã£ã½ã•é˜²æ­¢ï¼‰
const STAR_DRIFT_BASE = 0.12;      // 60fpsæ›ç®—ã ã¨ 0.12px/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆã‹ãªã‚Šã‚†ã£ãã‚Šï¼‰

function initStars(){
  stars = Array.from({length: STAR_COUNT}, () => ({
    x: Math.random()*gameWidth,
    // åœ°å¹³ç·šã‚ˆã‚Šä¸Šã ã‘ï¼†ä¸Šç©ºå´ã‚’å°‘ã—åšã‚ã«
    y: Math.random()*(groundY - 60),
    // å°ã•ã‚ã§å¤§åŠã‚’0.4ã€œ1.2pxã«æŠ‘ãˆã‚‹
    r: 0.4 + Math.random()*0.8,
    // ç¬ãã¯ã‹ãªã‚Šã‚†ã£ãã‚Š
    tw: Math.random()*Math.PI*2,
    twSpeed: 0.005 + Math.random()*0.007,   // 0.005ã€œ0.012
    // è¦–å·®ã¯æ¥µå°ï¼šè¿‘æ™¯ã§ã‚‚é€Ÿãè¦‹ãˆãªã„ãƒ¬ãƒ³ã‚¸ã«å›ºå®š
    parallax: 0.02 + Math.random()*0.06     // 0.02ã€œ0.08
  }));
}

// å¤œã ã‘ã€ãŸã¾ã«æµã‚Œæ˜Ÿ
function maybeSpawnShootingStar(){
  if (shooting || phaseName !== 'night') return;
  // ã ã„ãŸã„15ã€œ25ç§’ã«1å›ãã‚‰ã„ã®ä½“æ„Ÿï¼ˆæ§ãˆã‚ï¼‰
  if (Math.random() < 0.0025) {
    shooting = {
      x: Math.random() * (gameWidth * 0.6) + gameWidth * 0.2,
      y: 30 + Math.random() * (groundY * 0.35),
      vx: -(3 + Math.random()*2),
      vy:  1 + Math.random()*1.2,
      life: 60 + Math.random()*30,   // ãƒ•ãƒ¬ãƒ¼ãƒ å¯¿å‘½
      len: 40 + Math.random()*30
    };
  }
}

function drawStars(df){
  // å¤œã ã‘ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ1ã€ãã‚Œä»¥å¤–0ã¸ãƒ•ã‚§ãƒ¼ãƒ‰
  const target = (phaseName === 'night') ? 1 : 0;
  starAlpha += (target - starAlpha) * (STAR_LERP * df);

  if (starAlpha <= 0.01 && phaseName !== 'night') return; // ã»ã¼è¦‹ãˆãªã„ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

  // ä¸€å®šã®ã”ãä½é€Ÿãƒ‰ãƒªãƒ•ãƒˆï¼‹æ¥µå°è¦–å·®ï¼ˆã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨ã¯ç„¡é–¢ä¿‚ï¼‰
  for (const s of stars) {
    const drift = (STAR_DRIFT_BASE + s.parallax) * df; // å¸¸ã«ã‚†ã£ãã‚Šå·¦ã¸
    s.x -= drift;
    if (s.x < -3) { s.x = gameWidth + 3; s.y = Math.random()*(groundY - 60); }

    // ã‚†ã£ãã‚Šç¬ã
    s.tw += s.twSpeed * df;
    const twinkle = 0.75 + 0.25 * Math.sin(s.tw); // 0.5ã€œ1.0ãã‚‰ã„ã®æŸ”ã‚‰ã‹ã„æºã‚Œ
    const a = Math.max(0, Math.min(1, starAlpha * twinkle));

    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
  }

  // æµã‚Œæ˜Ÿï¼ˆæ—¢å­˜ã®è¦‹ãŸç›®ã‚’ç¶­æŒï¼‰
  maybeSpawnShootingStar();
  if (shooting) {
    const a = 0.75 * starAlpha;
    const tailX = shooting.x + shooting.len * 0.8;
    const tailY = shooting.y - shooting.len * 0.4;

    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(shooting.x, shooting.y, 1.6, 0, Math.PI*2); ctx.fill();

    const grad = ctx.createLinearGradient(shooting.x, shooting.y, tailX, tailY);
    grad.addColorStop(0, `rgba(255,255,255,${a})`);
    grad.addColorStop(1, `rgba(255,255,255,0)`);
    ctx.strokeStyle = grad;
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(shooting.x, shooting.y); ctx.lineTo(tailX, tailY); ctx.stroke();

    // æµã‚Œæ˜Ÿã ã‘ã¯å°‘ã—é€Ÿã„æ„Ÿã˜ã®ã¾ã¾ï¼ˆã‚²ãƒ¼ãƒ é€Ÿåº¦ã¨ã‚‚ç‹¬ç«‹ï¼‰
    shooting.x += shooting.vx * df;
    shooting.y += shooting.vy * df;
    shooting.life -= df;
    if (shooting.life <= 0 || shooting.x < -60 || shooting.y > groundY - 10) shooting = null;
  }
}




  
/* ===== åœ°é¢ï¼ˆè‰²å‘³èª¿æ•´ï¼‹é€Ÿåº¦ä¸€è‡´ï¼‰ ===== */
const groundY = gameHeight - 50;
function drawGround(){ ctx.fillStyle='#8B5A2B'; ctx.fillRect(0,groundY,gameWidth,50); }
initStars(); 

let groundGrains = [];   // ç´°ã‹ã„ç ‚
let groundPebbles = [];  // å°çŸ³
let groundStreaks = [];  // åœ°è¡¨ã®æ¨ªç·š

function initGroundDetails(){
  const grainsN  = Math.floor(gameWidth * 0.38);
  const pebblesN = Math.floor(gameWidth * 0.08);
  const streaksN = Math.floor(gameWidth * 0.05);

  // åºŠè‰²å¯„ã›ï¼ˆ#8B5A2B ä»˜è¿‘ï¼‰
  groundGrains = Array.from({length:grainsN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 8 + Math.random()*38,
    r: 0.8 + Math.random()*1.4,
    shadeR: 139 + Math.floor(Math.random()*8),   // 139ã€œ146
    shadeG: 90  + Math.floor(Math.random()*6),   // 90ã€œ95
    shadeB: 43  + Math.floor(Math.random()*6)    // 43ã€œ49
  }));
  groundPebbles = Array.from({length:pebblesN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 10 + Math.random()*36,
    w: 2 + Math.random()*3,
    h: 1 + Math.random()*2,
    shadeR: 133 + Math.floor(Math.random()*10),  // å°‘ã—æš—ã‚
    shadeG: 84  + Math.floor(Math.random()*10),
    shadeB: 40  + Math.floor(Math.random()*10)
  }));
  groundStreaks = Array.from({length:streaksN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 6 + Math.random()*10,
    len: 8 + Math.random()*18,
    shadeR: 130 + Math.floor(Math.random()*8),
    shadeG: 82  + Math.floor(Math.random()*8),
    shadeB: 38  + Math.floor(Math.random()*8)
  }));
}
initGroundDetails();

/* â˜… åœ°é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼éšœå®³ç‰©ï¼ˆ= gameSpeedï¼‰ã«å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ */
function drawGroundDetails(df){
  const v = gameSpeed * df; // â† çµ±ä¸€

  // ç ‚
  for(const g of groundGrains){
    g.x -= v;
    if(g.x < -2){ g.x = gameWidth + Math.random()*40; g.y = groundY + 8 + Math.random()*38; }
    ctx.fillStyle = `rgb(${g.shadeR}, ${g.shadeG}, ${g.shadeB})`;
    ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
  }

  // å°çŸ³
  for(const p of groundPebbles){
    p.x -= v;
    if(p.x < -3){ p.x = gameWidth + Math.random()*60; p.y = groundY + 10 + Math.random()*36; }
    ctx.fillStyle = `rgb(${p.shadeR}, ${p.shadeG}, ${p.shadeB})`;
    ctx.fillRect(p.x, p.y, p.w, p.h);
  }

  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯
  for(const s of groundStreaks){
    s.x -= v;
    if(s.x < -s.len){ s.x = gameWidth + Math.random()*80; s.y = groundY + 6 + Math.random()*10; }
    ctx.strokeStyle = `rgba(${s.shadeR}, ${s.shadeG}, ${s.shadeB}, 0.55)`;
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x + s.len, s.y); ctx.stroke();
  }
}


/* ===== ã‚²ãƒ¼ãƒ æœ¬ä½“ ===== */
let score=0, highScore=parseInt(localStorage.getItem('muruHighScore')||'0',10); highScoreEl.textContent=`ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
let gameSpeed=5, baseGameSpeed=5, gameSpeedAcceleration=0.05;
const GAME_SPEED_MAX=13;

let timeElapsed=0, obstacles=[], frame=0, spawnTimer=0;
const minSpawnIntervalBase=105, maxSpawnIntervalBase=155, spawnIntervalReductionPerSec=4;
const EARLY_EASE_MS=15000, EARLY_EASE_START_MULT=1.15;
  
function currentOnscreenLimit(ms){
  if(ms < 45000)  return 2; // ã€œ45s
  if(ms < 120000) return 3; // 45sã€œ2åˆ†
  return 4;                 // 2åˆ†ã€œ
}


let isGameOver=false, isPaused=false, gameStarted=false, lastTime=0;
let isDebug=false, debugTapCount=0; const DEBUG_TAPS_TO_ENABLE=20;
let nextSpawnInterval=90;
let isHighScoreRun = false;

// â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢çªå…¥ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨
let flashTimer = 0;
const FLASH_DURATION = 18; // ã ã„ãŸã„ 18ãƒ•ãƒ¬ãƒ¼ãƒ  â‰’ 0.3ç§’


/* === ã©ã‚“ãã‚Šï¼ˆSVG/é€Ÿåº¦å›ºå®š/5ç§’Â±1ç§’ã”ã¨ã«æŠ½é¸30%ï¼‰ === */
class Acorn{
  constructor(type,x,y,size){ this.type=type; this.x=x; this.y=y; this.size=size; this.t=Math.random()*Math.PI*2; }
  update(d){
    const fixedSpeed=0.5*baseGameSpeed; // å¸¸ã«ãƒ™ãƒ¼ã‚¹ã®åŠåˆ†ï¼ˆåŠ é€Ÿã—ãªã„ï¼‰
    this.x -= fixedSpeed * d;
    if(this.type==='air'){ this.t+=0.05*d; this.y += Math.sin(this.t)*0.2*d; }
  }
  draw(){
    const img=SPRITES.donguri; if(img && img.complete){ const w=this.size,h=this.size; ctx.drawImage(img,this.x,this.y-h,w,h); }
  }
  getHitbox(){
      return {
      x: this.x - this.size * 0.05,
      y: this.y - this.size * 1.02,
      width:  this.size * 0.9,
      height: this.size * 1.02
      };
  }

}
let acorns = [];

 // â˜… ã©ã‚“ãã‚Šå–ã£ãŸã¨ãã«å‡ºã™ã€Œ+10ã€ã¿ãŸã„ãªãƒ•ã‚­ãƒ€ã‚·ç”¨
class FloatText {
  constructor(text, x, y) {
    this.text = text;
    this.x = x;
    this.y = y;
    this.vy = -0.6;   // ä¸Šã«ãµã‚ã£ã¨ä¸ŠãŒã‚‹é€Ÿã•
    this.life = 30;   // å¯¿å‘½ï¼ˆå¤§ãã„ã»ã©é•·ãæ®‹ã‚‹ï¼‰
  }
}

let floatTexts = [];
 

// â˜… ãƒŸãƒªç§’åŸºæº–ã‚¿ã‚¤ãƒï¼ˆç«¯æœ«å·®ãªã—ï¼‰
let acornSpawnTimerMs = 0;
function nextAcornIntervalMs(){ return 5000 + Math.random()*2000; } // 5ã€œ7ç§’ã«ä¸€åº¦ æŠ½é¸
let acornNextIntervalMs = nextAcornIntervalMs();

function maybeSpawnAcorn(){
  if(Math.random() >= 0.30) return; // 30%ã§å‡ºã™
  const x = gameWidth + 20;         // â˜… æœªå®šç¾©ãƒã‚°ä¿®æ­£
  const size = 56 + Math.floor(Math.random()*12); // ã¡ã‚‡ã„å¤§ãã‚
  if(Math.random()<0.5){
    const y=groundY-6; acorns.push(new Acorn('ground',x,y,size));
  }else{
    const minY=groundY-160, maxY=groundY-60; const y=Math.floor(minY+Math.random()*(maxY-minY));
    acorns.push(new Acorn('air',x,y,size));
  }
}
function spawnAcornMs(deltaMs){
  acornSpawnTimerMs += deltaMs;
  if(acornSpawnTimerMs < acornNextIntervalMs) return;
  acornSpawnTimerMs = 0;
  acornNextIntervalMs = nextAcornIntervalMs();
  maybeSpawnAcorn();
}

function updateAcorns(d){
  for(let i=acorns.length-1;i>=0;i--){ acorns[i].update(d); acorns[i].draw(); if(acorns[i].x<-50) acorns.splice(i,1); }
}

  
function tryCollectAcorns(){
  const p={x:player.x,y:player.y,width:player.width*0.6,height:player.height*0.7};
  for(let i=acorns.length-1;i>=0;i--){
    const a=acorns[i], h=a.getHitbox();
    if(p.x<h.x+h.width && p.x+p.width>h.x && p.y<h.y+h.height && p.y+p.height>h.y){

      // â˜… é€šå¸¸ï¼š+10 / ãƒ‡ãƒãƒƒã‚°ä¸­ï¼š+200
      const gained = isDebug ? 200 : 10;
      score += gained;

      // â˜… ã“ã“ã§ã€Œ+10ã€(or +200) ãƒ•ã‚­ãƒ€ã‚·è¿½åŠ 
      floatTexts.push(
        new FloatText(
          `+${gained}`,
          a.x + a.size * 0.5,     // ã©ã‚“ãã‚Šã®çœŸã‚“ä¸­ã‚ãŸã‚Š
          a.y - a.size * 0.4      // å°‘ã—ä¸Š
        )
      );

      acorns.splice(i,1);
      playPickup();
    }
  }
}



/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function clamp01(v){ return Math.max(0,Math.min(1,v)); }
function getEarlyEaseMultiplier(ms){ const t=clamp01(ms/EARLY_EASE_MS); return EARLY_EASE_START_MULT + (1.0-EARLY_EASE_START_MULT)*t; }
function getMinPixelGap(ms){ const t=clamp01(ms/EARLY_EASE_MS); const s=Math.round(gameWidth*0.42), e=Math.round(gameWidth*0.32); return Math.round(s+(e-s)*t); }
function enableDebugMode(){ if(isDebug) return; isDebug=true; const b=document.createElement('span'); b.id='debugBadge'; b.textContent='DEBUG'; b.className='px-2 py-1 bg-pink-600 text-white text-xs font-bold rounded shadow-sm ml-1'; highScoreEl.parentElement.appendChild(b); }
function resetDebugTapCounter(){ debugTapCount=0; }

function startHighScoreRun(){
  if(isHighScoreRun) return;
  isHighScoreRun = true;

  // ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒ«ãƒ¼ãƒ«ã®ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’å³åæ˜ 
  applyMuteVolumes();

  // â˜… ã“ã“ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é–‹å§‹
  flashTimer = FLASH_DURATION;
  
  // ã‚¹ã‚³ã‚¢ãƒ©ãƒ™ãƒ«ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«
  if(scoreLabel){
    scoreLabel.classList.remove('text-blue-600');
    scoreLabel.classList.add('text-orange-400');
  }

  // è™¹è‰²ãƒãƒŠãƒ¼è¡¨ç¤º
  if(highScoreBanner){
    highScoreBanner.classList.remove('hidden');
  }

  // â˜… BGM1 ã¯æ­¢ã‚ãšã«ã€éŸ³ã ã‘å®Œå…¨ãƒŸãƒ¥ãƒ¼ãƒˆï¼ˆã‚¿ã‚¤ãƒŸãƒ³ã‚°ç”¨ã«å†ç”Ÿã¯ç¶šã‘ã‚‹ï¼‰
  if (bgmAudio){
    bgmAudio.muted = true;
  }


  // ãƒã‚¤ã‚¹ã‚³ã‚¢é”æˆSEï¼ˆå…ˆã«é³´ã‚‰ã™ï¼‰
  try{
    if (highScoreSeAudio){
      highScoreSeAudio.currentTime = 0;
      highScoreSeAudio.play();
    }
  }catch(_){}

  // â˜… 1ç§’å¾…ã£ã¦ã‹ã‚‰ BGM2 ã‚’ãã®ã¾ã¾å†ç”Ÿï¼ˆãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãªã—ï¼‰
  if (bgm2Audio){
    setTimeout(() => {
      try{
        bgm2Audio.pause();          // å¿µã®ãŸã‚ä¸€æ—¦æ­¢ã‚ã¦
        bgm2Audio.currentTime = 0;  // é ­ã‹ã‚‰

        // ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆä¸­ãªã‚‰0ã€ãã†ã˜ã‚ƒãªã‘ã‚Œã°0.5
        bgm2Audio.volume = isMuted ? 0 : 0.5;

        const p = bgm2Audio.play();
        if (p && typeof p.catch === 'function') p.catch(()=>{});
      }catch(_){}
    }, 1000);
  }

}



/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
const player={x:50,y:groundY-50,width:50,height:50,dy:0,gravity:0.8,jumpForce:15,isGrounded:true,jumpsRemaining:2,isJumping:false,image:new Image(),imageLoaded:false};
player.image.src='../assets/Muru.png';
player.image.onload=()=>{ player.imageLoaded=true; player.width=(player.image.width/player.image.height)*player.height; };

function drawPlayer(){ if(player.imageLoaded) ctx.drawImage(player.image,player.x,player.y,player.width,player.height); else{ ctx.fillStyle='green'; ctx.fillRect(player.x,player.y,player.width,player.height);} }
function updatePlayer(d){ if(!player.isGrounded){ player.dy+=player.gravity*d; player.y+=player.dy*d; } if(player.y+player.height>=groundY){ player.y=groundY-player.height; player.dy=0; player.isGrounded=true; player.jumpsRemaining=2; } }
function playerJump(){  if(isGameOver||isPaused||!gameStarted) return; startAudio(); if(player.jumpsRemaining>0){ player.dy=-player.jumpForce; player.isGrounded=false; player.isJumping=true; player.jumpsRemaining--; } }
function stopJump(){ if(player.isJumping && player.dy<0){ player.dy=Math.max(player.dy,-5); } player.isJumping=false; }

/* ===== éšœå®³ç‰©ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰ ===== */
class Obstacle{
  constructor(type,img,y,size){
    this.x=gameWidth; this.y=y; this.type=type; this.img=img; this.height=size;
    const iw=img.naturalWidth||1, ih=img.naturalHeight||1, aspect=iw/ih;
    this.width=this.height*aspect; this.passed=false;
  }
  draw(){ ctx.drawImage(this.img,this.x,this.y-this.height,this.width,this.height); }
  update(d){ this.x -= gameSpeed*d; }
  getHitbox(){ const shrink=this.type==='ground_large'?0.65:0.8; const w=this.width*shrink, h=this.height*shrink; return { x:this.x+(this.width-w)/2, y:(this.y-this.height)+(this.height-h)/2, width:w, height:h }; }
}

/* â˜… è¿½åŠ ï¼šå‹•ãã²ã¾ã‚ã‚Šå°‚ç”¨ã‚¯ãƒ©ã‚¹ */
class SpecialSunflower extends Obstacle{
  constructor(type,img,y,size){
    super(type,img,y,size);
    this.baseY = y;
    this.phase = Math.random()*Math.PI*2;
    this.hopAmp = size * 0.5;   // ã´ã‚‡ã‚“ã´ã‚‡ã‚“ã®é«˜ã•
    this.hopSpeed = 0.18;        // ã´ã‚‡ã‚“ã´ã‚‡ã‚“ã®é€Ÿã•
  }

  update(d){
    if(this.type === 'sun2_run'){
      // ã“ã£ã¡ã«å‘ã‹ã£ã¦èµ°ã£ã¦ãã‚‹æ„Ÿã˜ï¼šæ™®é€šã‚ˆã‚Šã¡ã‚‡ã„é€Ÿã„
      this.x -= gameSpeed * 1.4 * d;
    }else if(this.type === 'sun2_hop'){
      // ãã®å ´ã§æµã‚Œã¦ãã‚‹ï¼‹å°ã•ãã‚¸ãƒ£ãƒ³ãƒ—
      this.x -= gameSpeed * d;
      this.phase += this.hopSpeed * d;
      const offset = Math.abs(Math.sin(this.phase)) * this.hopAmp;
      this.y = this.baseY - offset;
    }else{
      // ä¸‡ãŒä¸€ä»–ã‚¿ã‚¤ãƒ—ã«ã‚‚ä½¿ã£ãŸã¨ãç”¨
      super.update(d);
    }
  }
}


const SCALE = 0.7;

function spawnObstacle(delta){
  spawnTimer += delta;

  let minSpawnInterval = Math.max(
    minSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec,
    40
  );
  let maxSpawnInterval = Math.max(
    maxSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec,
    70
  );

  const easeMul = getEarlyEaseMultiplier(timeElapsed);
  minSpawnInterval *= easeMul;
  maxSpawnInterval *= easeMul;

  function lateDensityMul(ms){
    if(ms < 60000)  return 1.0;  // ã€œ60s
    if(ms < 120000) return 0.85; // 1ã€œ2åˆ†
    return 0.72;                 // 2åˆ†ã€œ
  }
  const ld = lateDensityMul(timeElapsed);
  minSpawnInterval *= ld;
  maxSpawnInterval *= ld;

  if (spawnTimer < nextSpawnInterval) return;

  const onscreen = obstacles.filter(o => (o.x + o.width > 0) && (o.x < gameWidth)).length;
  const limit = currentOnscreenLimit(timeElapsed);
  if (onscreen >= limit) return;

  const last = obstacles.length ? obstacles[obstacles.length-1] : null;
  const minGapPx = getMinPixelGap(timeElapsed);
  if (last){
    const gapPx = gameWidth - (last.x + last.width);
    if (gapPx < minGapPx) return;
  }

  const rand = Math.random();

  if (rand < 0.4){
    // ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼ï¼ˆç©ºä¸­ï¼‰
    const size = (40 + Math.random()*20) * SCALE;
    const yPos = Math.random() < 0.3
      ? groundY - 30
      : groundY - 70 - Math.random()*50;
    obstacles.push(new Obstacle('air', SPRITES.blueberry, yPos, size));
  } else {
    // â˜… æ™®é€šã®ã²ã¾ã‚ã‚Š vs å‹•ãã²ã¾ã‚ã‚Š
    const canUseSpecial = (score >= 500) && SPRITES.sunflower2;
    const useSpecial = canUseSpecial && (Math.random() < 0.2); // 5å›ã«1å›ãã‚‰ã„

    if (useSpecial){
      // ã©ã£ã¡å‡ºã™ã‹ 50:50
      const isRunner = Math.random() < 0.5;
      const type = isRunner ? 'sun2_run' : 'sun2_hop';

      const baseSize = (70 + Math.random()*20) * SCALE;
      // èµ°ã‚‹ã‚„ã¤ï¼1.5å€ã€ã´ã‚‡ã‚“ã´ã‚‡ã‚“ï¼1.65å€
      const size = isRunner ? baseSize * 1.5 : baseSize * 1.65;

      obstacles.push(new SpecialSunflower(type, SPRITES.sunflower2, groundY, size));
    } else {
      // â˜… å¾“æ¥ã©ãŠã‚Šã®ã²ã¾ã‚ã‚Š
      if (score > 10 && Math.random() < 0.3){
        obstacles.push(
          new Obstacle('ground_large', SPRITES.sunflower, groundY, 120 * SCALE * 1.25)
        );
      } else {
        obstacles.push(
          new Obstacle('ground', SPRITES.sunflower, groundY, (60 + Math.random()*20) * SCALE)
        );
      }
    }
  }

  nextSpawnInterval = minSpawnInterval + Math.random()*(maxSpawnInterval - minSpawnInterval);
  spawnTimer = 0;
}


function updateObstacles(d){
  for(let i = obstacles.length - 1; i >= 0; i--){
    obstacles[i].update(d);
    obstacles[i].draw();
    if(obstacles[i].x + obstacles[i].width < 0){
      obstacles.splice(i, 1);
    }
  }
}





  

/* ===== å½“ãŸã‚Šåˆ¤å®š / ã‚¹ã‚³ã‚¢ / é€Ÿåº¦ ===== */
function checkCollision(){
  if(isDebug) return;
  const p={x:player.x,y:player.y,width:player.width*0.6,height:player.height*0.7};
  for(const o of obstacles){ const h=o.getHitbox(); if(p.x<h.x+h.width && p.x+p.width>h.x && p.y<h.y+h.height && p.y+p.height>h.y){ gameOver(); return; } }
}




  
function updateScore(){
  for(const o of obstacles){
    if(!o.passed && o.x+o.width < player.x){
      score++;
      o.passed = true;
    }
  }
  tryCollectAcorns();
  scoreEl.textContent = score;

  // â˜… ã“ã“ã§ã€Œãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ä¸­ã€ã‚’æ¤œçŸ¥ï¼ˆåˆå› highScore=0 ã®ã¨ãã¯ã‚¹ãƒ«ãƒ¼ï¼‰
  if (!isHighScoreRun && highScore > 0 && score > highScore) {
    startHighScoreRun();
  }


  const tSec=timeElapsed/1000;
  gameSpeed=Math.min(baseGameSpeed + tSec*gameSpeedAcceleration, GAME_SPEED_MAX);
}
  

/* ===== çµ‚äº†å‡¦ç†ãªã© ===== */
function buildXIntentUrl(score){ const text=`ã‚€ã‚‹ã ã£ã—ã‚…ï¼ã‚¹ã‚³ã‚¢ã¯ã€Œ${score}ã€ã§ã—ãŸğŸŒ»\nhttps://t4l-ovo-t4l.github.io/murudash/`; return `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`; }

  
function gameOver(){
  if(isGameOver) return;
  isGameOver = true;
  gameStarted = false;

  if(audioStarted){
    try{
      if(isHighScoreRun){
        // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ã—ã¦ãŸå ´åˆï¼š5ç§’ã‹ã‘ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        const targetBgm =
          (bgm2Audio && !bgm2Audio.paused) ? bgm2Audio :
          (bgmAudio && !bgmAudio.paused) ? bgmAudio :
          null;

        if(targetBgm){
          fadeOutAudio(targetBgm, 5000, () => {
            try{
              targetBgm.pause();
              targetBgm.currentTime = 0;
              targetBgm.volume = isMuted ? 0 : 0.5;

            }catch(_){}
          });
        }
      }else{
        // â˜… é€šå¸¸æ™‚ï¼šå¾“æ¥ã©ãŠã‚Šå³åœæ­¢
        if(bgmAudio){
          bgmAudio.pause();
          bgmAudio.currentTime = 0;
          bgmAudio.volume = isMuted ? 0 : 0.5;
        }
      }

      // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼SE ã¯å¾“æ¥ã©ãŠã‚Šé³´ã‚‰ã™
      endAudio.currentTime = 0;
      endAudio.play();

    }catch(_){}
  }

  if(score>highScore){
    highScore=score;
    localStorage.setItem('muruHighScore',highScore);
    highScoreEl.textContent=`ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
  }

  finalScoreEl.textContent=score;
  shareButton.href=buildXIntentUrl(score);

  // â˜… ã“ã®ãƒ—ãƒ¬ã‚¤ã§ãƒã‚¤ã‚¹ã‚³ã‚¢æ›´æ–°ã—ã¦ã„ãŸã‚‰è¡¨ç¤º
  if (gameOverHighScoreLabel){
    if (isHighScoreRun){
      gameOverHighScoreLabel.classList.remove('hidden');
    } else {
      gameOverHighScoreLabel.classList.add('hidden');
    }
  }
  
  gameOverScreen.classList.remove('hidden');
  gameOverScreen.classList.add('flex');
}





  
function restartGame(){
  startAudio();
  try{
    if(bgmAudio){
      bgmAudio.currentTime = 0;
      bgmAudio.play();
    }
  }catch(_){}

  score=0; scoreEl.textContent=score; timeElapsed=0; gameSpeed=baseGameSpeed;
  obstacles=[]; acorns=[]; floatTexts=[]; frame=0; spawnTimer=0;

  initStars();
  starAlpha = 0;
  shooting = null;
  acornSpawnTimerMs = 0; acornNextIntervalMs = nextAcornIntervalMs();

  isGameOver=false; isPaused=false; gameStarted=true;
  player.y=groundY-player.height; player.dy=0; player.isGrounded=true; player.jumpsRemaining=2;
  gameOverScreen.classList.add('hidden'); gameOverScreen.classList.remove('flex'); pauseOverlay.classList.add('hidden');

  isHighScoreRun = false;
  if(scoreLabel){
    scoreLabel.classList.remove('text-orange-400');
    scoreLabel.classList.add('text-blue-600');
  }
  if(highScoreBanner){
    highScoreBanner.classList.add('hidden');
  }
  if (gameOverHighScoreLabel){
    gameOverHighScoreLabel.classList.add('hidden');
  }

  if(bgm2Audio){
    try{
      bgm2Audio.pause();
      bgm2Audio.currentTime = 0;
    }catch(_){}
  }

  // ğŸ”‡ â† ã“ã“ï¼æœ€å¾Œã«ãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’åæ˜ 
  applyMuteVolumes();

  resetAudioSyncState(); isDebug=false; resetDebugTapCounter(); const dbg=document.getElementById('debugBadge'); if(dbg) dbg.remove();
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  lastTime=performance.now(); requestAnimationFrame(gameLoop);
}


  
function togglePause(){
  if (isGameOver || !gameStarted) return;
  isPaused = !isPaused;

  if (isPaused){
    try{
      if (bgmAudio) bgmAudio.pause();
      if (bgm2Audio) bgm2Audio.pause();
    }catch(_){}
    pauseOverlay.classList.remove('hidden');
    pauseOverlay.classList.add('flex');
    resetDebugTapCounter();
  } else {
    try{
      // â˜… BGM1 ã¯å¿…ãšå†é–‹ï¼ˆéŸ³é‡0ã®ã¾ã¾ã§ã‚‚OKï¼‰
      if (bgmAudio) bgmAudio.play();

      // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸­ãªã‚‰ BGM2 ã‚‚å†é–‹
      if (isHighScoreRun && bgm2Audio){
        bgm2Audio.play();
      }
    }catch(_){}
    pauseOverlay.classList.add('hidden');
    pauseOverlay.classList.remove('flex');
    lastTime = performance.now();
    requestAnimationFrame(gameLoop);
    resetDebugTapCounter();
  }
}




function openCredits(e){
  if (e) e.preventDefault();

  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤º
  creditsOverlay.classList.remove('hidden');
  creditsOverlay.classList.add('flex');

  // ã‚¹ã‚¿ãƒƒãƒ•ãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é ­ã‹ã‚‰å†ç”Ÿã—ç›´ã™
  creditsScroll.classList.remove('credits-scroll');
  void creditsScroll.offsetWidth; // reflow
  creditsScroll.classList.add('credits-scroll');

  // ã‚²ãƒ¼ãƒ BGMã¯ã„ã£ãŸã‚“æ­¢ã‚ã¦ã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå°‚ç”¨BGMå†ç”Ÿ
  try{
    if (bgmAudio)  bgmAudio.pause();
    if (bgm2Audio) bgm2Audio.pause();
  }catch(_){}
  playCreditsBgm();
}


function closeCredits(e){
  if (e) e.preventDefault();

  creditsOverlay.classList.add('hidden');
  creditsOverlay.classList.remove('flex');

  // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆBGMåœæ­¢
  stopCreditsBgm();

  // ã‚‚ã—æ—¢ã«ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ã¦ã„ã¦ã€ãƒãƒ¼ã‚ºã§ã‚‚ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ã‚‚ãªã„ãªã‚‰BGMå†é–‹
  if (gameStarted && !isGameOver && !isPaused){
  try{
    // â˜… ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç”¨BGM1ã¯å¸¸ã«å†é–‹
    if (bgmAudio) bgmAudio.play();

    // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢ä¸­ãªã‚‰BGM2ã‚‚å†é–‹
    if (isHighScoreRun && bgm2Audio){
      bgm2Audio.play();
    }
  }catch(_){}
}
}


  

// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ãƒœã‚¿ãƒ³
creditsButton.addEventListener('click', openCredits);
creditsButton.addEventListener('touchstart', openCredits, { passive: false });

// ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆç”»é¢ã®ã€Œã¨ã˜ã‚‹ã€ãƒœã‚¿ãƒ³
closeCreditsButton.addEventListener('click', closeCredits);
closeCreditsButton.addEventListener('touchstart', closeCredits, { passive: false });



  
/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function gameLoop(ts){
  if(isGameOver||isPaused||!gameStarted) return;
  const dt=ts-lastTime; lastTime=ts; const df=dt/(1000/60); timeElapsed+=dt;

  updateSkyByMusic();

  // èƒŒæ™¯ï¼†é›²
  ctx.clearRect(0,0,gameWidth,gameHeight);
  drawSky(df); drawStars(df); drawClouds(df);

  // åœ°é¢ï¼‹æµã‚Œã‚‹ç ‚åˆ©ï¼ˆéšœå®³ç‰©ã¨åŒé€Ÿã§æµã™ï¼‰
  drawGround(); drawGroundDetails(df);

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼éšœå®³ç‰©ï¼ã©ã‚“ãã‚Š
  updatePlayer(df); drawPlayer();
  spawnObstacle(df); updateObstacles(df);
  spawnAcornMs(dt); updateAcorns(df);

  // â˜… ã©ã‚“ãã‚Šã®ã€Œ+10ã€ã¿ãŸã„ãªãƒ•ã‚­ãƒ€ã‚·æç”»
  for (let i = floatTexts.length - 1; i >= 0; i--) {
    const ft = floatTexts[i];

    // ãµã‚ã£ã¨ä¸Šã«ç§»å‹•
    ft.y += ft.vy * df;
    ft.life -= df;

    // æ®‹ã‚Šå¯¿å‘½ã«å¿œã˜ã¦ã ã‚“ã ã‚“é€æ˜ã«
    const alpha = Math.max(0, Math.min(1, ft.life / 30));

    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.font = 'bold 20px "Inter", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    // ã¡ã‚‡ã£ã¨ã‚¯ãƒªãƒ¼ãƒ è‰²ï¼‹é»’ãƒ•ãƒ
    ctx.strokeStyle = 'rgba(0,0,0,0.75)';
    ctx.lineWidth = 3;
    ctx.fillStyle = '#fff7aa';

    ctx.strokeText(ft.text, ft.x, ft.y);
    ctx.fillText(ft.text, ft.x, ft.y);
    ctx.restore();

    // å¯¿å‘½ãŒå°½ããŸã‚‰æ¶ˆã™
    if (ft.life <= 0) {
      floatTexts.splice(i, 1);
    }
  }

  
  // â˜… ãƒã‚¤ã‚¹ã‚³ã‚¢çªå…¥ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  if (flashTimer > 0) {
    const alpha = (flashTimer / FLASH_DURATION) * 0.85; // æœ€å¤§0.85ãã‚‰ã„ã¾ã§å…‰ã‚‹
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.fillRect(0, 0, gameWidth, gameHeight);

    flashTimer -= df;          // æ™‚é–“çµŒéã§æ¸›ã‚‰ã™ï¼ˆdfã¯ã ã„ãŸã„1/ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    if (flashTimer < 0) flashTimer = 0;
  }

  
  checkCollision(); updateScore();

  frame++; requestAnimationFrame(gameLoop);
}

/* ===== å…¥åŠ› ===== */
window.addEventListener('keydown', e=>{
  if(e.repeat) return;
  if(isPaused && (e.code==='Space'||e.code==='ArrowUp')){ debugTapCount++; if(debugTapCount>=DEBUG_TAPS_TO_ENABLE){ enableDebugMode(); resetDebugTapCounter(); } return; }
  if(!gameStarted) return;
  if(e.code==='Space'||e.code==='ArrowUp') playerJump();
  if(e.code==='KeyP') togglePause();
});
window.addEventListener('keyup', e=>{ if(e.code==='Space'||e.code==='ArrowUp') stopJump(); });
  
jumpButton.addEventListener('pointerdown', e=>{
  e.preventDefault();

  // ã¾ã ã‚²ãƒ¼ãƒ ãŒå§‹ã¾ã£ã¦ã„ãªã„ï¼ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ä¸­ãªã‚‰ã€Œã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã€ã¨ã—ã¦å‹•ã
  if (!gameStarted) {
    handleGameStart();  // e ãªã—ã§å‘¼ã‚“ã§OKãªã‚ˆã†ã«ã—ã¦ã‚ã‚‹
    return;
  }

  // ãƒãƒ¼ã‚ºä¸­ã¯ãƒ‡ãƒãƒƒã‚°ã‚¿ãƒƒãƒ—ã‚«ã‚¦ãƒ³ãƒˆã ã‘
  if(isPaused){
    debugTapCount++;
    if(debugTapCount>=DEBUG_TAPS_TO_ENABLE){
      enableDebugMode();
      resetDebugTapCounter();
    }
    return;
  }

  // é€šå¸¸ãƒ—ãƒ¬ã‚¤ä¸­ã¯ã‚¸ãƒ£ãƒ³ãƒ—
  playerJump();
});

jumpButton.addEventListener('pointerup',   e=>{ e.preventDefault(); stopJump(); });
pauseButton.addEventListener('click', e=>{ e.preventDefault(); togglePause(); });
pauseButton.addEventListener('touchstart', e=>{ e.preventDefault(); togglePause(); });

restartButton.addEventListener('click', e=>{ e.preventDefault(); restartGame(); });
restartButton.addEventListener('touchstart', e=>{ e.preventDefault(); restartGame(); });

function handleGameStart(e){
  if (e) e.preventDefault();   // â† e ãŒãªã„ã¨ãã‚‚è½ã¡ãªã„ã‚ˆã†ã«

  if(gameStarted) return;
  gameStarted = true;

  // ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’ã€Œã‚¸ãƒ£ãƒ³ãƒ—ã€ã«åˆ‡ã‚Šæ›¿ãˆ
  jumpButton.textContent = 'ã‚¸ãƒ£ãƒ³ãƒ—';

  startAudio();
  startScreen.classList.add('hidden');
  resetAudioSyncState();
  isDebug = false;
  resetDebugTapCounter();
  const dbg = document.getElementById('debugBadge');
  if(dbg) dbg.remove();

  lastTime = performance.now();
  requestAnimationFrame(gameLoop);
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  spawnTimer = 0;
}

  

</script>
</body>
</html>
