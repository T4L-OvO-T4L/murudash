<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; media-src 'self';">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link rel="preload" as="image" href="./assets/blueberry.svg">
<link rel="preload" as="image" href="./assets/sunflower.svg">
<link rel="preload" as="image" href="./assets/Donguri.svg">
<link rel="preload" as="audio" href="./assets/BGM.mp3">
<link rel="preload" as="audio" href="./assets/END.mp3">
<link rel="preload" as="audio" href="./assets/pick.mp3">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>むるだっしゅ！</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  body { font-family:'Inter',sans-serif; touch-action:manipulation; overflow:hidden; overscroll-behavior:none; background:#1a202c; }
  canvas { display:block; }
  .control-button { transition: background-color .1s, transform .1s; }
  .control-button:active { transform: scale(.95); background:#2c5282; }
  .pause-button { transition: background-color .1s, transform .1s; }
  .pause-button:active { transform: scale(.95); }
  .icon-inline { display:inline-block; width:1.15em; height:1.15em; vertical-align:-0.18em; margin-left:.25em; }
  .no-select { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
  .no-highlight { -webkit-tap-highlight-color:transparent; }
</style>
</head>
<body class="bg-gray-800 flex flex-col items-center justify-start min-h-screen pt-3 sm:pt-4 pb-28">

<!-- 注記 -->
<div class="w-full text-center bg-gray-900 text-gray-300 text-[11px] py-1 shadow-md">
  ※本作品は <a href="https://kuronekotsuki.booth.pm/items/4672957" target="_blank" rel="noopener noreferrer" class="underline hover:text-white transition">｢ムルル｣</a> をモチーフにした非公式ファン作品です。<br class="sm:hidden">
  権利者様とは一切関係ありません。<br>
  ※音が出ます。ご注意ください。
</div>

<!-- ヘッダー -->
<div class="w-full max-w-[768px] p-3 bg-white rounded-t-lg shadow-md">
  <div class="flex items-center justify-between gap-3">
    <div class="text-left">
      <span class="text-xl sm:text-2xl font-bold text-blue-600">
        スコア: <span id="score" class="inline-block min-w-[60px] text-right font-mono">0</span>
      </span>
    </div>
    <div class="flex items-center gap-3 shrink-0">
      <span id="highScore" class="text-xs text-gray-500 block">ハイスコア: 0</span>
      <button id="pauseButton" class="pause-button px-3 py-2 sm:px-4 sm:py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">
        ちょっち休憩
      </button>
    </div>
  </div>
</div>

<!-- キャンバス -->
<div class="relative w-full max-w-[768px] mt-2">
  <canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>
  <div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center rounded-b-lg text-white p-8 text-center">
    <h2 class="text-5xl font-bold mb-6">むるだっしゅ！</h2>
    <p class="text-lg mb-4">ボタンでジャンプ！空中でもう一回で2段ジャンプ！</p>
    <p class="text-lg mb-8">障害物をよけまくろう！</p>
    <button id="startButton" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-2xl hover:bg-green-700 transition-colors">
      ゲームスタート
    </button>
  </div>
  <div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden flex-col justify-center items-center text-white p-8 text-center rounded-b-lg">
    <h2 class="text-4xl font-bold mb-4">一時停止中</h2>
    <p class="text-xl">(「ちょっち休憩」で再開)</p>
  </div>
  <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-50 hidden flex-col justify-center items-center text-white p-8 text-center rounded-b-lg">
    <h2 class="text-4xl font-bold mb-4">がめおべら</h2>
    <p class="text-xl mb-6">スコア: <span id="finalScore">0</span></p>
    <div class="flex flex-wrap justify-center gap-3">
      <button id="restartButton" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-xl hover:bg-blue-700 transition-colors">リスタート</button>
      <a id="shareButton" href="#" target="_blank" rel="noopener noreferrer" class="px-8 py-4 bg-black text-white font-bold rounded-lg shadow-lg text-xl hover:bg-gray-900 transition-colors">Xでスコアをシェア</a>
    </div>
  </div>
</div>

<!-- ジャンプボタン -->
<div class="w-full max-w-[768px] flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2 no-select no-highlight">
  <button id="jumpButton" class="control-button w-full py-12 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-2xl" draggable="false">
    ジャンプ
  </button>
</div>

<script>
/* ====== 基本セットアップ ====== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const startScreen = document.getElementById('startScreen');
const gameOverScreen = document.getElementById('gameOverScreen');
const finalScoreEl = document.getElementById('finalScore');
const shareButton = document.getElementById('shareButton');
const pauseButton = document.getElementById('pauseButton');
const pauseOverlay = document.getElementById('pauseOverlay');
const restartButton = document.getElementById('restartButton');
const jumpButton = document.getElementById('jumpButton');

function loadImg(src){ const img=new Image(); img.src=src; return img; }
const SPRITES={
  blueberry: loadImg('./assets/blueberry.svg'),
  sunflower: loadImg('./assets/sunflower.svg'),
  donguri:  loadImg('./assets/Donguri.svg')
};

/* ====== オーディオ ====== */
let bgmAudio,endAudio,pickupSound,audioStarted=false;
async function startAudio(){
  if(audioStarted) return;
  try{
    bgmAudio=new Audio('./assets/BGM.mp3'); bgmAudio.loop=true; bgmAudio.volume=0.5; await bgmAudio.play();
    endAudio=new Audio('./assets/END.mp3'); endAudio.volume=0.5;
    pickupSound=new Audio('./assets/pick.mp3'); pickupSound.volume=1.0; pickupSound.preload='auto';
    audioStarted=true;
  }catch(e){console.error(e);}
}

/* ====== 画面設定 ====== */
const gameWidth=Math.min(canvas.parentElement.clientWidth,768);
const gameHeight=300;
canvas.width=gameWidth; canvas.height=gameHeight;
const groundY=gameHeight-50;

/* ====== 地面 ====== */
const FLOOR_BASE={r:139,g:90,b:43};
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function rgbStr(r,g,b){return`rgb(${r|0},${g|0},${b|0})`;}
function rgbaStr(r,g,b,a){return`rgba(${r|0},${g|0},${b|0},${a})`;}
function drawGround(){ctx.fillStyle='#8B5A2B';ctx.fillRect(0,groundY,gameWidth,50);}

let groundGrains=[],groundPebbles=[],groundStreaks=[];
function initGroundDetails(){
  const gN=Math.floor(gameWidth*0.38),pN=Math.floor(gameWidth*0.08),sN=Math.floor(gameWidth*0.05);
  groundGrains=Array.from({length:gN},()=>({
    x:Math.random()*gameWidth,y:groundY+8+Math.random()*38,r:0.8+Math.random()*1.4,
    color:rgbStr(FLOOR_BASE.r+Math.random()*10,FLOOR_BASE.g+Math.random()*8,FLOOR_BASE.b+Math.random()*6)
  }));
  groundPebbles=Array.from({length:pN},()=>({
    x:Math.random()*gameWidth,y:groundY+10+Math.random()*36,w:2+Math.random()*3,h:1+Math.random()*2,
    color:rgbStr(FLOOR_BASE.r-6+Math.random()*12,FLOOR_BASE.g-6+Math.random()*12,FLOOR_BASE.b-6+Math.random()*12)
  }));
  groundStreaks=Array.from({length:sN},()=>({
    x:Math.random()*gameWidth,y:groundY+6+Math.random()*10,len:8+Math.random()*18,
    color:rgbaStr(FLOOR_BASE.r-8+Math.random()*8,FLOOR_BASE.g-8+Math.random()*8,FLOOR_BASE.b-8+Math.random()*8,0.55)
  }));
}
initGroundDetails();
function drawGroundDetails(df){
  const v=gameSpeed*df;
  for(const g of groundGrains){g.x-=v;if(g.x<-2){g.x=gameWidth+Math.random()*40;}ctx.fillStyle=g.color;ctx.beginPath();ctx.arc(g.x,g.y,g.r,0,Math.PI*2);ctx.fill();}
  for(const p of groundPebbles){p.x-=v;if(p.x<-3){p.x=gameWidth+Math.random()*60;}ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.w,p.h);}
  for(const s of groundStreaks){s.x-=v;if(s.x<-s.len){s.x=gameWidth+Math.random()*80;}ctx.strokeStyle=s.color;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+s.len,s.y);ctx.stroke();}
}

/* ====== ゲーム進行 ====== */
let gameSpeed=5,baseGameSpeed=5,gameSpeedAcceleration=0.05,timeElapsed=0,score=0,isPaused=false,isGameOver=false,gameStarted=false,lastTime=0,obstacles=[];

/* ====== どんぐり（5秒ごとに30％抽選） ====== */
class Acorn{
  constructor(type,x,y,size){this.type=type;this.x=x;this.y=y;this.size=size;this.t=Math.random()*Math.PI*2;}
  update(deltaMs){const fixedSpeed=0.5*baseGameSpeed;const df=deltaMs/(1000/60);this.x-=fixedSpeed*df;if(this.type==='air'){this.t+=0.05*df;this.y+=Math.sin(this.t)*0.2*df;}}
  draw(){const img=SPRITES.donguri;if(img&&img.complete){ctx.drawImage(img,this.x,this.y-this.size,this.size,this.size);}}
  getHitbox(){return{x:this.x-this.size*0.05,y:this.y-this.size*1.02,width:this.size*0.9,height:this.size*1.02};}
}
let acorns=[],acornSpawnTimer=0;
function randIntervalMs(){return 5000+Math.random()*2000;}
let nextAcornInterval=randIntervalMs();
function maybeSpawnAcorn(){if(Math.random()>=0.3)return;const x=gameWidth+20;const size=56+Math.floor(Math.random()*12);if(Math.random()<0.5){acorns.push(new Acorn('ground',x,groundY-6,size));}else{const y=groundY-160+Math.random()*100;acorns.push(new Acorn('air',x,y,size));}}
function spawnAcorn(deltaMs){acornSpawnTimer+=deltaMs;if(acornSpawnTimer<nextAcornInterval)return;acornSpawnTimer=0;nextAcornInterval=randIntervalMs();maybeSpawnAcorn();}
function updateAcorns(deltaMs){for(let i=acorns.length-1;i>=0;i--){acorns[i].update(deltaMs);acorns[i].draw();if(acorns[i].x<-50)acorns.splice(i,1);}}
function tryCollectAcorns(){const p={x:player.x,y:player.y,width:player.width*0.6,height:player.height*0.7};for(let i=acorns.length-1;i>=0;i--){const a=acorns[i],h=a.getHitbox();if(p.x<h.x+h.width&&p.x+p.width>h.x&&p.y<h.y+h.height&&p.y+p.height>h.y){score+=10;acorns.splice(i,1);if(pickupSound){pickupSound.currentTime=0;pickupSound.play();}}}}

/* ====== プレイヤー ====== */
const player={x:50,y:groundY-50,width:50,height:50,dy:0,gravity:0.8,jumpForce:15,isGrounded:true,jumpsRemaining:2,image:new Image(),imageLoaded:false};
player.image.src='./assets/Muru.png';
player.image.onload=()=>{player.imageLoaded=true;player.width=(player.image.width/player.image.height)*player.height;};
function drawPlayer(){if(player.imageLoaded)ctx.drawImage(player.image,player.x,player.y,player.width,player.height);else{ctx.fillStyle='green';ctx.fillRect(player.x,player.y,player.width,player.height);}}
function updatePlayer(d){if(!player.isGrounded){player.dy+=player.gravity*d;player.y+=player.dy*d;}if(player.y+player.height>=groundY){player.y=groundY-player.height;player.dy=0;player.isGrounded=true;player.jumpsRemaining=2;}}
function playerJump(){if(isGameOver||isPaused||!gameStarted)return;if(player.jumpsRemaining>0){player.dy=-player.jumpForce;player.isGrounded=false;player.jumpsRemaining--;}}
function stopJump(){if(player.dy<0)player.dy=Math.max(player.dy,-5);}

/* ====== メインループ ====== */
function gameLoop(ts){
  if(isGameOver||isPaused||!gameStarted)return;
  const dt=ts-lastTime;lastTime=ts;const df=dt/(1000/60);timeElapsed+=dt;
  ctx.clearRect(0,0,gameWidth,gameHeight);
  drawGround();drawGroundDetails(df);
  updatePlayer(df);drawPlayer();
  spawnAcorn(dt);updateAcorns(dt);tryCollectAcorns();
  scoreEl.textContent=score;
  requestAnimationFrame(gameLoop);
}

/* ====== 操作 ====== */
jumpButton.addEventListener('pointerdown',()=>playerJump());
jumpButton.addEventListener('pointerup',()=>stopJump());
pauseButton.addEventListener('click',()=>{isPaused=!isPaused;pauseOverlay.classList.toggle('hidden',!isPaused);if(!isPaused){lastTime=performance.now();requestAnimationFrame(gameLoop);}});
restartButton.addEventListener('click',()=>location.reload());
document.getElementById('startButton').addEventListener('click',()=>{
  startAudio();gameStarted=true;startScreen.classList.add('hidden');lastTime=performance.now();requestAnimationFrame(gameLoop);
});
</script>
</body>
</html>
