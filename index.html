<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; media-src 'self';">
<meta name="referrer" content="strict-origin-when-cross-origin">
<link rel="preload" as="image" href="./assets/blueberry.svg">
<link rel="preload" as="image" href="./assets/sunflower.svg">
<link rel="preload" as="image" href="./assets/Donguri.svg">
<link rel="preload" as="audio" href="./assets/BGM.mp3">
<link rel="preload" as="audio" href="./assets/END.mp3">
<link rel="preload" as="audio" href="./assets/pick.mp3">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>ã‚€ã‚‹ã ã£ã—ã‚…ï¼</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
  body { font-family:'Inter',sans-serif; touch-action:manipulation; overflow:hidden; overscroll-behavior:none; background:#1a202c; }
  canvas { display:block; }
  .control-button { transition: background-color .1s, transform .1s; }
  .control-button:active { transform: scale(.95); background:#2c5282; }
  .pause-button { transition: background-color .1s, transform .1s; }
  .pause-button:active { transform: scale(.95); }
  .icon-inline { display:inline-block; width:1.15em; height:1.15em; vertical-align:-0.18em; margin-left:.25em; }
  .no-select { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
  .no-highlight { -webkit-tap-highlight-color:transparent; }
</style>
</head>
<body class="bg-gray-800 flex flex-col items-center justify-start min-h-screen pt-3 sm:pt-4 pb-28">

<!-- æ³¨è¨˜ -->
<div class="w-full text-center bg-gray-900 text-gray-300 text-[11px] py-1 shadow-md">
  â€»æœ¬ä½œå“ã¯ <a href="https://kuronekotsuki.booth.pm/items/4672957" target="_blank" rel="noopener noreferrer" class="underline hover:text-white transition">ï½¢ãƒ ãƒ«ãƒ«ï½£</a> ã‚’ãƒ¢ãƒãƒ¼ãƒ•ã«ã—ãŸéå…¬å¼ãƒ•ã‚¡ãƒ³ä½œå“ã§ã™ã€‚<br class="sm:hidden">
  æ¨©åˆ©è€…æ§˜ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
  â€»éŸ³ãŒå‡ºã¾ã™ã€‚ã”æ³¨æ„ãã ã•ã„ã€‚
</div>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ768pxãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ -->
<div class="w-full max-w-[768px] p-3 bg-white rounded-t-lg shadow-md">
  <div class="flex items-center justify-between gap-3">
    <div class="text-left">
      <span class="text-xl sm:text-2xl font-bold text-blue-600">
        ã‚¹ã‚³ã‚¢: <span id="score" class="inline-block min-w-[60px] text-right font-mono">0</span>
      </span>
    </div>
    <div class="flex items-center gap-3 shrink-0">
      <span id="highScore" class="text-xs text-gray-500 block">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>
      <button id="pauseButton" class="pause-button px-3 py-2 sm:px-4 sm:py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">
        ã¡ã‚‡ã£ã¡ä¼‘æ†©
      </button>
    </div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="relative w-full max-w-[768px] mt-2">
  <canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆ -->
  <div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center flex">
    <h2 class="text-5xl font-bold mb-6">ã‚€ã‚‹ã ã£ã—ã‚…ï¼</h2>
    <p class="text-lg mb-4">ãƒœã‚¿ãƒ³ã§ã‚¸ãƒ£ãƒ³ãƒ—ï¼ç©ºä¸­ã§ã‚‚ã†ä¸€å›ã§2æ®µã‚¸ãƒ£ãƒ³ãƒ—ï¼</p>
    <p class="text-lg mb-8">éšœå®³ç‰©ã‚’ã‚ˆã‘ã¾ãã‚ã†ï¼</p>
    <button id="startButton" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-2xl hover:bg-green-700 transition-colors">
      ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
    </button>
  </div>

  <!-- ãƒãƒ¼ã‚º -->
  <div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center hidden">
    <h2 class="text-4xl font-bold mb-4">ä¸€æ™‚åœæ­¢ä¸­</h2>
    <p class="text-xl">(ã€Œã¡ã‚‡ã£ã¡ä¼‘æ†©ã€ãƒœã‚¿ãƒ³ã§å†é–‹)</p>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ -->
  <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-lg text-white p-8 text-center hidden">
    <h2 class="text-4xl font-bold mb-4">ãŒã‚ãŠã¹ã‚‰</h2>
    <p class="text-xl mb-6">ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
    <div class="flex flex-wrap justify-center gap-3">
      <button id="restartButton" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-xl hover:bg-blue-700 transition-colors">
        ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
      </button>
      <a id="shareButton" href="#" target="_blank" rel="noopener noreferrer" class="px-8 py-4 bg-black text-white font-bold rounded-lg shadow-lg text-xl hover:bg-gray-900 transition-colors">
        Xã§ã‚¹ã‚³ã‚¢ã‚’ã‚·ã‚§ã‚¢
      </a>
    </div>
  </div>
</div>

<!-- ãƒ«ãƒ¼ãƒ«ï¼ˆä¸­å¤®æƒãˆï¼‰ -->
<div class="w-full max-w-[768px] text-gray-200 text-sm mt-3 mb-20 px-1 leading-relaxed text-center">
  <p class="mb-1">
    ã²ã¾ã‚ã‚Š<img src="./assets/sunflower.svg" alt="sunflower" class="icon-inline">
    ã‚„ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼<img src="./assets/blueberry.svg" alt="blueberry" class="icon-inline">
    ã‚’<br class="sm:hidden"/>é¿ã‘ãªãŒã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ãã†ï¼
  </p>
  <p>
    ãŸã¾ã«è½ã¡ã¦ã‚‹ã©ã‚“ãã‚Š<img src="./assets/Donguri.svg" alt="donguri" class="icon-inline">
    ã¯æ‹¾ã„ãŸã„ã‚€ã‚‹ã­
  </p>
</div>

<!-- ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ -->
<div class="w-full max-w-[768px] flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2 no-select no-highlight">
  <button id="jumpButton" class="control-button w-full py-12 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-2xl no-select" draggable="false">
    ã‚¸ãƒ£ãƒ³ãƒ—
  </button>
</div>

<script>
/* ===== åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const highScoreEl = document.getElementById('highScore');
const gameOverScreen = document.getElementById('gameOverScreen');
const finalScoreEl = document.getElementById('finalScore');
const restartButton = document.getElementById('restartButton');
const shareButton = document.getElementById('shareButton');
const jumpButton = document.getElementById('jumpButton');
const pauseButton = document.getElementById('pauseButton');
const pauseOverlay = document.getElementById('pauseOverlay');
const startScreen = document.getElementById('startScreen');
const startButton = document.getElementById('startButton');

function loadImg(src){ const img=new Image(); img.src=src; return img; }
const SPRITES={
  blueberry: loadImg('./assets/blueberry.svg'),
  sunflower: loadImg('./assets/sunflower.svg'),
  donguri:  loadImg('./assets/Donguri.svg')
};

/* ===== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ===== */
let audioStarted=false, bgmAudio, endAudio, pickupSound;
async function startAudio(){
  if(audioStarted) return;
  try{
    bgmAudio = new Audio('./assets/BGM.mp3'); bgmAudio.volume = 0.5; bgmAudio.loop = true; await bgmAudio.play();
    endAudio = new Audio('./assets/END.mp3'); endAudio.volume=0.5;
    pickupSound = new Audio('./assets/pick.mp3'); pickupSound.volume = 1.0; pickupSound.preload='auto';
    audioStarted = true;
  }catch(e){ console.error(e); }
}

/* ===== ç”»é¢ã‚µã‚¤ã‚ºï¼ˆå¾“æ¥ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ ===== */
const parentWidth = canvas.parentElement.clientWidth;
const gameWidth  = Math.min(parentWidth, 768);
const gameHeight = 300;
canvas.width = gameWidth; canvas.height = gameHeight;

/* ===== ç©ºã®ãƒ†ãƒ¼ãƒï¼ˆæ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚°é€£å‹• / ãƒ•ã‚§ãƒ¼ãƒ‰ï¼‰ ===== */
const THEMES={ morning:{top:[160,210,235],bottom:[247,250,252]}, evening:{top:[246,173,85],bottom:[253,230,138]}, night:{top:[45,55,90],bottom:[20,25,50]} };
let skyCurrent={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
let skyTarget ={ top:[...THEMES.morning.top], bottom:[...THEMES.morning.bottom] };
const skyLerpSpeed=0.02;
let phaseName='morning';
function setBackgroundTheme(k){ const t=THEMES[k]||THEMES.morning; skyTarget={top:[...t.top],bottom:[...t.bottom]}; phaseName=k; }
function drawSky(df){
  const t=Math.min(1,skyLerpSpeed*df);
  for(let i=0;i<3;i++){ skyCurrent.top[i]+=(skyTarget.top[i]-skyCurrent.top[i])*t; skyCurrent.bottom[i]+=(skyTarget.bottom[i]-skyCurrent.bottom[i])*t; }
  const g=ctx.createLinearGradient(0,0,0,gameHeight);
  g.addColorStop(0,`rgb(${skyCurrent.top.map(x=>x|0).join(',')})`);
  g.addColorStop(0.8,`rgb(${skyCurrent.bottom.map(x=>x|0).join(',')})`);
  ctx.fillStyle=g; ctx.fillRect(0,0,gameWidth,gameHeight);
}

/* ===== æ›²ã‚¿ã‚¤ãƒŸãƒ³ã‚° ===== */
const EVENING_MARK_S=96, EPS=0.25;
let lastAudioTime=0, loopCount=0, eveningTriggered=false;
function resetAudioSyncState(){ lastAudioTime=0; loopCount=0; eveningTriggered=false; setBackgroundTheme('morning'); }
function updateSkyByMusic(){
  if(!bgmAudio) return;
  const t=bgmAudio.currentTime||0;
  if(!eveningTriggered && t>=EVENING_MARK_S-EPS){ setBackgroundTheme('evening'); eveningTriggered=true; }
  if(t+EPS<lastAudioTime){ loopCount++; eveningTriggered=false; setBackgroundTheme((loopCount%2===1)?'night':'morning'); }
  lastAudioTime=t;
}

/* ===== é›²ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰å¢—ï¼‹ã‚²ãƒ¼ãƒ é€Ÿåº¦é€£å‹•ï¼‰ ===== */
let clouds = Array.from({length:6},()=>({
  x: Math.random()*gameWidth,
  y: 30 + Math.random()*100,
  base: 0.35 + Math.random()*0.35,
  size: 70 + Math.random()*70
}));
function drawClouds(df){
  const isNight=(phaseName==='night');
  const alpha=isNight?0.30:0.42;
  ctx.fillStyle=`rgba(255,255,255,${alpha})`;
  const speedBoost = 1 + (gameSpeed / 10);
  for(const c of clouds){
    const v = c.base * speedBoost;
    c.x -= v * df;
    if(c.x < -220){ c.x = gameWidth + 120; c.y = 30 + Math.random()*100; }
    ctx.beginPath(); ctx.ellipse(c.x, c.y, c.size, c.size*0.55, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(c.x + c.size*0.6, c.y + 10, c.size*0.9, c.size*0.48, 0, 0, Math.PI*2); ctx.fill();
  }
}

/* ===== æ˜Ÿç©ºï¼ˆå¤œã ã‘ãƒ•ã‚§ãƒ¼ãƒ‰è¡¨ç¤ºï¼†ãŸã¾ã«æµã‚Œæ˜Ÿï¼‰ ===== */
const STAR_COUNT = Math.round(gameWidth * 0.35);
let stars = [];
let starAlpha = 0;
const STAR_LERP = 0.03;
let shooting = null;

function initStars(){
  stars = Array.from({length: STAR_COUNT}, () => ({
    x: Math.random()*gameWidth,
    y: Math.random()*(groundY - 40),
    r: Math.random()*1.6 + 0.4,
    tw: Math.random()*Math.PI*2,
    twSpeed: 0.015 + Math.random()*0.02,
    parallax: 0.05 + Math.random()*0.25
  }));
}
initStars();

function maybeSpawnShootingStar(){
  if (shooting || phaseName !== 'night') return;
  if (Math.random() < 0.004) {
    shooting = {
      x: Math.random() * (gameWidth * 0.6) + gameWidth * 0.2,
      y: 30 + Math.random() * (groundY * 0.35),
      vx: -(3 + Math.random()*2),
      vy:  1 + Math.random()*1.2,
      life: 60 + Math.random()*30,
      len: 40 + Math.random()*30,
    };
  }
}

function drawStars(df){
  const target = (phaseName === 'night') ? 1 : 0;
  starAlpha += (target - starAlpha) * (STAR_LERP * df);
  if (starAlpha <= 0.01) return;

  for (const s of stars) {
    s.x -= (gameSpeed * df) * s.parallax * 0.5;
    if (s.x < -3) { s.x = gameWidth + 3; s.y = Math.random()*(groundY - 40); }

    s.tw += s.twSpeed * df;
    const twinkle = 0.6 + 0.4 * Math.sin(s.tw);
    const a = Math.max(0, Math.min(1, starAlpha * twinkle));

    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
  }

  maybeSpawnShootingStar();

  if (shooting) {
    const a = 0.75 * starAlpha;
    const tailX = shooting.x + shooting.len * 0.8;
    const tailY = shooting.y - shooting.len * 0.4;
    ctx.fillStyle = `rgba(255,255,255,${a})`;
    ctx.beginPath(); ctx.arc(shooting.x, shooting.y, 1.6, 0, Math.PI*2); ctx.fill();
    const grad = ctx.createLinearGradient(shooting.x, shooting.y, tailX, tailY);
    grad.addColorStop(0, `rgba(255,255,255,${a})`);
    grad.addColorStop(1, `rgba(255,255,255,0)`);
    ctx.strokeStyle = grad;
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(shooting.x, shooting.y); ctx.lineTo(tailX, tailY); ctx.stroke();
    shooting.x += shooting.vx * df * (1 + gameSpeed*0.03);
    shooting.y += shooting.vy * df * (1 + gameSpeed*0.03);
    shooting.life -= df;
    if (shooting.life <= 0 || shooting.x < -60 || shooting.y > groundY - 10) shooting = null;
  }
}



  
/* ===== åœ°é¢ï¼ˆè‰²å‘³èª¿æ•´ï¼‹é€Ÿåº¦ä¸€è‡´ï¼‰ ===== */
const groundY = gameHeight - 50;
function drawGround(){ ctx.fillStyle='#8B5A2B'; ctx.fillRect(0,groundY,gameWidth,50); }

let groundGrains = [];   // ç´°ã‹ã„ç ‚
let groundPebbles = [];  // å°çŸ³
let groundStreaks = [];  // åœ°è¡¨ã®æ¨ªç·š

function initGroundDetails(){
  const grainsN  = Math.floor(gameWidth * 0.38);
  const pebblesN = Math.floor(gameWidth * 0.08);
  const streaksN = Math.floor(gameWidth * 0.05);

  // åºŠè‰²å¯„ã›ï¼ˆ#8B5A2B ä»˜è¿‘ï¼‰
  groundGrains = Array.from({length:grainsN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 8 + Math.random()*38,
    r: 0.8 + Math.random()*1.4,
    shadeR: 139 + Math.floor(Math.random()*8),   // 139ã€œ146
    shadeG: 90  + Math.floor(Math.random()*6),   // 90ã€œ95
    shadeB: 43  + Math.floor(Math.random()*6)    // 43ã€œ49
  }));
  groundPebbles = Array.from({length:pebblesN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 10 + Math.random()*36,
    w: 2 + Math.random()*3,
    h: 1 + Math.random()*2,
    shadeR: 133 + Math.floor(Math.random()*10),  // å°‘ã—æš—ã‚
    shadeG: 84  + Math.floor(Math.random()*10),
    shadeB: 40  + Math.floor(Math.random()*10)
  }));
  groundStreaks = Array.from({length:streaksN},()=>({
    x: Math.random()*gameWidth,
    y: groundY + 6 + Math.random()*10,
    len: 8 + Math.random()*18,
    shadeR: 130 + Math.floor(Math.random()*8),
    shadeG: 82  + Math.floor(Math.random()*8),
    shadeB: 38  + Math.floor(Math.random()*8)
  }));
}
initGroundDetails();

/* â˜… åœ°é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼éšœå®³ç‰©ï¼ˆ= gameSpeedï¼‰ã«å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ */
function drawGroundDetails(df){
  const v = gameSpeed * df; // â† çµ±ä¸€

  // ç ‚
  for(const g of groundGrains){
    g.x -= v;
    if(g.x < -2){ g.x = gameWidth + Math.random()*40; g.y = groundY + 8 + Math.random()*38; }
    ctx.fillStyle = `rgb(${g.shadeR}, ${g.shadeG}, ${g.shadeB})`;
    ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
  }

  // å°çŸ³
  for(const p of groundPebbles){
    p.x -= v;
    if(p.x < -3){ p.x = gameWidth + Math.random()*60; p.y = groundY + 10 + Math.random()*36; }
    ctx.fillStyle = `rgb(${p.shadeR}, ${p.shadeG}, ${p.shadeB})`;
    ctx.fillRect(p.x, p.y, p.w, p.h);
  }

  // ã‚¹ãƒˆãƒªãƒ¼ã‚¯
  for(const s of groundStreaks){
    s.x -= v;
    if(s.x < -s.len){ s.x = gameWidth + Math.random()*80; s.y = groundY + 6 + Math.random()*10; }
    ctx.strokeStyle = `rgba(${s.shadeR}, ${s.shadeG}, ${s.shadeB}, 0.55)`;
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x + s.len, s.y); ctx.stroke();
  }
}


/* ===== ã‚²ãƒ¼ãƒ æœ¬ä½“ ===== */
let score=0, highScore=parseInt(localStorage.getItem('muruHighScore')||'0',10); highScoreEl.textContent=`ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
let gameSpeed=5, baseGameSpeed=5, gameSpeedAcceleration=0.05;
const GAME_SPEED_MAX=13;

let timeElapsed=0, obstacles=[], frame=0, spawnTimer=0;
const minSpawnIntervalBase=105, maxSpawnIntervalBase=155, spawnIntervalReductionPerSec=4;
const EARLY_EASE_MS=15000, EARLY_EASE_START_MULT=1.15;
  
function currentOnscreenLimit(ms){
  if(ms < 45000)  return 2; // ã€œ45s
  if(ms < 120000) return 3; // 45sã€œ2åˆ†
  return 4;                 // 2åˆ†ã€œ
}


let isGameOver=false, isPaused=false, gameStarted=false, lastTime=0;
let isDebug=false, debugTapCount=0; const DEBUG_TAPS_TO_ENABLE=5;
let nextSpawnInterval=90;

/* === ã©ã‚“ãã‚Šï¼ˆSVG/é€Ÿåº¦å›ºå®š/5ç§’Â±1ç§’ã”ã¨ã«æŠ½é¸30%ï¼‰ === */
class Acorn{
  constructor(type,x,y,size){ this.type=type; this.x=x; this.y=y; this.size=size; this.t=Math.random()*Math.PI*2; }
  update(d){
    const fixedSpeed=0.5*baseGameSpeed; // å¸¸ã«ãƒ™ãƒ¼ã‚¹ã®åŠåˆ†ï¼ˆåŠ é€Ÿã—ãªã„ï¼‰
    this.x -= fixedSpeed * d;
    if(this.type==='air'){ this.t+=0.05*d; this.y += Math.sin(this.t)*0.2*d; }
  }
  draw(){
    const img=SPRITES.donguri; if(img && img.complete){ const w=this.size,h=this.size; ctx.drawImage(img,this.x,this.y-h,w,h); }
  }
  getHitbox(){
      return {
      x: this.x - this.size * 0.05,
      y: this.y - this.size * 1.02,
      width:  this.size * 0.9,
      height: this.size * 1.02
      };
  }

}
let acorns = [];

// â˜… ãƒŸãƒªç§’åŸºæº–ã‚¿ã‚¤ãƒï¼ˆç«¯æœ«å·®ãªã—ï¼‰
let acornSpawnTimerMs = 0;
function nextAcornIntervalMs(){ return 5000 + Math.random()*2000; } // 5ã€œ7ç§’ã«ä¸€åº¦ æŠ½é¸
let acornNextIntervalMs = nextAcornIntervalMs();

function maybeSpawnAcorn(){
  if(Math.random() >= 0.30) return; // 30%ã§å‡ºã™
  const x = gameWidth + 20;         // â˜… æœªå®šç¾©ãƒã‚°ä¿®æ­£
  const size = 56 + Math.floor(Math.random()*12); // ã¡ã‚‡ã„å¤§ãã‚
  if(Math.random()<0.5){
    const y=groundY-6; acorns.push(new Acorn('ground',x,y,size));
  }else{
    const minY=groundY-160, maxY=groundY-60; const y=Math.floor(minY+Math.random()*(maxY-minY));
    acorns.push(new Acorn('air',x,y,size));
  }
}
function spawnAcornMs(deltaMs){
  acornSpawnTimerMs += deltaMs;
  if(acornSpawnTimerMs < acornNextIntervalMs) return;
  acornSpawnTimerMs = 0;
  acornNextIntervalMs = nextAcornIntervalMs();
  maybeSpawnAcorn();
}

function updateAcorns(d){
  for(let i=acorns.length-1;i>=0;i--){ acorns[i].update(d); acorns[i].draw(); if(acorns[i].x<-50) acorns.splice(i,1); }
}
function tryCollectAcorns(){
  const p={x:player.x,y:player.y,width:player.width*0.6,height:player.height*0.7};
  for(let i=acorns.length-1;i>=0;i--){
    const a=acorns[i], h=a.getHitbox();
    if(p.x<h.x+h.width && p.x+p.width>h.x && p.y<h.y+h.height && p.y+p.height>h.y){
      score+=10; acorns.splice(i,1);
      if(pickupSound){ try{ pickupSound.currentTime=0; pickupSound.play(); }catch(_){ } }
    }
  }
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function clamp01(v){ return Math.max(0,Math.min(1,v)); }
function getEarlyEaseMultiplier(ms){ const t=clamp01(ms/EARLY_EASE_MS); return EARLY_EASE_START_MULT + (1.0-EARLY_EASE_START_MULT)*t; }
function getMinPixelGap(ms){ const t=clamp01(ms/EARLY_EASE_MS); const s=Math.round(gameWidth*0.42), e=Math.round(gameWidth*0.32); return Math.round(s+(e-s)*t); }
function enableDebugMode(){ if(isDebug) return; isDebug=true; const b=document.createElement('span'); b.id='debugBadge'; b.textContent='DEBUG'; b.className='px-2 py-1 bg-pink-600 text-white text-xs font-bold rounded shadow-sm ml-1'; highScoreEl.parentElement.appendChild(b); }
function resetDebugTapCounter(){ debugTapCount=0; }

/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ===== */
const player={x:50,y:groundY-50,width:50,height:50,dy:0,gravity:0.8,jumpForce:15,isGrounded:true,jumpsRemaining:2,isJumping:false,image:new Image(),imageLoaded:false};
player.image.src='./assets/Muru.png';
player.image.onload=()=>{ player.imageLoaded=true; player.width=(player.image.width/player.image.height)*player.height; };

function drawPlayer(){ if(player.imageLoaded) ctx.drawImage(player.image,player.x,player.y,player.width,player.height); else{ ctx.fillStyle='green'; ctx.fillRect(player.x,player.y,player.width,player.height);} }
function updatePlayer(d){ if(!player.isGrounded){ player.dy+=player.gravity*d; player.y+=player.dy*d; } if(player.y+player.height>=groundY){ player.y=groundY-player.height; player.dy=0; player.isGrounded=true; player.jumpsRemaining=2; } }
function playerJump(){ startAudio(); if(isGameOver||isPaused||!gameStarted) return; if(player.jumpsRemaining>0){ player.dy=-player.jumpForce; player.isGrounded=false; player.isJumping=true; player.jumpsRemaining--; } }
function stopJump(){ if(player.isJumping && player.dy<0){ player.dy=Math.max(player.dy,-5); } player.isJumping=false; }

/* ===== éšœå®³ç‰©ï¼ˆå…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ç¶­æŒï¼‰ ===== */
class Obstacle{
  constructor(type,img,y,size){
    this.x=gameWidth; this.y=y; this.type=type; this.img=img; this.height=size;
    const iw=img.naturalWidth||1, ih=img.naturalHeight||1, aspect=iw/ih;
    this.width=this.height*aspect; this.passed=false;
  }
  draw(){ ctx.drawImage(this.img,this.x,this.y-this.height,this.width,this.height); }
  update(d){ this.x -= gameSpeed*d; }
  getHitbox(){ const shrink=this.type==='ground_large'?0.65:0.8; const w=this.width*shrink, h=this.height*shrink; return { x:this.x+(this.width-w)/2, y:(this.y-this.height)+(this.height-h)/2, width:w, height:h }; }
}
const SCALE=0.7;
function spawnObstacle(delta){
  spawnTimer += delta;
  let minSpawnInterval = Math.max(minSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec, 40);
  let maxSpawnInterval = Math.max(maxSpawnIntervalBase - (timeElapsed/1000)*spawnIntervalReductionPerSec, 70);
  const easeMul = getEarlyEaseMultiplier(timeElapsed); minSpawnInterval*=easeMul; maxSpawnInterval*=easeMul;
  
  function lateDensityMul(ms){
  if(ms < 60000) return 1.0;   // ã€œ60s
  if(ms < 120000) return 0.85; // 1ã€œ2åˆ†
  return 0.72;                 // 2åˆ†ã€œ
  }
  const ld = lateDensityMul(timeElapsed);
  minSpawnInterval *= ld;
  maxSpawnInterval *= ld;
  
  if(spawnTimer < nextSpawnInterval) return;
  const onscreen = obstacles.filter(o => (o.x + o.width > 0) && (o.x < gameWidth)).length;
  const limit = currentOnscreenLimit(timeElapsed); if(onscreen >= limit) return;
  const last = obstacles.length ? obstacles[obstacles.length-1] : null;
  const minGapPx = getMinPixelGap(timeElapsed);
  if(last){ const gapPx = gameWidth - (last.x + last.width); if(gapPx < minGapPx) return; }
  const rand = Math.random();
  if(rand < 0.4){
    const size = (40 + Math.random()*20) * SCALE;
    const yPos = Math.random() < 0.3 ? groundY - 30 : groundY - 70 - Math.random()*50;
    obstacles.push(new Obstacle('air', SPRITES.blueberry, yPos, size));
  }else{
    if(score > 10 && Math.random() < 0.3) obstacles.push(new Obstacle('ground_large', SPRITES.sunflower, groundY, 120*SCALE*1.25));
    else obstacles.push(new Obstacle('ground', SPRITES.sunflower, groundY, (60 + Math.random()*20) * SCALE));
  }
  nextSpawnInterval = minSpawnInterval + Math.random()*(maxSpawnInterval - minSpawnInterval);
  spawnTimer=0;
}
function updateObstacles(d){
  for(let i=obstacles.length-1;i>=0;i--){ obstacles[i].update(d); obstacles[i].draw(); if(obstacles[i].x + obstacles[i].width < 0) obstacles.splice(i,1); }
}

/* ===== å½“ãŸã‚Šåˆ¤å®š / ã‚¹ã‚³ã‚¢ / é€Ÿåº¦ ===== */
function checkCollision(){
  if(isDebug) return;
  const p={x:player.x,y:player.y,width:player.width*0.6,height:player.height*0.7};
  for(const o of obstacles){ const h=o.getHitbox(); if(p.x<h.x+h.width && p.x+p.width>h.x && p.y<h.y+h.height && p.y+p.height>h.y){ gameOver(); return; } }
}
function updateScore(){
  for(const o of obstacles){ if(!o.passed && o.x+o.width < player.x){ score++; o.passed=true; } }
  tryCollectAcorns();
  scoreEl.textContent=score;
  const tSec=timeElapsed/1000;
  gameSpeed=Math.min(baseGameSpeed + tSec*gameSpeedAcceleration, GAME_SPEED_MAX);
}

/* ===== çµ‚äº†å‡¦ç†ãªã© ===== */
function buildXIntentUrl(score){ const text=`ã‚€ã‚‹ã ã£ã—ã‚…ï¼ã‚¹ã‚³ã‚¢ã¯ã€Œ${score}ã€ã§ã—ãŸğŸŒ»\nhttps://t4l-ovo-t4l.github.io/murudash/`; return `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`; }
function gameOver(){
  if(isGameOver) return;
  isGameOver=true; gameStarted=false;
  if(audioStarted){ try{ bgmAudio.pause(); bgmAudio.currentTime=0; endAudio.currentTime=0; endAudio.play(); }catch(_){} }
  if(score>highScore){ highScore=score; localStorage.setItem('muruHighScore',highScore); highScoreEl.textContent=`ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`; }
  finalScoreEl.textContent=score; shareButton.href=buildXIntentUrl(score);
  gameOverScreen.classList.remove('hidden'); gameOverScreen.classList.add('flex');
}
function restartGame(){
  startAudio(); try{ if(bgmAudio){ bgmAudio.currentTime=0; bgmAudio.play(); } }catch(_){}
  score=0; initStars(); scoreEl.textContent=score; timeElapsed=0; gameSpeed=baseGameSpeed;
  obstacles=[]; acorns=[]; frame=0; spawnTimer=0;
  // â˜… ã©ã‚“ãã‚ŠæŠ½é¸ã‚¿ã‚¤ãƒåˆæœŸåŒ–ï¼ˆç«¯æœ«å·®ãªã—ï¼‰
  acornSpawnTimerMs = 0; acornNextIntervalMs = nextAcornIntervalMs();

  isGameOver=false; isPaused=false; gameStarted=true;
  player.y=groundY-player.height; player.dy=0; player.isGrounded=true; player.jumpsRemaining=2;
  gameOverScreen.classList.add('hidden'); gameOverScreen.classList.remove('flex'); pauseOverlay.classList.add('hidden');
  resetAudioSyncState(); isDebug=false; resetDebugTapCounter(); const dbg=document.getElementById('debugBadge'); if(dbg) dbg.remove();
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  lastTime=performance.now(); requestAnimationFrame(gameLoop);
}
function togglePause(){
  if(isGameOver||!gameStarted) return;
  isPaused=!isPaused;
  if(isPaused){ try{ if(bgmAudio)bgmAudio.pause(); }catch(_){}; pauseOverlay.classList.remove('hidden'); pauseOverlay.classList.add('flex'); resetDebugTapCounter(); }
  else{ try{ if(bgmAudio)bgmAudio.play(); }catch(_){}; pauseOverlay.classList.add('hidden'); pauseOverlay.classList.remove('flex'); lastTime=performance.now(); requestAnimationFrame(gameLoop); resetDebugTapCounter(); }
}

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function gameLoop(ts){
  if(isGameOver||isPaused||!gameStarted) return;
  const dt=ts-lastTime; lastTime=ts; const df=dt/(1000/60); timeElapsed+=dt;

  updateSkyByMusic();

  // èƒŒæ™¯ï¼†é›²
  ctx.clearRect(0,0,gameWidth,gameHeight);
  drawSky(df); drawStars(df); drawClouds(df);

  // åœ°é¢ï¼‹æµã‚Œã‚‹ç ‚åˆ©ï¼ˆéšœå®³ç‰©ã¨åŒé€Ÿã§æµã™ï¼‰
  drawGround(); drawGroundDetails(df);

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼éšœå®³ç‰©ï¼ã©ã‚“ãã‚Š
  updatePlayer(df); drawPlayer();
  spawnObstacle(df); updateObstacles(df);
  spawnAcornMs(dt); updateAcorns(df);

  checkCollision(); updateScore();

  frame++; requestAnimationFrame(gameLoop);
}

/* ===== å…¥åŠ› ===== */
window.addEventListener('keydown', e=>{
  if(e.repeat) return;
  if(isPaused && (e.code==='Space'||e.code==='ArrowUp')){ debugTapCount++; if(debugTapCount>=DEBUG_TAPS_TO_ENABLE){ enableDebugMode(); resetDebugTapCounter(); } return; }
  if(!gameStarted) return;
  if(e.code==='Space'||e.code==='ArrowUp') playerJump();
  if(e.code==='KeyP') togglePause();
});
window.addEventListener('keyup', e=>{ if(e.code==='Space'||e.code==='ArrowUp') stopJump(); });
jumpButton.addEventListener('pointerdown', e=>{ e.preventDefault(); if(isPaused){ debugTapCount++; if(debugTapCount>=DEBUG_TAPS_TO_ENABLE){ enableDebugMode(); resetDebugTapCounter(); } return; } playerJump(); });
jumpButton.addEventListener('pointerup',   e=>{ e.preventDefault(); stopJump(); });
pauseButton.addEventListener('click', e=>{ e.preventDefault(); togglePause(); });
pauseButton.addEventListener('touchstart', e=>{ e.preventDefault(); togglePause(); });

restartButton.addEventListener('click', e=>{ e.preventDefault(); restartGame(); });
restartButton.addEventListener('touchstart', e=>{ e.preventDefault(); restartGame(); });

function handleGameStart(e){
  e.preventDefault();
  if(gameStarted) return;
  gameStarted=true; startAudio(); startScreen.classList.add('hidden');
  resetAudioSyncState(); isDebug=false; resetDebugTapCounter(); const dbg=document.getElementById('debugBadge'); if(dbg) dbg.remove();
  lastTime=performance.now(); requestAnimationFrame(gameLoop);
  nextSpawnInterval = minSpawnIntervalBase + Math.random()*(maxSpawnIntervalBase - minSpawnIntervalBase);
  spawnTimer=0;
}
startButton.addEventListener('click', handleGameStart);
startButton.addEventListener('touchstart', handleGameStart);
</script>
</body>
</html>
