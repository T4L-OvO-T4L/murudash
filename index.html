<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>むるだっしゅ！</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{font-family:'Inter',sans-serif;touch-action:manipulation;overflow:hidden;background:#1a202c;}
canvas{display:block}
.control-button{transition:.1s}
.control-button:active{transform:scale(.95);background:#2c5282}
.pause-button:active{transform:scale(.95)}
</style>
</head>
<body class="bg-gray-800 flex flex-col items-center justify-start min-h-screen pt-3 pb-28">
<div class="w-full text-center bg-gray-900 text-gray-300 text-[11px] py-1 shadow-md">
※音が出ます。ご注意ください。
</div>

<div class="w-full max-w-[768px] p-3 bg-white rounded-t-lg shadow-md flex justify-between items-center">
<span class="text-xl font-bold text-blue-600">スコア:<span id="score" class="inline-block min-w-[60px] text-right font-mono">0</span></span>
<div class="flex gap-3 items-center">
<span id="highScore" class="text-xs text-gray-500">ハイスコア:0</span>
<button id="pauseButton" class="pause-button px-3 py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">ちょっち休憩</button>
</div>
</div>

<div class="relative w-full max-w-[768px] mt-2">
<canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>

<div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center text-white p-8 rounded-b-lg">
<h2 class="text-5xl font-bold mb-6">むるだっしゅ！</h2>
<p class="text-lg mb-4">ボタンでジャンプ！空中でもう一回で2段ジャンプ！</p>
<button id="startButton" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-2xl hover:bg-green-700">スタート</button>
</div>

<div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 hidden flex-col justify-center items-center text-white p-8 rounded-b-lg">
<h2 class="text-4xl font-bold mb-4">一時停止中</h2>
<p class="text-xl">(「ちょっち休憩」で再開)</p>
</div>

<div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-50 hidden flex-col justify-center items-center text-white p-8 rounded-b-lg">
<h2 class="text-4xl font-bold mb-4">がめおべら</h2>
<p class="text-xl mb-6">スコア:<span id="finalScore">0</span></p>
<button id="restartButton" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-xl hover:bg-blue-700">リスタート</button>
</div>
</div>

<div class="w-full max-w-[768px] flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2">
<button id="jumpButton" class="control-button w-full py-12 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-2xl">ジャンプ</button>
</div>

<script>
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const scoreEl=document.getElementById('score');
const highScoreEl=document.getElementById('highScore');
const startScreen=document.getElementById('startScreen');
const pauseOverlay=document.getElementById('pauseOverlay');
const gameOverScreen=document.getElementById('gameOverScreen');
const finalScoreEl=document.getElementById('finalScore');
const jumpButton=document.getElementById('jumpButton');
const startButton=document.getElementById('startButton');
const pauseButton=document.getElementById('pauseButton');
const restartButton=document.getElementById('restartButton');

function loadImg(s){const i=new Image();i.src=s;return i;}
const SPRITES={
  blueberry:loadImg('./assets/blueberry.svg'),
  sunflower:loadImg('./assets/sunflower.svg'),
  donguri:loadImg('./assets/Donguri.svg'),
  muru:loadImg('./assets/Muru.png')
};

/* 音 */
let bgmAudio,endAudio,pickupSound,audioStarted=false;
async function startAudio(){
 if(audioStarted)return;
 bgmAudio=new Audio('./assets/BGM.mp3');bgmAudio.loop=true;bgmAudio.volume=0.5;
 endAudio=new Audio('./assets/END.mp3');pickupSound=new Audio('./assets/pick.mp3');
 pickupSound.volume=1.0;pickupSound.preload='auto';
 try{await bgmAudio.play();}catch(e){console.log(e)}
 audioStarted=true;
}

/* 画面設定 */
const gameWidth=Math.min(canvas.parentElement.clientWidth,768);
const gameHeight=300;canvas.width=gameWidth;canvas.height=gameHeight;
const groundY=gameHeight-50;

/* ===== 空（朝→夕→夜→朝） ===== */
const THEMES={
  morning:{top:[160,210,235],bottom:[247,250,252]},
  evening:{top:[246,173,85],bottom:[253,230,138]},
  night:{top:[60,80,120],bottom:[28,35,70]}
};
let skyCurrent={top:[...THEMES.morning.top],bottom:[...THEMES.morning.bottom]};
let skyTarget={top:[...THEMES.morning.top],bottom:[...THEMES.morning.bottom]};
let phaseName='morning';
const skyLerpSpeed=0.02;
function setBackgroundTheme(k){const t=THEMES[k]||THEMES.morning;skyTarget={top:[...t.top],bottom:[...t.bottom]};phaseName=k;}
function drawSky(df){
 const t=Math.min(1,skyLerpSpeed*df);
 for(let i=0;i<3;i++){
   skyCurrent.top[i]+=(skyTarget.top[i]-skyCurrent.top[i])*t;
   skyCurrent.bottom[i]+=(skyTarget.bottom[i]-skyCurrent.bottom[i])*t;
 }
 const g=ctx.createLinearGradient(0,0,0,gameHeight);
 g.addColorStop(0,`rgb(${skyCurrent.top.map(x=>x|0).join(',')})`);
 g.addColorStop(1,`rgb(${skyCurrent.bottom.map(x=>x|0).join(',')})`);
 ctx.fillStyle=g;ctx.fillRect(0,0,gameWidth,gameHeight);
}
const EVENING_MARK_S=96,EPS=0.25;let lastAudioTime=0,loopCount=0,eveningTriggered=false;
function resetAudioSyncState(){lastAudioTime=0;loopCount=0;eveningTriggered=false;setBackgroundTheme('morning');}
function updateSkyByMusic(){
 if(!bgmAudio)return;
 const t=bgmAudio.currentTime||0;
 if(!eveningTriggered&&t>=EVENING_MARK_S-EPS){setBackgroundTheme('evening');eveningTriggered=true;}
 if(t+EPS<lastAudioTime){loopCount++;eveningTriggered=false;setBackgroundTheme(loopCount%2===1?'night':'morning');}
 lastAudioTime=t;
}

/* 雲 */
let clouds=Array.from({length:6},()=>({x:Math.random()*gameWidth,y:30+Math.random()*100,base:0.35+Math.random()*0.35,size:70+Math.random()*70}));
function drawClouds(df){
 const alpha=(phaseName==='night')?0.3:0.42;
 ctx.fillStyle=`rgba(255,255,255,${alpha})`;
 const speedBoost=1+(gameSpeed/10);
 for(const c of clouds){
  const v=c.base*speedBoost;
  c.x-=v*df;if(c.x<-220){c.x=gameWidth+120;c.y=30+Math.random()*100;}
  ctx.beginPath();ctx.ellipse(c.x,c.y,c.size,c.size*0.55,0,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.ellipse(c.x+c.size*0.6,c.y+10,c.size*0.9,c.size*0.48,0,0,Math.PI*2);ctx.fill();
 }
}

/* 地面 */
const FLOOR_BASE={r:139,g:90,b:43};
function rgb(r,g,b){return`rgb(${r|0},${g|0},${b|0})`}
function drawGround(){ctx.fillStyle='#8B5A2B';ctx.fillRect(0,groundY,gameWidth,50);}
let groundGrains=[],groundPebbles=[],groundStreaks=[];
function initGroundDetails(){
const gN=Math.floor(gameWidth*0.38),pN=Math.floor(gameWidth*0.08),sN=Math.floor(gameWidth*0.05);
groundGrains=Array.from({length:gN},()=>({x:Math.random()*gameWidth,y:groundY+8+Math.random()*38,r:0.8+Math.random()*1.4,color:rgb(FLOOR_BASE.r+Math.random()*8,FLOOR_BASE.g+Math.random()*6,FLOOR_BASE.b+Math.random()*6)}));
groundPebbles=Array.from({length:pN},()=>({x:Math.random()*gameWidth,y:groundY+10+Math.random()*36,w:2+Math.random()*3,h:1+Math.random()*2,color:rgb(FLOOR_BASE.r-6+Math.random()*10,FLOOR_BASE.g-6+Math.random()*10,FLOOR_BASE.b-6+Math.random()*10)}));
groundStreaks=Array.from({length:sN},()=>({x:Math.random()*gameWidth,y:groundY+6+Math.random()*10,len:8+Math.random()*18,color:`rgba(${FLOOR_BASE.r-8+Math.random()*8},${FLOOR_BASE.g-8+Math.random()*8},${FLOOR_BASE.b-8+Math.random()*8},0.55)`}));
}
initGroundDetails();
function drawGroundDetails(df){
 const v=gameSpeed*df;
 for(const g of groundGrains){g.x-=v;if(g.x<-2)g.x=gameWidth+Math.random()*40;ctx.fillStyle=g.color;ctx.beginPath();ctx.arc(g.x,g.y,g.r,0,Math.PI*2);ctx.fill();}
 for(const p of groundPebbles){p.x-=v;if(p.x<-3)p.x=gameWidth+Math.random()*60;ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.w,p.h);}
 for(const s of groundStreaks){s.x-=v;if(s.x<-s.len)s.x=gameWidth+Math.random()*80;ctx.strokeStyle=s.color;ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(s.x+s.len,s.y);ctx.stroke();}
}

/* プレイヤー */
const player={x:50,y:groundY-50,width:50,height:50,dy:0,gravity:0.8,jumpForce:15,isGrounded:true,jumpsRemaining:2};
function drawPlayer(){ctx.drawImage(SPRITES.muru,player.x,player.y,player.width,player.height);}
function updatePlayer(df){if(!player.isGrounded){player.dy+=player.gravity*df;player.y+=player.dy*df;}if(player.y+player.height>=groundY){player.y=groundY-player.height;player.dy=0;player.isGrounded=true;player.jumpsRemaining=2;}}
function playerJump(){if(player.jumpsRemaining>0){player.dy=-player.jumpForce;player.isGrounded=false;player.jumpsRemaining--;}}
function stopJump(){if(player.dy<0)player.dy=Math.max(player.dy,-5);}

/* 障害物 */
class Obstacle{constructor(img,y,size){this.x=gameWidth;this.y=y;this.img=img;this.height=size;const a=(img.naturalWidth||1)/(img.naturalHeight||1);this.width=this.height*a;this.passed=false;}
draw(){ctx.drawImage(this.img,this.x,this.y-this.height,this.width,this.height);}
update(df){this.x-=gameSpeed*df;}}
let obstacles=[],spawnTimer=0,nextSpawnInterval=100;
function spawnObstacle(df){
 spawnTimer+=df;
 if(spawnTimer<nextSpawnInterval)return;
 spawnTimer=0;nextSpawnInterval=90+Math.random()*80;
 const img=Math.random()<0.5?SPRITES.blueberry:SPRITES.sunflower;
 const size=50+Math.random()*40;
 obstacles.push(new Obstacle(img,groundY,size));
}
function updateObstacles(df){
 for(let i=obstacles.length-1;i>=0;i--){obstacles[i].update(df);obstacles[i].draw();if(obstacles[i].x<-obstacles[i].width)obstacles.splice(i,1);}
}

/* どんぐり */
class Acorn{constructor(type,x,y,size){this.type=type;this.x=x;this.y=y;this.size=size;this.t=Math.random()*Math.PI*2;}
update(dt){const df=dt/(1000/60);this.x-=2*df;if(this.type==='air'){this.t+=0.05*df;this.y+=Math.sin(this.t)*0.2*df;}}
draw(){ctx.drawImage(SPRITES.donguri,this.x,this.y-this.size,this.size,this.size);}
getHitbox(){return{x:this.x,y:this.y-this.size,width:this.size,height:this.size};}}
let acorns=[],acornSpawnTimer=0,nextAcornInterval=5000+Math.random()*2000;
function maybeSpawnAcorn(){if(Math.random()<0.3){const x=gameWidth+20;const size=56+Math.random()*12;if(Math.random()<0.5){acorns.push(new Acorn('ground',x,groundY-6,size));}else{const y=groundY-160+Math.random()*100;acorns.push(new Acorn('air',x,y,size));}}}
function spawnAcorn(dt){acornSpawnTimer+=dt;if(acornSpawnTimer<nextAcornInterval)return;acornSpawnTimer=0;nextAcornInterval=5000+Math.random()*2000;maybeSpawnAcorn();}
function updateAcorns(dt){for(let i=acorns.length-1;i>=0;i--){acorns[i].update(dt);acorns[i].draw();if(acorns[i].x<-50)acorns.splice(i,1);}}

/* メインループ */
let gameSpeed=5,score=0,isPaused=false,isGameOver=false,gameStarted=false,lastTime=0;
function gameLoop(ts){
 if(isGameOver||isPaused||!gameStarted)return;
 const dt=ts-lastTime;lastTime=ts;const df=dt/(1000/60);
 updateSkyByMusic();drawSky(df);drawClouds(df);
 drawGround();drawGroundDetails(df);
 updatePlayer(df);drawPlayer();
 spawnObstacle(df);updateObstacles(df);
 spawnAcorn(dt);updateAcorns(dt);
 scoreEl.textContent=++score;
 requestAnimationFrame(gameLoop);
}

/* 操作 */
jumpButton.addEventListener('pointerdown',()=>playerJump());
jumpButton.addEventListener('pointerup',()=>stopJump());
pauseButton.addEventListener('click',()=>{isPaused=!isPaused;pauseOverlay.classList.toggle('hidden',!isPaused);if(!isPaused){lastTime=performance.now();requestAnimationFrame(gameLoop);}});
restartButton.addEventListener('click',()=>location.reload());
startButton.addEventListener('click',()=>{startAudio();resetAudioSyncState();gameStarted=true;startScreen.classList.add('hidden');lastTime=performance.now();requestAnimationFrame(gameLoop);});
</script>
</body>
</html>
