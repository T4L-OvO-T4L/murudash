<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚€ã‚‹ã ã£ã—ã‚…ï¼</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js (BGMã¨åŠ¹æœéŸ³ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
            overscroll-behavior: none; /* ç«¯ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£é–ã‚’é˜²æ­¢ */
        }
        canvas {
            background-color: #f7fafc; /* Tailwindã®gray-100 */
            display: block;
            /* èƒŒæ™¯ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç©ºï¼‰ */
            background-image: linear-gradient(to bottom, #a0d2eb, #f7fafc 80%);
        }
        /* ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼/ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¼·åŒ– */
        .control-button {
            transition: background-color 0.1s ease, transform 0.1s ease;
        }
        .control-button:active {
            transform: scale(0.95);
            background-color: #2c5282; /* Tailwindã®blue-700 */
        }
        /* ãƒãƒ¼ã‚ºãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pause-button {
            transition: background-color 0.1s ease, transform 0.1s ease;
        }
        .pause-button:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-200 flex flex-col items-center justify-center h-screen">

    <!-- ã‚²ãƒ¼ãƒ æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ --><div class="w-full max-w-lg p-4 flex justify-between items-center bg-white rounded-t-lg shadow-md">
        <div>
            <h1 class="text-xl font-bold text-gray-800">ã‚€ã‚‹ã ã£ã—ã‚…ï¼</h1>
            <p class="text-sm text-gray-600">2æ®µã‚¸ãƒ£ãƒ³ãƒ—ã§ã‚ˆã‘ã‚ˆã†ï¼</p>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span class="text-2xl font-bold text-blue-600">ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
                <span id="highScore" class="text-xs text-gray-500 block">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>
            </div>
             <!-- ãƒãƒ¼ã‚ºãƒœã‚¿ãƒ³ -->
            <button id="pauseButton" class="pause-button px-4 py-2 bg-yellow-500 text-white font-bold rounded-lg shadow-md text-sm">
                ã¡ã‚‡ã£ã¨ä¼‘æ†©
            </button>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚³ãƒ³ãƒ†ãƒŠ (ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨) -->
    <div class="relative w-full max-w-lg">
        <!-- ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ --><canvas id="gameCanvas" class="rounded-b-lg shadow-md"></canvas>
        
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ (è¿½åŠ ) -->
        <div id="startScreen" class="absolute inset-0 bg-black bg-opacity-70 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center flex">
            <h2 class="text-5xl font-bold mb-6">ã‚€ã‚‹ã ã£ã—ã‚…ï¼</h2>
            <p class="text-lg mb-4">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¸ãƒ£ãƒ³ãƒ—ï¼<br>ç©ºä¸­ã§ ã‚‚ã£ã‹ã„æŠ¼ã—ã¦2æ®µã‚¸ãƒ£ãƒ³ãƒ—ï¼</p>
            <p class="text-lg mb-8">éšœå®³ç‰©ã‚’ã‚ˆã‘ã¾ãã‚ã†ï¼</p>
            <!-- <p class="text-base mb-6 font-bold text-yellow-300">â€»ãƒã‚¤ã‚¹ã‚³ã‚¢ã¯ä¿å­˜ã•ã‚Œãªã„ã‹ã‚‰<br>ã‚¹ã‚¯ã‚·ãƒ§æ’®ã£ã¦ãŠã„ã¦ã­ï¼</p> (å‰Šé™¤) -->
            <button id="startButton" class="px-8 py-4 bg-green-600 text-white font-bold rounded-lg shadow-lg text-2xl hover:bg-green-700 transition-colors">
                ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>

        <!-- ãƒãƒ¼ã‚ºä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (éè¡¨ç¤º) -->
        <div id="pauseOverlay" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-b-lg text-white p-8 text-center hidden">
            <h2 class="text-4xl font-bold mb-4">ä¸€æ™‚åœæ­¢ä¸­</h2>
            <p class="text-xl">(ã€Œã¡ã‚‡ã£ã¨ä¼‘æ†©ã€ãƒœã‚¿ãƒ³ã§å†é–‹)</p>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼è¡¨ç¤º (éè¡¨ç¤º) -->
        <div id="gameOverScreen" class="absolute inset-0 bg-black bg-opacity-50 flex-col justify-center items-center rounded-lg text-white p-8 text-center hidden">
            <h2 class="text-4xl font-bold mb-4">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
            <p class="text-xl mb-6">ã‚¹ã‚³ã‚¢: <span id="finalScore">0</span></p>
            <button id="restartButton" class="px-8 py-4 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-xl hover:bg-blue-700 transition-colors">
                ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>
    </div>


    <!-- ã‚¹ãƒãƒ›ç”¨æ“ä½œãƒœã‚¿ãƒ³ (ã‚¸ãƒ£ãƒ³ãƒ—ã®ã¿) --><div class="w-full max-w-lg flex justify-center p-4 fixed bottom-0 left-1/2 -translate-x-1/2">
        <button id="jumpButton" class="control-button w-3/4 py-8 bg-blue-600 text-white font-bold rounded-lg shadow-lg text-2xl">
            ã‚¸ãƒ£ãƒ³ãƒ—
        </button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const highScoreEl = document.getElementById('highScore');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreEl = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const jumpButton = document.getElementById('jumpButton');
        const pauseButton = document.getElementById('pauseButton');
        const pauseOverlay = document.getElementById('pauseOverlay');
        const startScreen = document.getElementById('startScreen'); // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
        const startButton = document.getElementById('startButton'); // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³


        // --- Audio Setup ---
        let audioStarted = false;
        let bgmSynth, bgmPattern, jumpSfx, doubleJumpSfx, gameOverSfx;

        async function startAudio() {
            if (audioStarted) return;
            try {
                await Tone.start();
                
                // BGM: PluckSynthã§ã‚¢ãƒ«ãƒšã‚¸ã‚ªé¢¨ã«
                bgmSynth = new Tone.PluckSynth({
                    attackNoise: 0.5,
                    dampening: 4000,
                    resonance: 0.7
                }).toDestination();
                bgmSynth.volume.value = -4; // BGMéŸ³é‡ã‚¢ãƒƒãƒ— (-8 -> -4)

                // ã‚¸ãƒ£ãƒ³ãƒ—SE: MembraneSynth (å¤ªé¼“é¢¨)
                jumpSfx = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 10,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
                }).toDestination();
                jumpSfx.volume.value = -10;

                // 2æ®µã‚¸ãƒ£ãƒ³ãƒ—SE (ã‚¸ãƒ£ãƒ³ãƒ—SEã¨åŒã˜ã‚·ãƒ³ã‚»ã§éŸ³ç¨‹ã‚’å¤‰ãˆã‚‹)
                doubleJumpSfx = new Tone.MembraneSynth({
                    pitchDecay: 0.01,
                    octaves: 10,
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.7 }
                }).toDestination();
                doubleJumpSfx.volume.value = -8;


                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼SE: éŸ³æ¥½çš„ãªå’ŒéŸ³ (å¤‰æ›´å‰)
                /*
                const gameOverSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "triangle8" }, // å°‘ã—æŸ”ã‚‰ã‹ã„éŸ³
                    envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 1.0 },
                    volume: -8 // éŸ³é‡ã‚’BGMã¨åŒã˜ãã‚‰ã„ã«
                }).toDestination();
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§éŸ³ã‚’ã“ã‚‚ã‚‰ã›ã€æ‚²ã—ã„æ„Ÿã˜ã«
                const gameOverFilter = new Tone.AutoFilter("2n").toDestination().start();
                gameOverFilter.baseFrequency = 300;
                gameOverFilter.octaves = 3;
                gameOverSynth.connect(gameOverFilter);
                */

                // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼SE: æ˜ã‚‹ã„ã€Œã¡ã‚ƒã‚“ã¡ã‚ƒã‚“â™ªã€é¢¨ (å¤‰æ›´å¾Œ)
                const gameOverPluck = new Tone.PluckSynth({
                    attackNoise: 0.2,
                    dampening: 4000,
                    resonance: 0.7,
                    volume: -6 // BGMã‚ˆã‚Šå°‘ã—å¤§ãã
                }).toDestination();


                // 2ã¤ã®éŸ³ã‚’åŒæ™‚ã«ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹é–¢æ•°ã¨ã—ã¦ gameOverSfx ã‚’å®šç¾©
                gameOverSfx = () => {
                    const now = Tone.now();
                    // æš—ã„æ„Ÿã˜ã®ãƒã‚¤ãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰ (å¤‰æ›´å‰)
                    // gameOverSynth.triggerAttackRelease(["C3", "Eb3", "G3", "Bb3"], "1.5n", now);
                    
                    // æ˜ã‚‹ã„ã€Œã¡ã‚ƒã‚“ã¡ã‚ƒã‚“â™ªã€ (G4 -> C5)
                    gameOverPluck.triggerAttack("G4", now);
                    // â˜…â˜…â˜… ã‚¨ãƒ©ãƒ¼ä¿®æ­£: è¡Œé ­ã® 'G' ã‚’å‰Šé™¤ â˜…â˜…â˜…
                    gameOverPluck.triggerAttack("C5", now + 0.15); // 0.15ç§’é…ã‚Œã¦é«˜ã„éŸ³
                };

                // BGMãƒ‘ã‚¿ãƒ¼ãƒ³ (ã‚ˆã‚Šãƒªãƒƒãƒã«)
                bgmPattern = new Tone.Sequence((time, note) => {
                    bgmSynth.triggerAttack(note, time);
                }, ["C4", ["E4", "G4"], "G4", "E4", "C4", ["D4", "F4"], "F4", "D4"], "8n");
                
                bgmPattern.start(0);
                Tone.Transport.bpm.value = 140; // å°‘ã—ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—
                Tone.Transport.start();
                
                audioStarted = true;
                console.log("Audio context started.");
            } catch (e) {
                console.error("Audio could not start: ", e);
            }
        }
        // --- End Audio Setup ---

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚º
        const parentWidth = canvas.parentElement.clientWidth;
        const gameWidth = Math.min(parentWidth, 768); 
        const gameHeight = 300;
        canvas.width = gameWidth;
        canvas.height = gameHeight;
        
        console.log(`Canvas initialized: ${gameWidth}x${gameHeight}`); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

        // ã‚²ãƒ¼ãƒ å¤‰æ•°
        let score = 0;
        let highScore = localStorage.getItem('muruHighScore') || 0; // (ä¿å­˜æ©Ÿèƒ½ å¾©æ´»)
        let gameSpeed = 5;
        let baseGameSpeed = 5;
        // let gameSpeedMultiplier = 0.0008; (ã‚¹ã‚³ã‚¢åŸºæº–ã‹ã‚‰æ™‚é–“åŸºæº–ã«å¤‰æ›´)
        let gameSpeedAcceleration = 0.05; // 1ç§’ã‚ãŸã‚Šã«å¢—ãˆã‚‹é€Ÿåº¦
        let timeElapsed = 0; // çµŒéæ™‚é–“ (ãƒŸãƒªç§’)

        let obstacles = [];
        let backgroundObjects = []; // æµã‚Œã‚‹èƒŒæ™¯ç”¨
        let groundObjects = []; // æµã‚Œã‚‹åœ°é¢ç”¨
        let frame = 0;
        let spawnTimer = 0;
        let minSpawnInterval = 90; // é›£æ˜“åº¦ã‚¢ãƒƒãƒ— (100 -> 90)
        let maxSpawnInterval = 180; // é›£æ˜“åº¦ã‚¢ãƒƒãƒ— (200 -> 180)
        let minSpawnIntervalBase = 90;
        let maxSpawnIntervalBase = 180;
        // let spawnIntervalReductionRate = 0.7; (ã‚¹ã‚³ã‚¢åŸºæº–ã‹ã‚‰æ™‚é–“åŸºæº–ã«å¤‰æ›´)
        let spawnIntervalReductionPerSec = 4; // 1ç§’ã‚ãŸã‚Šã«çŸ­ç¸®ã•ã‚Œã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ æ•°
        let nextSpawnInterval = minSpawnInterval;
        let isGameOver = false;
        let isPaused = false; // ãƒãƒ¼ã‚ºçŠ¶æ…‹
        let gameStarted = false; // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ç”¨

        // --- ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ (FPSå›ºå®šåŒ–)ç”¨ ---
        let lastTime = 0;
        const baseDeltaTime = 1000 / 60; // 60FPSã‚’åŸºæº–
        // ---

        highScoreEl.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;

        // åœ°é¢ã®Yåº§æ¨™
        const groundY = gameHeight - 50;

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š
        const player = {
            x: 50,
            y: groundY - 50, // Yåº§æ¨™ã‚’ (åœ°é¢ - é«˜ã•) ã§åˆæœŸåŒ–
            width: 50,
            height: 50,
            originalHeight: 50,
            dy: 0,
            gravity: 0.8,
            jumpForce: 15,
            isGrounded: true,
            jumpsRemaining: 2, // 2æ®µã‚¸ãƒ£ãƒ³ãƒ—ç”¨
            isJumping: false, // å¯å¤‰ã‚¸ãƒ£ãƒ³ãƒ—ç”¨
            image: new Image(),
            imageLoaded: false
        };
        
        console.log("Player object initialized:", player); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°


        // ä¸»äººå…¬ç”»åƒã®èª­ã¿è¾¼ã¿
        player.image.src = 'https://corsproxy.io/?https://drive.google.com/uc?id=1-BD0XjJD5OiQWy1t2vtnsglN1OPKL2N4';
        player.image.onload = () => {
            player.imageLoaded = true;
            player.width = (player.image.width / player.image.height) * player.height;
        };
        player.image.onerror = () => {
            console.error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            player.imageLoaded = false;
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¯ãƒ©ã‚¹ã®æç”»
        function drawPlayer() {
            const drawHeight = player.height;
            const drawY = player.y; // updatePlayerã§è¨ˆç®—ã•ã‚ŒãŸplayer.yã‚’ãã®ã¾ã¾ä½¿ã†
            
            if (player.imageLoaded) {
                ctx.drawImage(player.image, player.x, drawY, player.width, drawHeight);
            } else {
                ctx.fillStyle = 'green';
                ctx.fillRect(player.x, drawY, player.width, drawHeight);
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ›´æ–° (ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ)
        function updatePlayer(deltaFactor) {
            // é‡åŠ›
            if (!player.isGrounded) {
                player.dy += player.gravity * deltaFactor;
                player.y += player.dy * deltaFactor;
            }
            
            // åœ°é¢ã«ç€åœ°
            if (player.y + player.height >= groundY) { // >= ã§åˆ¤å®š
                player.y = groundY - player.height; // Yåº§æ¨™ã‚’ (åœ°é¢ - é«˜ã•) ã«ã‚¹ãƒŠãƒƒãƒ—
                player.dy = 0;
                player.isGrounded = true;
                player.jumpsRemaining = 2; // ã‚¸ãƒ£ãƒ³ãƒ—å›æ•°ãƒªã‚»ãƒƒãƒˆ
            }
            
            player.height = player.originalHeight;
        }

        // ã‚¸ãƒ£ãƒ³ãƒ—é–‹å§‹å‡¦ç†
        function playerJump() {
            startAudio(); 
            
            // ãƒãƒ¼ã‚ºä¸­ã¾ãŸã¯ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ã‚¸ãƒ£ãƒ³ãƒ—ã§ããªã„
            if (isGameOver || isPaused || !gameStarted) return;

            if (player.jumpsRemaining > 0) {
                player.dy = -player.jumpForce;
                player.isGrounded = false;
                player.isJumping = true; 
                
                if (player.jumpsRemaining === 1) { // 2æ®µã‚¸ãƒ£ãƒ³ãƒ—
                    if (audioStarted) doubleJumpSfx.triggerAttackRelease("G4", "8n");
                } else { // 1æ®µã‚¸ãƒ£ãƒ³ãƒ—
                    if (audioStarted) jumpSfx.triggerAttackRelease("C3", "8n");
                }
                
                player.jumpsRemaining--;
            }
        }

        // ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã‚’é›¢ã—ãŸæ™‚ã®å‡¦ç† (å¯å¤‰ã‚¸ãƒ£ãƒ³ãƒ—ç”¨)
        function stopJump() {
            if (player.isJumping && player.dy < 0) {
                player.dy = Math.max(player.dy, -5); 
            }
            player.isJumping = false;
        }

        // --- æµã‚Œã‚‹èƒŒæ™¯ ---
        class BackgroundObject {
            constructor(emoji, y, fontSize, speedMultiplier) {
                this.x = gameWidth;
                this.y = y;
                this.emoji = emoji;
                this.fontSize = fontSize;
                this.speedMultiplier = speedMultiplier;
            }
            draw() {
                ctx.font = `${this.fontSize}px Arial`;
                ctx.globalAlpha = 0.5; // åŠé€æ˜ã«ã™ã‚‹
                ctx.fillText(this.emoji, this.x, this.y);
                ctx.globalAlpha = 1.0; // é€æ˜åº¦ã‚’æˆ»ã™
            }
            update(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
                this.x -= gameSpeed * this.speedMultiplier * deltaFactor;
            }
        }

        function spawnBackgroundObject() {
            if (Math.random() < 0.01) {
                const y = Math.random() * (gameHeight / 2); // ç”»é¢ã®ä¸ŠåŠåˆ†
                const fontSize = 20 + Math.random() * 30;
                const speedMultiplier = 0.2 + Math.random() * 0.3; // é€Ÿåº¦ã‚’é…ã
                backgroundObjects.push(new BackgroundObject('â˜ï¸', y, fontSize, speedMultiplier));
            }
        }

        function updateBackgroundObjects(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
            for (let i = backgroundObjects.length - 1; i >= 0; i--) {
                backgroundObjects[i].update(deltaFactor);
                backgroundObjects[i].draw();
                if (backgroundObjects[i].x < -50) { // ç”»é¢å¤–
                    backgroundObjects.splice(i, 1);
                }
            }
        }
        // --- æµã‚Œã‚‹èƒŒæ™¯ ã“ã“ã¾ã§ ---

        // --- æµã‚Œã‚‹åœ°é¢ ---
        class GroundObject {
            constructor(text, y, fontSize, color) {
                this.x = gameWidth;
                this.y = y;
                this.text = text;
                this.fontSize = fontSize;
                this.color = color;
            }
            draw() {
                ctx.font = `${this.fontSize}px Arial`;
                ctx.fillStyle = this.color;
                ctx.fillText(this.text, this.x, this.y);
            }
            update(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
                this.x -= gameSpeed * deltaFactor; // èƒŒæ™¯ã¨é•ã„ã€ãƒ•ãƒ«ã‚¹ãƒ”ãƒ¼ãƒ‰ã§ç§»å‹•
            }
        }

        function spawnGroundObject() {
            // ä¸€å®šç¢ºç‡ã§å°çŸ³ã‚„ã˜ã‚ƒã‚Šã‚’ç”Ÿæˆ
            if (Math.random() < 0.05) {
                const y = groundY + 10 + Math.random() * 30; // åœ°é¢ã®ä¸­
                const fontSize = 5 + Math.random() * 5;
                const color = Math.random() < 0.5 ? '#A0522D' : '#696969'; // ã‚·ã‚¨ãƒŠ or ã‚°ãƒ¬ã‚¤
                const text = Math.random() < 0.5 ? 'â€¢' : 'Â·';
                groundObjects.push(new GroundObject(text, y, fontSize, color));
            }
        }

        function updateGroundObjects(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
            for (let i = groundObjects.length - 1; i >= 0; i--) {
                groundObjects[i].update(deltaFactor);
                groundObjects[i].draw();
                if (groundObjects[i].x < -10) { // ç”»é¢å¤–
                    groundObjects.splice(i, 1);
                }
            }
        }
        // --- æµã‚Œã‚‹åœ°é¢ ã“ã“ã¾ã§ ---


        // éšœå®³ç‰©ã‚¯ãƒ©ã‚¹
        class Obstacle {
            constructor(type, emoji, y, fontSize) {
                this.x = gameWidth;
                this.y = y;
                this.type = type; // 'ground', 'air', 'ground_large'
                this.emoji = emoji;
                this.fontSize = fontSize;
                this.width = fontSize * 0.8; 
                this.height = fontSize * 0.8;
                this.passed = false;
            }
            draw() {
                ctx.font = `${this.fontSize}px Arial`;
                ctx.fillText(this.emoji, this.x, this.y);
            }
            update(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
                this.x -= gameSpeed * deltaFactor;
            }
            getHitbox() {
                return {
                    x: this.x,
                    y: this.y - this.height, 
                    width: this.width,
                    height: this.height
                };
            }
        }

        function spawnObstacle(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
            spawnTimer += deltaFactor; // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ ã§ã‚¿ã‚¤ãƒãƒ¼ã‚’åŠ ç®—
            if (spawnTimer < nextSpawnInterval) {
                return;
            }

            spawnTimer = 0;
            nextSpawnInterval = Math.floor(Math.random() * (maxSpawnInterval - minSpawnInterval) + minSpawnInterval);
            
            const rand = Math.random();
            
            // 40%ã§ç©ºä¸­ (ãƒ–ãƒ«ãƒ¼ãƒ™ãƒªãƒ¼)
            if (rand < 0.4) {
                const fontSize = 30 + Math.random() * 10;
                let yPos;
                // ç©ºä¸­éšœå®³ç‰©ã®ã†ã¡ã€30%ã¯ä½ç©º
                if (Math.random() < 0.3) {
                    yPos = groundY - 30; // ä½ç©º (å°ã‚¸ãƒ£ãƒ³ãƒ—ã§è¶Šãˆã‚‰ã‚Œã‚‹)
                } else {
                    yPos = groundY - 70 - Math.random() * 50; // é€šå¸¸ã®ç©ºä¸­
                }
                obstacles.push(new Obstacle('air', 'ğŸ«', yPos, fontSize));
            } 
            // 60%ã§åœ°ä¸Š (ã²ã¾ã‚ã‚Š) - (å‡ºç¾ç‡ã‚¢ãƒƒãƒ—)
            else {
                // åœ°ä¸Šéšœå®³ç‰©ã®ã†ã¡ã€ã‚¹ã‚³ã‚¢10ä»¥ä¸Šãªã‚‰30%ã§å¤§ããªã²ã¾ã‚ã‚Š
                if (score > 10 && Math.random() < 0.3) {
                    const fontSize = 110; // ã‚µã‚¤ã‚ºã‚¢ãƒƒãƒ—
                    obstacles.push(new Obstacle('ground_large', 'ğŸŒ»', groundY, fontSize));
                } else {
                    // é€šå¸¸ã®ã²ã¾ã‚ã‚Š
                    const fontSize = 40 + Math.random() * 10;
                    obstacles.push(new Obstacle('ground', 'ğŸŒ»', groundY, fontSize));
                }
            }
        }

        function updateObstacles(deltaFactor) { // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ
            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].update(deltaFactor);
                obstacles[i].draw();
                if (obstacles[i].x + obstacles[i].width < 0) {
                    obstacles.splice(i, 1);
                }
            }
        }

        function checkCollision() {
            const playerHitbox = {
                x: player.x,
                y: player.y, // player.yã‚’ãã®ã¾ã¾ä½¿ã†
                width: player.width * 0.8, 
                height: player.height * 0.8
            };

            for (const obstacle of obstacles) {
                const obsHitbox = obstacle.getHitbox();
                if (
                    playerHitbox.x < obsHitbox.x + obsHitbox.width &&
                    playerHitbox.x + playerHitbox.width > obsHitbox.x &&
                    playerHitbox.y < obsHitbox.y + obsHitbox.height &&
                    playerHitbox.y + playerHitbox.height > obsHitbox.y
                ) {
                    gameOver();
                    return;
                }
            }
        }

        function updateScore() {
            for (const obstacle of obstacles) {
                if (!obstacle.passed && obstacle.x + obstacle.width < player.x) {
                    score++;
                    obstacle.passed = true;
                }
            }
            scoreEl.textContent = score;
            
            // --- æ™‚é–“çµŒéã§é›£æ˜“åº¦ã‚’æ›´æ–° ---
            const timeInSeconds = timeElapsed / 1000;
            
            // 1. é€Ÿåº¦ã‚’æ™‚é–“ã§åŠ é€Ÿ
            gameSpeed = baseGameSpeed + timeInSeconds * gameSpeedAcceleration;
            
            // 2. ã‚¹ãƒãƒ¼ãƒ³é–“éš”ã‚’æ™‚é–“ã§çŸ­ç¸®
            minSpawnInterval = Math.max(minSpawnIntervalBase - timeInSeconds * spawnIntervalReductionPerSec, 40); // æœ€ä½40ãƒ•ãƒ¬ãƒ¼ãƒ 
            maxSpawnInterval = Math.max(maxSpawnIntervalBase - timeInSeconds * spawnIntervalReductionPerSec, 80); // æœ€ä½80ãƒ•ãƒ¬ãƒ¼ãƒ 
        }

        function drawGround() {
            ctx.fillStyle = '#8B4513'; // èŒ¶è‰² (SaddleBrown)
            ctx.fillRect(0, groundY, gameWidth, gameHeight - groundY);
        }

        function clearCanvas() {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹å…¨ä½“ã‚’ã‚¯ãƒªã‚¢ (èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯CSSã§æç”»ã•ã‚Œã‚‹)
            ctx.clearRect(0, 0, gameWidth, gameHeight);
        }

        function gameOver() {
            // â˜…â˜…â˜… ä¿®æ­£: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ãŒä½•åº¦ã‚‚å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‚’é˜²ã
            if (isGameOver) return;

            isGameOver = true;
            gameStarted = false; // ã‚²ãƒ¼ãƒ çµ‚äº†
            if (audioStarted) {
                // gameOverSfx.triggerAttackRelease("1n"); // ãƒã‚¤ã‚º (å¤‰æ›´å‰)
                gameOverSfx(); // çˆ†ç™ºéŸ³ (å¤‰æ›´å¾Œ)
                Tone.Transport.stop();
                // â˜…â˜…â˜… ä¿®æ­£: Transportã‚’æ­¢ã‚ã‚Œã°Patternã‚‚æ­¢ã¾ã‚‹ãŸã‚ã€ã“ã®è¡Œã¯ä¸è¦ (ã‚¨ãƒ©ãƒ¼ã®åŸå› )
                // bgmPattern.stop(); 
            }

AN:            if (score > highScore) {
                highScore = score;
                localStorage.setItem('muruHighScore', highScore); // (ä¿å­˜æ©Ÿèƒ½ å¾©æ´»)
                highScoreEl.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
            }
            finalScoreEl.textContent = score;
            gameOverScreen.classList.remove('hidden');
            gameOverScreen.classList.add('flex');
        }

        function restartGame() {
            startAudio(); 
            if (audioStarted) {
                Tone.Transport.start();
                bgmPattern.start(0);
            }
            
            score = 0;
            scoreEl.textContent = score; // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            timeElapsed = 0; // çµŒéæ™‚é–“ãƒªã‚»ãƒƒãƒˆ
            gameSpeed = baseGameSpeed; 
            minSpawnInterval = minSpawnIntervalBase; 
            maxSpawnInterval = maxSpawnIntervalBase; 
            obstacles = [];
            backgroundObjects = []; // èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ
            groundObjects = []; // åœ°é¢ãƒªã‚»ãƒƒãƒˆ
            frame = 0;
            spawnTimer = 0;
            isGameOver = false;
            isPaused = false; // ãƒãƒ¼ã‚ºè§£é™¤
            gameStarted = true; // ã‚²ãƒ¼ãƒ é–‹å§‹
            player.y = groundY - player.height; // Yåº§æ¨™ã‚’ (åœ°é¢ - é«˜ã•) ã§ãƒªã‚»ãƒƒãƒˆ
            player.dy = 0;
            player.isGrounded = true;
            player.jumpsRemaining = 2; // ã‚¸ãƒ£ãƒ³ãƒ—å›æ•°ãƒªã‚»ãƒƒãƒˆ
            
            gameOverScreen.classList.add('hidden');
            gameOverScreen.classList.remove('flex');
            pauseOverlay.classList.add('hidden'); // ãƒãƒ¼ã‚ºç”»é¢ã‚‚éš ã™
            
            // ãƒ«ãƒ¼ãƒ—ã‚’å†é–‹
            lastTime = performance.now(); // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ ãƒªã‚»ãƒƒãƒˆ
            requestAnimationFrame(gameLoop);
        }
        
        // --- ãƒãƒ¼ã‚ºæ©Ÿèƒ½ ---
        function togglePause() {
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ã€ã¾ãŸã¯ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ãƒãƒ¼ã‚ºã§ããªã„
            if (isGameOver || !gameStarted) return;
            
            isPaused = !isPaused;
            
            if (isPaused) {
                // ãƒãƒ¼ã‚º
                if (audioStarted) {
                    Tone.Transport.pause();
                }
                pauseOverlay.classList.remove('hidden');
                pauseOverlay.classList.add('flex');
            } else {
                // å†é–‹
                if (audioStarted) {
                    Tone.Transport.start();
                }
                pauseOverlay.classList.add('hidden');
                pauseOverlay.classList.remove('flex');
                
                // ãƒ«ãƒ¼ãƒ—ã‚’å†é–‹
                lastTime = performance.now(); // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ ãƒªã‚»ãƒƒãƒˆ
                requestAnimationFrame(gameLoop);
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— (ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ å¯¾å¿œ)
        function gameLoop(timestamp) {
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒãƒ¼ã‚ºä¸­ãªã‚‰ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢
            if (isGameOver || isPaused || !gameStarted) {
                return;
            }

            // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ è¨ˆç®—
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            const deltaFactor = deltaTime / baseDeltaTime;

            // çµŒéæ™‚é–“ã‚’åŠ ç®—
            timeElapsed += deltaTime;

            // ãƒ‡ãƒ«ã‚¿ã‚¿ã‚¤ãƒ ãŒæ¥µç«¯ã«å¤§ãã„å ´åˆï¼ˆã‚¿ãƒ–ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã ã£ãŸå ´åˆãªã©ï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (deltaFactor > 4) {
                requestAnimationFrame(gameLoop);
                return;
            }


            clearCanvas();
            
            // èƒŒæ™¯ã‚’æç”» (åœ°é¢ã‚ˆã‚Šå¥¥)
            spawnBackgroundObject();
            updateBackgroundObjects(deltaFactor);
            
            // åœ°é¢ã‚’æç”»
            drawGround();
            
            // åœ°é¢ã®å°çŸ³ã‚’æç”»
            spawnGroundObject();
            updateGroundObjects(deltaFactor);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            updatePlayer(deltaFactor);
            drawPlayer();

            // éšœå®³ç‰©
            spawnObstacle(deltaFactor);
            updateObstacles(deltaFactor);

            // å½“ãŸã‚Šåˆ¤å®šã¨ã‚¹ã‚³ã‚¢
            checkCollision();
            updateScore();

            frame++;
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¦æ±‚
            requestAnimationFrame(gameLoop);
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        // PCç”¨ (ãƒ‡ãƒãƒƒã‚°)
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return; // ã‚­ãƒ¼æŠ¼ã—ã£ã±ãªã—ã«ã‚ˆã‚‹é€£æ‰“é˜²æ­¢
            
            if (!gameStarted) return; // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ã‚­ãƒ¼ã‚’å—ã‘ä»˜ã‘ãªã„

            if (e.code === 'Space' || e.code === 'ArrowUp') {
                playerJump();
            }
            // Pã‚­ãƒ¼ã§ãƒãƒ¼ã‚º (ãƒ‡ãƒãƒƒã‚°ç”¨)
            if (e.code === 'KeyP') {
                togglePause();
            }
        });
        window.addEventListener('keyup', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                stopJump(); // ã‚­ãƒ¼ã‚’é›¢ã—ãŸã‚‰ã‚¸ãƒ£ãƒ³ãƒ—ã‚’æ­¢ã‚ã‚‹ (å¯å¤‰ã‚¸ãƒ£ãƒ³ãƒ—)
            }
        });

        // ã‚¹ãƒãƒ›ç”¨ (ã‚¿ãƒƒãƒ)
        if (jumpButton) {
            jumpButton.addEventListener('pointerdown', (e) => {
                e.preventDefault(); 
                playerJump();
            });
            jumpButton.addEventListener('pointerup', (e) => {
                e.preventDefault();
                stopJump(); // æŒ‡ã‚’é›¢ã—ãŸã‚‰ã‚¸ãƒ£ãƒ³ãƒ—ã‚’æ­¢ã‚ã‚‹ (å¯å¤‰ã‚¸ãƒ£ãƒ³ãƒ—)
            });
        } else {
            console.error("Jump button not found!");
        }
        
        // ãƒãƒ¼ã‚ºãƒœã‚¿ãƒ³
        if (pauseButton) {
            pauseButton.addEventListener('click', (e) => {
                e.preventDefault();
                togglePause();
            });
            pauseButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                togglePause();
            });
        }


        // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        restartButton.addEventListener('click', restartGame);
        restartButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            restartGame();
        });

        // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
        function handleGameStart(e) {
            e.preventDefault();
            
            if (gameStarted) return; // æ—¢ã«é–‹å§‹ã—ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„

            console.log("Game Start!");
            gameStarted = true;
            
            startAudio(); // éŸ³æ¥½å†ç”Ÿé–‹å§‹
            startScreen.classList.add('hidden'); // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’éš ã™
            
            // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        startButton.addEventListener('click', handleGameStart);
        startButton.addEventListener('touchstart', handleGameStart);

        // ã‚²ãƒ¼ãƒ é–‹å§‹ (å‰Šé™¤)
        // gameLoop();
    </script>
</body>
</html>


